<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºç³–å°åŠ©æ‰‹ - ç™»å½•</title>
    <script src="libs/tailwindcss.js"></script>
    <script src="libs/fontawesome.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#969FFF',
                        secondary: '#5147FF', 
                        accent: '#3E3987',
                        success: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444'
                    },
                    backgroundImage: {
                        'gradient-primary': 'linear-gradient(135deg, #969FFF 0%, #5147FF 100%)',
                        'gradient-secondary': 'linear-gradient(135deg, #5147FF 0%, #3E3987 100%)',
                        'gradient-card': 'linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%)',
                        'gradient-hero': 'linear-gradient(135deg, #969FFF 0%, #5147FF 50%, #3E3987 100%)'
                    },
                    boxShadow: {
                        'card': '0 4px 20px rgba(150, 159, 255, 0.1)',
                        'button': '0 4px 15px rgba(150, 159, 255, 0.3)',
                        'nav': '0 -2px 20px rgba(150, 159, 255, 0.1)'
                    }
                }
            }
        }
    </script>
    <style>
        .safe-top {
            padding-top: env(safe-area-inset-top);
        }
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #969FFF 0%, #5147FF 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .form-input-focus:focus {
            outline: none;
            border-color: #969FFF;
            box-shadow: 0 0 0 2px rgba(150, 159, 255, 0.2);
        }
        
        .button-hover:active {
            transform: scale(0.98);
            transition: transform 0.1s ease;
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
    </style>
    <script src="config.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">


    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div id="main-content" class="min-h-screen flex flex-col">
        <!-- é¡¶éƒ¨LogoåŒºåŸŸ -->
        <header id="logo-header" class="flex-1 flex flex-col justify-center items-center px-6 py-12">
            <!-- App Logo -->
            <div id="app-logo" class="text-center mb-12">
                <div class="w-24 h-24 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-card overflow-hidden bg-white">
                    <!-- ä½¿ç”¨å®é™…çš„logoå›¾ç‰‡ -->
                    <img src="/logo.png" 
                         alt="æ™ºç³–å°åŠ©æ‰‹ Logo" 
                         class="w-full h-full object-contain">
                </div>
                <h1 id="app-name" class="text-3xl font-bold gradient-text mb-2">æ™ºç³–å°åŠ©æ‰‹</h1>
                <p id="app-slogan" class="text-gray-600 text-sm">æ‚¨çš„æ™ºèƒ½ç³–å°¿ç—…ç®¡ç†ä¼™ä¼´</p>
            </div>

            <!-- ç™»å½•è¡¨å• -->
            <div id="login-form-container" class="w-full max-w-sm">
                <form id="login-form" class="space-y-6">
                    <!-- è´¦å·è¾“å…¥æ¡† -->
                    <div id="username-field" class="space-y-2">
                        <label for="username" class="block text-sm font-medium text-gray-700">æ‰‹æœºå·</label>
                        <div class="relative">
                            <input type="text" 
                                   id="username" 
                                   name="username" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl form-input-focus bg-white text-gray-800 placeholder-gray-500" 
                                   placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
                                   required>
                            <div class="absolute right-3 top-1/2 transform -translate-y-1/2">
                                <i class="fas fa-user text-gray-400"></i>
                            </div>
                        </div>
                    </div>

                    <!-- å¯†ç è¾“å…¥æ¡† -->
                    <div id="password-field" class="space-y-2">
                        <label for="password" class="block text-sm font-medium text-gray-700">å¯†ç </label>
                        <div class="relative">
                            <input type="password" 
                                   id="password" 
                                   name="password" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl form-input-focus bg-white text-gray-800 placeholder-gray-500 pr-12" 
                                   placeholder="è¯·è¾“å…¥å¯†ç "
                                   required>
                            <button type="button" 
                                    id="toggle-password" 
                                    class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <!-- ç™»å½•æŒ‰é’® -->

                    <!-- ç™»å½•æŒ‰é’® -->
                    <button type="submit" 
                            id="login-btn" 
                            class="w-full bg-gradient-primary text-white py-3 rounded-xl font-medium shadow-button button-hover flex items-center justify-center space-x-2">
                        <span>ç™»å½•</span>
                        <i class="fas fa-sign-in-alt"></i>
                    </button>

                    <!-- æ³¨å†Œé“¾æ¥ -->
                    <div class="text-center">
                        <a href="/register" class="text-sm text-primary hover:text-secondary transition-colors">
                            è¿˜æ²¡æœ‰è´¦å·ï¼Ÿç«‹å³æ³¨å†Œ
                        </a>
                    </div>
                </form>

            </div>
        </header>

        <!-- åº•éƒ¨å®‰å…¨åŒºåŸŸ -->
        <div id="bottom-safe-area" class="safe-bottom"></div>
    </div>

    <!-- åŠ è½½æç¤º -->
    <div id="loading-overlay" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 flex flex-col items-center space-y-3">
            <div class="w-8 h-8 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>
            <p class="text-gray-700">æ­£åœ¨ç™»å½•...</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // APIé…ç½®
            const API_BASE_URL = AppConfig.API.BASE_URL;
            
            // å¯†ç æ˜¾ç¤º/éšè—åˆ‡æ¢
            document.querySelector('#toggle-password').addEventListener('click', function() {
                const passwordInput = document.querySelector('#password');
                const icon = this.querySelector('i');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    passwordInput.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });

            // ç™»å½•è¡¨å•æäº¤
            document.querySelector('#login-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const username = document.querySelector('#username').value.trim();
                const password = document.querySelector('#password').value.trim();
                
                // ç®€å•éªŒè¯
                if (!username) {
                    alert('è¯·è¾“å…¥æ‰‹æœºå·æˆ–ç”¨æˆ·å');
                    return;
                }
                
                if (!password) {
                    alert('è¯·è¾“å…¥å¯†ç ');
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                document.querySelector('#loading-overlay').classList.remove('hidden');
                document.querySelector('#login-btn').disabled = true;
                
                try {
                    console.log('ğŸ“¤ å‘é€ç™»å½•è¯·æ±‚...');
                    console.log('ğŸ‘¤ ç”¨æˆ·å:', username);
                    
                    // è°ƒç”¨åç«¯ç™»å½•API
                    console.log('ğŸ” å‘é€è¯·æ±‚åˆ°:', AppConfig.getApiUrl('/api/login'));
                    const response = await fetch(`${AppConfig.getApiUrl('/api/login')}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            username: username,
                            password: password
                        })
                    });

                    console.log('ğŸ” å“åº”çŠ¶æ€:', response.status, response.statusText);
                    console.log('ğŸ” å“åº”å¤´:', Object.fromEntries(response.headers.entries()));

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('âŒ å“åº”é”™è¯¯:', errorText);
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    let data;
                    try {
                        const responseText = await response.text();
                        console.log('ğŸ” åŸå§‹å“åº”æ–‡æœ¬:', responseText);
                        data = JSON.parse(responseText);
                        console.log('ğŸ” è§£æåçš„æ•°æ®:', data);
                    } catch (parseError) {
                        console.error('âŒ JSONè§£æå¤±è´¥:', parseError);
                        throw new Error('å“åº”æ ¼å¼é”™è¯¯');
                    }

                    console.log('ğŸ” dataå¯¹è±¡:', data);
                    console.log('ğŸ” data.dataå¯¹è±¡:', data.data);
                    console.log('ğŸ” å“åº”æ•°æ®ç»“æ„:', data);

                    if (response.ok) {
                        console.log('âœ… ç™»å½•æˆåŠŸ:', data);

                        // ä»æ­£ç¡®çš„è·¯å¾„è·å–æ•°æ®
                        const loginData = data.data || {};
                        const token = loginData.token;

                        console.log('ğŸ” ä¿å­˜çš„tokenå€¼:', token);
                        console.log('ğŸ” tokenç±»å‹:', typeof token);
                        console.log('ğŸ” tokené•¿åº¦:', token ? token.length : 0);

                        if (token) {
                            // ä¿å­˜tokenåˆ°localStorageï¼ˆä½¿ç”¨ç»Ÿä¸€æ–¹æ³•ï¼‰
                            AppConfig.setToken(token);
                            console.log('âœ… Tokenå·²ä¿å­˜åˆ°localStorage');
                        } else {
                            console.error('âŒ ç™»å½•å“åº”ä¸­æ²¡æœ‰token');
                            showError('ç™»å½•å¤±è´¥ï¼šæœåŠ¡å™¨è¿”å›æ•°æ®å¼‚å¸¸');
                            return;
                        }

                        // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
                        if (loginData.user_id) {
                            localStorage.setItem(AppConfig.STORAGE_KEYS.USER_ID, loginData.user_id);
                            localStorage.setItem(AppConfig.STORAGE_KEYS.USERNAME, loginData.username || '');
                            localStorage.setItem('nickname', loginData.nickname || loginData.username || '');
                            console.log('âœ… ç”¨æˆ·ä¿¡æ¯å·²ä¿å­˜åˆ°localStorage');
                            console.log('   user_id:', loginData.user_id);
                            console.log('   username:', loginData.username);
                            console.log('   nickname:', loginData.nickname);
                        } else {
                            console.warn('âš ï¸ ç™»å½•å“åº”ä¸­æ²¡æœ‰ç”¨æˆ·ä¿¡æ¯');
                        }

                        console.log('ğŸ’¾ Tokenå·²ä¿å­˜');

                        // çŸ­æš‚å»¶è¿Ÿåè·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæç¤º
                        setTimeout(function() {
                            console.log('ğŸš€ è·³è½¬åˆ°å¯¹è¯é¡µé¢...');
                            console.log('ğŸ” è·³è½¬å‰æœ€åæ£€æŸ¥token:', localStorage.getItem('api_token'));
                            console.log('ğŸ” è·³è½¬å‰å¼ºåˆ¶åˆ·æ–°localStorage...');

                            // å¼ºåˆ¶å†æ¬¡ä¿å­˜tokenï¼Œç¡®ä¿localStorageæŒä¹…åŒ–
                            localStorage.setItem('api_token', data.data.token);
                            localStorage.setItem('user_id', data.data.user_id);
                            localStorage.setItem('username', data.data.username);
                            localStorage.setItem('nickname', data.data.nickname);

                            console.log('ğŸ” è·³è½¬å‰æœ€ç»ˆæ£€æŸ¥:', localStorage.getItem('api_token'));

                            window.location.href = AppConfig.getPath('/chat');
                        }, 1000); // å¢åŠ å»¶è¿Ÿåˆ°1ç§’
                        
                    } else {
                        // ç™»å½•å¤±è´¥
                        console.error('âŒ ç™»å½•å¤±è´¥:', data.message);
                        alert(data.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ');
                        
                        // éšè—åŠ è½½çŠ¶æ€
                        document.querySelector('#loading-overlay').classList.add('hidden');
                        document.querySelector('#login-btn').disabled = false;
                    }
                    
                } catch (error) {
                    console.error('âŒ ç™»å½•è¯·æ±‚å¤±è´¥:', error);
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ç½‘ç»œé”™è¯¯
                    if (error.message === 'Failed to fetch') {
                        alert('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ï¼š\n1. åç«¯æœåŠ¡æ˜¯å¦å·²å¯åŠ¨\n2. APIåœ°å€æ˜¯å¦æ­£ç¡®\n3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸');
                    } else {
                        alert('ç™»å½•å¤±è´¥ï¼š' + error.message);
                    }
                    
                    // éšè—åŠ è½½çŠ¶æ€
                    document.querySelector('#loading-overlay').classList.add('hidden');
                    document.querySelector('#login-btn').disabled = false;
                }
            });



            // è¾“å…¥æ¡†ç„¦ç‚¹æ•ˆæœ
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    this.parentElement.classList.add('ring-2', 'ring-primary/20');
                });
                
                input.addEventListener('blur', function() {
                    this.parentElement.classList.remove('ring-2', 'ring-primary/20');
                });
            });
        });
    </script>
</body>
</html>