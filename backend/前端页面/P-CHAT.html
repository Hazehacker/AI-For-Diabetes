<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºç³–å°åŠ©æ‰‹ - æ™ºèƒ½å¯¹è¯</title>
    <script src="config.js"></script>
    <script src="libs/tailwindcss.js"></script>
    <script src="libs/fontawesome.min.js"></script>
    <!-- Markdownè§£æåº“ -->
    <script src="libs/marked.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#969FFF',
                        secondary: '#5147FF', 
                        accent: '#3E3987',
                        success: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444'
                    },
                    backgroundImage: {
                        'gradient-primary': 'linear-gradient(135deg, #969FFF 0%, #5147FF 100%)',
                        'gradient-secondary': 'linear-gradient(135deg, #5147FF 0%, #3E3987 100%)',
                        'gradient-card': 'linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%)',
                        'gradient-hero': 'linear-gradient(135deg, #969FFF 0%, #5147FF 50%, #3E3987 100%)'
                    },
                    boxShadow: {
                        'card': '0 4px 20px rgba(150, 159, 255, 0.1)',
                        'button': '0 4px 15px rgba(150, 159, 255, 0.3)',
                        'nav': '0 -2px 20px rgba(150, 159, 255, 0.1)'
                    }
                }
            }
        }
    </script>
    <script>
        // ğŸ¯ è®¾å¤‡æ£€æµ‹å’Œå¹³å°ç‰¹å®šé…ç½®
        const DeviceUtils = {
            isMobile: function() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                       window.innerWidth <= 768;
            },

            isIOS: function() {
                return /iPad|iPhone|iPod/.test(navigator.userAgent);
            },

            isAndroid: function() {
                return /Android/.test(navigator.userAgent);
            },

            isWeChat: function() {
                return /MicroMessenger/i.test(navigator.userAgent);
            },

            // è·å–è®¾å¤‡ä¿¡æ¯ç”¨äºè°ƒè¯•
            getDeviceInfo: function() {
                return {
                    userAgent: navigator.userAgent,
                    isMobile: this.isMobile(),
                    isIOS: this.isIOS(),
                    isAndroid: this.isAndroid(),
                    isWeChat: this.isWeChat(),
                    screenWidth: window.innerWidth,
                    screenHeight: window.innerHeight
                };
            }
        };

        // è°ƒè¯•ï¼šè¾“å‡ºè®¾å¤‡ä¿¡æ¯
        console.log('ğŸ“± è®¾å¤‡ä¿¡æ¯:', DeviceUtils.getDeviceInfo());

        // ğŸ¯ ä½ çš„å¥½æœ‹å‹é…ç½®
        const RobotConfig = {
            // å¥½æœ‹å‹å®šä¹‰
            robots: {
                'xiaojing': {
                    id: 'xiaojing',
                    name: 'å°åŠ©æ‰‹1',
                    voiceId: '601012',  // å¥³ç”ŸéŸ³è‰²
                    avatar: './nvsheng.png',
                    description: 'æ¸©æŸ”å¯çˆ±çš„å¥³ç”Ÿå¥½æœ‹å‹',
                    defaultSpeed: 1.0
                },
                'zhimeng': {
                    id: 'zhimeng',
                    name: 'å°åŠ©æ‰‹2',
                    voiceId: '101015',  // ç”·ç”ŸéŸ³è‰²
                    avatar: './nansheng.png',
                    description: 'èªæ˜ç†æ€§çš„ç”·ç”Ÿå¥½æœ‹å‹',
                    defaultSpeed: 1.0
                }
            },

            // å½“å‰é€‰æ‹©çš„å¥½æœ‹å‹
            currentRobot: null,

            // è·å–å½“å‰å¥½æœ‹å‹
            getCurrentRobot() {
                if (!this.currentRobot) {
                    // ä»localStorageè·å–ä¸Šæ¬¡é€‰æ‹©çš„å¥½æœ‹å‹ï¼Œé»˜è®¤ä½¿ç”¨xiaojing
                    const savedRobot = localStorage.getItem('selected_robot') || 'xiaojing';
                    this.currentRobot = this.robots[savedRobot] || this.robots['xiaojing'];
                }
                return this.currentRobot;
            },

            // è®¾ç½®å½“å‰å¥½æœ‹å‹
            setCurrentRobot(robotId) {
                if (this.robots[robotId]) {
                    this.currentRobot = this.robots[robotId];
                    localStorage.setItem('selected_robot', robotId);
                    this.updateUI();
                    console.log(`ğŸ¤– åˆ‡æ¢åˆ°å¥½æœ‹å‹: ${this.currentRobot.name}`);
                }
            },

            // è·å–å½“å‰è¯­é€Ÿ
            getCurrentSpeed() {
                return parseFloat(localStorage.getItem('robot_speed')) || this.getCurrentRobot().defaultSpeed;
            },

            // è®¾ç½®è¯­é€Ÿ
            setCurrentSpeed(speed) {
                speed = Math.max(0.5, Math.min(2.0, speed)); // é™åˆ¶åœ¨0.5-2.0èŒƒå›´å†…
                localStorage.setItem('robot_speed', speed);
                console.log(`âš¡ è®¾ç½®è¯­é€Ÿ: ${speed}`);
            },

            // æ›´æ–°UIæ˜¾ç¤º
            updateUI() {
                const robot = this.getCurrentRobot();
                const robotAvatar = document.querySelector('#robot-avatar');
                const chatTitle = document.querySelector('#chat-title');

                if (robotAvatar) {
                    robotAvatar.src = robot.avatar;
                    robotAvatar.alt = robot.name;
                }
                if (chatTitle) {
                    chatTitle.textContent = robot.name;
                }
            }
        };

        const unlockAudio = () => {
            console.log('unlock audio');
            window.ttsAudio = new Audio('./silence_1s.mp3');
            window.ttsAudio.muted = true;
            window.ttsAudio.play().then(() => {
                window.ttsAudio.pause();
                window.ttsAudio.currentTime = 0;
                window.ttsAudio.muted = false;
                console.log('audio unlocked');
            }).catch(err => {
                console.error('unlock failed', err);
            });
            document.documentElement.removeEventListener('click', unlockAudio);
        };
        document.documentElement.addEventListener('click', unlockAudio);
    </script>
    <style>
        .safe-top {
            padding-top: env(safe-area-inset-top);
        }
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #969FFF 0%, #5147FF 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .message-bubble-user {
            background: linear-gradient(135deg, #969FFF 0%, #5147FF 100%);
            border-radius: 18px 18px 4px 18px;
        }
        
        .message-bubble-ai {
            background: white;
            border-radius: 18px 18px 18px 4px;
            box-shadow: 0 2px 10px rgba(150, 159, 255, 0.1);
        }
        
        .typing-indicator {
            animation: typing 1.5s infinite;
        }
        
        @keyframes typing {
            0%, 60%, 100% { opacity: 0.3; }
            30% { opacity: 1; }
        }
        
        .voice-recording {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .chat-container {
            height: calc(100vh - 200px);
            overflow-y: auto;
        }
        
        .chat-container::-webkit-scrollbar {
            display: none;
        }
        
        .input-focus:focus {
            outline: none;
            border-color: #969FFF;
            box-shadow: 0 0 0 2px rgba(150, 159, 255, 0.2);
        }
        
        .checkin-success {
            animation: checkinPulse 0.6s ease-out;
        }
        
        @keyframes checkinPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* è¯­éŸ³æŒ‰é’®æŒ‰ä¸‹æ•ˆæœ */
        #voice-btn {
            transition: all 0.2s ease;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        #voice-btn.scale-95 {
            transform: scale(0.95);
        }
        
        /* å¯¹è¯æ¶ˆæ¯å­—ä½“å¤§å° */
        .message-bubble-user p,
        .message-bubble-ai p {
            font-size: 1.125rem !important; /* 18pxï¼Œç›¸å½“äºtext-lg */
            line-height: 1.6;
        }

        /* Markdownæ¸²æŸ“æ ·å¼ */
        .markdown-content {
            line-height: 1.8;
            color: #374151;
        }
        
        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            font-weight: 600;
            margin-top: 1.5em;
            margin-bottom: 0.75em;
            color: #1f2937;
        }
        
        .markdown-content h1 {
            font-size: 1.75em;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.3em;
        }
        
        .markdown-content h2 {
            font-size: 1.5em;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.3em;
        }
        
        .markdown-content h3 {
            font-size: 1.25em;
            color: #5147FF;
        }
        
        .markdown-content h4 {
            font-size: 1.1em;
        }
        
        .markdown-content p {
            margin-bottom: 1em;
        }
        
        .markdown-content ul,
        .markdown-content ol {
            margin-left: 1.5em;
            margin-bottom: 1em;
        }
        
        .markdown-content li {
            margin-bottom: 0.5em;
        }
        
        .markdown-content ul {
            list-style-type: disc;
        }
        
        .markdown-content ol {
            list-style-type: decimal;
        }
        
        .markdown-content strong {
            font-weight: 600;
            color: #1f2937;
        }
        
        .markdown-content em {
            font-style: italic;
        }
        
        .markdown-content code {
            background-color: #f3f4f6;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #ef4444;
        }
        
        .markdown-content pre {
            background-color: #1f2937;
            color: #f9fafb;
            padding: 1em;
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 1em;
        }
        
        .markdown-content pre code {
            background-color: transparent;
            padding: 0;
            color: #f9fafb;
        }
        
        .markdown-content blockquote {
            border-left: 4px solid #969FFF;
            padding-left: 1em;
            margin-left: 0;
            margin-bottom: 1em;
            color: #6b7280;
            font-style: italic;
        }
        
        .markdown-content a {
            color: #5147FF;
            text-decoration: underline;
        }
        
        .markdown-content hr {
            border: none;
            border-top: 2px solid #e5e7eb;
            margin: 2em 0;
        }
        
        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1em;
        }
        
        .markdown-content th,
        .markdown-content td {
            border: 1px solid #e5e7eb;
            padding: 0.5em;
            text-align: left;
        }
        
        .markdown-content th {
            background-color: #f3f4f6;
            font-weight: 600;
        }
        
        
        #debug-log {
            max-height: 30vh;
            overflow-y: auto;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">


    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header id="chat-header" class="bg-white shadow-card px-4 py-3 flex items-center justify-between">
        <button id="profile-btn" class="w-10 h-10 rounded-full overflow-hidden flex items-center justify-center">
            <img src="https://s.coze.cn/image/es6fUICmNgw/"
                 alt="ç”¨æˆ·å¤´åƒ"
                 data-category="äººç‰©"
                 class="w-full h-full object-cover">
        </button>
        <div class="flex items-center space-x-3 relative">
            <button id="robot-avatar-btn" class="w-10 h-10 rounded-full overflow-hidden flex items-center justify-center hover:scale-105 transition-transform">
                <img id="robot-avatar" src="https://s.coze.cn/image/es6fUICmNgw/"
                     alt="å¥½æœ‹å‹å¤´åƒ"
                     class="w-full h-full object-cover rounded-full">
            </button>
            <div class="flex-1">
                <div class="flex items-center justify-between">
                    <h1 id="chat-title" class="text-lg font-semibold text-gray-800">å°åŠ©æ‰‹1</h1>
                    <button id="robot-switch-btn" class="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors ml-2">
                        <i class="fas fa-chevron-down text-gray-600 text-xs"></i>
                    </button>
                </div>
                <div class="flex items-center space-x-1">
                    <div class="w-2 h-2 bg-success rounded-full"></div>
                    <span class="text-success text-xs">åœ¨çº¿</span>
                </div>
            </div>
        </div>
        <div class="relative">
            <button id="calendar-btn" class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors">
                <i class="fas fa-calendar-check text-gray-600"></i>
            </button>
            <!-- æ‰“å¡ç»Ÿè®¡badge -->
            <div id="checkin-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold hidden">
                0
            </div>
        </div>
    </header>

    <!-- AIæ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨ -->
    <div id="typing-indicator" class="hidden bg-white border-b border-gray-200 px-4 py-3 shadow-sm">
        <div class="flex items-center space-x-3">
            <div class="w-8 h-8 bg-gradient-primary rounded-full flex items-center justify-center">
                <i class="fas fa-robot text-white text-sm"></i>
            </div>
            <div class="flex space-x-1">
                <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator" style="animation-delay: 0.2s;"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator" style="animation-delay: 0.4s;"></div>
            </div>
            <span class="text-gray-600 text-sm">AIæ­£åœ¨æ€è€ƒ...</span>
        </div>
    </div>

    <!-- å†å²æ¶ˆæ¯åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div id="history-loading-indicator" class="hidden bg-white border-b border-gray-200 px-4 py-2 text-center">
        <div class="flex items-center justify-center space-x-2">
            <div class="w-4 h-4 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>
            <span class="text-gray-600 text-sm">æ­£åœ¨åŠ è½½å†å²æ¶ˆæ¯...</span>
        </div>
    </div>

    <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
    <div id="chat-messages" class="chat-container px-4 py-4 space-y-6">
        <!-- æ¶ˆæ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
    </div>

    <!-- è¾“å…¥åŒºåŸŸ -->
    <div id="input-area" class="fixed bottom-0 left-0 right-0 safe-bottom">
        <!-- å¿«æ·æ‰“å¡æŒ‰é’® -->
        <div id="quick-actions" class="px-4 py-2 flex items-center justify-start space-x-3">
            <button id="quick-checkin-btn" class="px-6 py-2 bg-gradient-primary text-white rounded-full text-sm font-medium shadow-button flex items-center space-x-2 hover:shadow-lg transform hover:scale-105 transition-all duration-200 active:scale-95">
                <i class="fas fa-check-circle"></i>
                <span>ä»Šæ—¥æ‰“å¡</span>
            </button>
        </div>
        
        <div id="input-container" class="bg-white border-t border-gray-200 p-4 flex items-center space-x-3">
            <!-- è¯­éŸ³è¾“å…¥æŒ‰é’® -->
            <button id="voice-btn" class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center flex-shrink-0">
                <i class="fas fa-microphone text-gray-600 text-lg"></i>
            </button>
            
            <!-- TTSè¯­éŸ³æ’­æŠ¥å¼€å…³ï¼ˆé»˜è®¤å…³é—­ï¼‰ -->
            <button id="tts-toggle-btn" class="w-12 h-12 rounded-full bg-gray-300 flex items-center justify-center flex-shrink-0" title="è¯­éŸ³æ’­æŠ¥ï¼ˆç‚¹å‡»å¼€å¯ï¼‰">
                <i class="fas fa-volume-xmark text-gray-600 text-lg"></i>
            </button>

            <!-- æ–‡æœ¬è¾“å…¥æ¡† -->
            <div id="text-input-wrapper" class="flex-1 relative">
                <textarea 
                    id="message-input" 
                    placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." 
                    class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-2xl resize-none input-focus text-sm"
                    rows="1"
                    maxlength="500"></textarea>
                <button id="send-btn" class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-gradient-primary rounded-full flex items-center justify-center">
                    <i class="fas fa-paper-plane text-white text-xs"></i>
                </button>
            </div>
        </div>
        
        <!-- è¯­éŸ³å½•åˆ¶çŠ¶æ€ï¼ˆç‚¹å‡»æ¨¡å¼ + æµå¼è¯†åˆ«ï¼‰ -->
        <div id="voice-recording-status" class="hidden fixed inset-0 bg-black/50 z-40 flex items-center justify-center">
            <div class="bg-gray-800/90 rounded-2xl p-4 flex flex-col items-center space-y-4 mx-4" style="max-width: 24rem; width: calc(100% - 10rem);">
                <div class="w-16 h-16 bg-success rounded-full flex items-center justify-center voice-recording">
                    <i class="fas fa-microphone text-white text-2xl"></i>
                </div>
                <div class="text-white text-sm font-medium" id="recording-time">00:00</div>
                
                <!-- æŒ‰é’®ç»„ï¼šåœæ­¢å½•éŸ³å’Œå–æ¶ˆ -->
                <div class="flex items-center justify-center space-x-3 w-full">
                    <button id="stop-recording-btn" style="flex: 0 0 calc((100% - 0.75rem) / 2 * 0.8);" class="h-12 bg-success rounded-xl text-white font-medium hover:bg-green-600 transition-colors flex items-center justify-center whitespace-nowrap border-2 border-white/20">
                        <i class="fas fa-check mr-2"></i>å‘é€
                    </button>
                    <button id="cancel-recording-btn" style="flex: 0 0 calc((100% - 0.75rem) / 2 * 0.8);" class="h-12 bg-red-500 rounded-xl text-white font-medium hover:bg-red-600 transition-colors flex items-center justify-center whitespace-nowrap border-2 border-white/20">
                        <i class="fas fa-times mr-2"></i>å–æ¶ˆ
                    </button>
                </div>
                
                <div class="text-gray-300 text-xs text-center px-4 py-2 bg-gray-700/30 rounded-lg w-full">
                    æ­£åœ¨å½•éŸ³ä¸­...
                </div>
            </div>
        </div>

        <!-- è¯­éŸ³æƒé™æç¤ºå¼¹æ¡† -->
        <div id="audio-permission-modal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full transform transition-all duration-300 scale-95" id="audio-permission-content">
                <!-- å¤´éƒ¨å›¾æ ‡ -->
                <div class="flex justify-center pt-8 pb-4">
                    <div class="w-20 h-20 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center shadow-lg">
                        <i class="fas fa-volume-high text-white text-3xl"></i>
                    </div>
                </div>
                
                <!-- æ ‡é¢˜å’Œå†…å®¹ -->
                <div class="px-6 pb-6 text-center">
                    <h3 class="text-xl font-bold text-gray-800 mb-2">å¯ç”¨è¯­éŸ³æ’­æŠ¥</h3>
                    <p class="text-gray-600 text-sm leading-relaxed mb-6">
                        ä¸ºäº†ç»™æ‚¨æä¾›æ›´å¥½çš„è¯­éŸ³ä½“éªŒï¼Œéœ€è¦æ‚¨çš„æµè§ˆå™¨å…è®¸è‡ªåŠ¨æ’­æ”¾éŸ³é¢‘ã€‚<br>
                        è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æˆæƒã€‚
                    </p>
                    
                    <!-- æŒ‰é’®ç»„ -->
                    <div class="flex gap-3">
                        <button id="audio-permission-cancel" class="flex-1 px-4 py-3 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition-colors">
                            ç¨åå†è¯´
                        </button>
                        <button id="audio-permission-allow" class="flex-1 px-4 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-medium hover:from-purple-600 hover:to-pink-600 transition-all shadow-lg">
                            <i class="fas fa-check mr-2"></i>å…è®¸æ’­æ”¾
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸ªäººä¸­å¿ƒæŠ½å±‰ -->
    <div id="profile-drawer" class="fixed inset-0 bg-black/50 z-50 hidden">
        <div id="profile-drawer-content" class="absolute left-0 top-0 bottom-0 w-80 bg-white shadow-2xl transform -translate-x-full transition-transform duration-300 overflow-y-auto">
            <!-- å¤´éƒ¨ -->
            <div class="bg-gradient-primary p-6 text-white">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold">ä¸ªäººä¸­å¿ƒ</h2>
                    <button id="close-profile-btn" class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center hover:bg-white/30">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="w-16 h-16 rounded-full overflow-hidden flex items-center justify-center">
                        <img src="https://s.coze.cn/image/es6fUICmNgw/"
                             alt="ç”¨æˆ·å¤´åƒ"
                             data-category="äººç‰©"
                             class="w-full h-full object-cover">
                    </div>
                    <div>
                        <div id="profile-nickname" class="text-lg font-semibold">åŠ è½½ä¸­...</div>
                        <div id="profile-username" class="text-sm opacity-90">@username</div>
                    </div>
                </div>
            </div>

            <!-- ä¸ªäººä¿¡æ¯ -->
            <div class="px-4 pb-4">
                <div class="bg-gray-50 rounded-xl p-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-id-card mr-2 text-primary"></i>
                        ä¸ªäººä¿¡æ¯
                    </h3>
                    
                    <!-- æ˜µç§° -->
                    <div class="mb-3">
                        <label class="text-xs text-gray-600 mb-1 block">æ˜µç§°</label>
                        <div class="flex items-center space-x-2">
                            <input type="text" id="edit-nickname" 
                                   class="flex-1 px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm"
                                   placeholder="è¯·è¾“å…¥æ˜µç§°">
                        </div>
                    </div>
                    
                    <!-- ç”Ÿæ—¥ -->
                    <div class="mb-3">
                        <label class="text-xs text-gray-600 mb-1 block">ç”Ÿæ—¥</label>
                        <input type="date" id="edit-birthday" 
                               class="w-full px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm">
                    </div>
                    
                    <!-- æ‰‹æœºå·ï¼ˆåªè¯»ï¼‰ -->
                    <div class="mb-3">
                        <label class="text-xs text-gray-600 mb-1 block">æ‰‹æœºå·</label>
                        <input type="text" id="profile-phone" 
                               class="w-full px-3 py-2 bg-gray-100 border border-gray-200 rounded-lg text-sm"
                               placeholder="æœªè®¾ç½®" readonly>
                    </div>
                    
                    <!-- ä¿å­˜æŒ‰é’® -->
                    <button id="save-profile-btn" 
                            class="w-full py-2 bg-gradient-primary text-white rounded-lg text-sm font-medium hover:shadow-lg transition-all">
                        <i class="fas fa-save mr-2"></i>ä¿å­˜ä¿®æ”¹
                    </button>
                </div>
            </div>

            <!-- å¿«é€ŸåŠŸèƒ½ -->
            <div class="px-4 pb-4">
                <div class="bg-gray-50 rounded-xl p-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-th-large mr-2 text-primary"></i>
                        å¿«é€ŸåŠŸèƒ½
                    </h3>

                    <!-- æ‰“å¡è®°å½• -->
                    <button id="checkin-link-btn"
                            class="w-full py-3 bg-white text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-50 transition-all flex items-center justify-center">
                        <i class="fas fa-calendar-check mr-2 text-primary"></i>
                        æ‰“å¡è®°å½•
                    </button>
                </div>
            </div>

            <!-- é€€å‡ºç™»å½• -->
            <div class="px-4 pb-6">
                <button id="logout-btn"
                        class="w-full py-3 bg-red-50 text-red-600 rounded-lg text-sm font-medium hover:bg-red-100 transition-all flex items-center justify-center">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    é€€å‡ºç™»å½•
                </button>
            </div>
        </div>
    </div>


    <!-- æ‰“å¡å¼¹çª— -->
    <div id="checkin-popup" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm max-h-[90vh] flex flex-col shadow-2xl">
            <!-- å¼¹çª—å¤´éƒ¨ -->
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-800 flex items-center space-x-2">
                    <i class="fas fa-check-circle text-primary"></i>
                    <span>ä»Šæ—¥æ‰“å¡</span>
                </h2>
                <button id="close-checkin-popup-btn" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200">
                    <i class="fas fa-times text-gray-600"></i>
                </button>
            </div>

            <!-- å¼¹çª—å†…å®¹ -->
            <div class="p-4 space-y-4">
                <!-- æ§ç³–çŠ¶æ€é€‰æ‹© -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">ä»Šå¤©æ§ç³–çŠ¶æ€å¦‚ä½•ï¼Ÿ</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button type="button" data-status="ä¸€èˆ¬" class="glucose-status-btn px-3 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors">
                            <i class="fas fa-meh text-gray-500 mr-1"></i>ä¸€èˆ¬
                        </button>
                        <button type="button" data-status="è‰¯å¥½" class="glucose-status-btn px-3 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors">
                            <i class="fas fa-smile text-yellow-500 mr-1"></i>è‰¯å¥½
                        </button>
                        <button type="button" data-status="å¥½" class="glucose-status-btn px-3 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors">
                            <i class="fas fa-grin-beam text-green-500 mr-1"></i>å¥½
                        </button>
                    </div>
                </div>

                <!-- æ„Ÿå—è¾“å…¥ -->
                <div>
                    <label for="feeling-text" class="block text-sm font-medium text-gray-700 mb-2">åˆ†äº«ä¸€ä¸‹ä½ çš„æ„Ÿå—ï¼ˆå¯é€‰ï¼‰</label>
                    <textarea
                        id="feeling-text"
                        placeholder="ä»Šå¤©çš„æ„Ÿè§‰æ€ä¹ˆæ ·ï¼Ÿæœ‰ä»€ä¹ˆç‰¹åˆ«çš„ç»å†æˆ–å¿ƒå¾—å—..."
                        class="w-full px-3 py-2 border border-gray-200 rounded-lg resize-none input-focus text-sm"
                        rows="3"
                        maxlength="200"></textarea>
                    <div class="text-xs text-gray-500 mt-1 text-right">
                        <span id="feeling-count">0</span>/200
                    </div>
                </div>

                <!-- æäº¤æŒ‰é’® -->
                <div class="pt-2">
                    <button id="submit-checkin-btn"
                            class="w-full bg-gradient-primary text-white py-3 rounded-lg font-medium shadow-button hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2">
                        <span>ç¡®è®¤æ‰“å¡</span>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¥½æœ‹å‹åˆ‡æ¢å¼¹çª— -->
    <div id="robot-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm max-h-[80vh] flex flex-col shadow-2xl">
            <!-- å¼¹çª—å¤´éƒ¨ -->
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-800 flex items-center space-x-2">
                    <i class="fas fa-robot text-primary"></i>
                    <span>é€‰æ‹©å¥½æœ‹å‹</span>
                </h2>
                <button id="close-robot-modal-btn" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200">
                    <i class="fas fa-times text-gray-600"></i>
                </button>
            </div>

            <!-- å¥½æœ‹å‹é€‰æ‹© -->
            <div class="p-4 space-y-4">
                <div id="robot-options" class="space-y-3">
                    <!-- å¥½æœ‹å‹é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>

                <!-- è¯­é€Ÿè®¾ç½® -->
                <div class="pt-2 border-t border-gray-200">
                    <label class="block text-sm font-medium text-gray-700 mb-3">è¯­é€Ÿè®¾ç½®</label>
                    <div class="space-y-2">
                        <div class="flex items-center justify-between text-sm text-gray-600">
                            <span>æ…¢</span>
                            <span id="speed-value">1.0x</span>
                            <span>å¿«</span>
                        </div>
                        <input type="range" id="speed-slider" min="0.5" max="2.0" step="0.1" value="1.0"
                               class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between text-xs text-gray-500">
                            <span>0.5x</span>
                            <span>1.0x</span>
                            <span>2.0x</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‰“å¡è®°å½•å¼¹çª— -->
    <div id="checkin-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-md max-h-[85vh] flex flex-col shadow-2xl">
            <!-- å¼¹çª—å¤´éƒ¨ -->
            <div class="p-4 border-b border-gray-200 flex items-center justify-between flex-shrink-0">
                <h2 class="text-lg font-semibold text-gray-800 flex items-center space-x-2">
                    <i class="fas fa-calendar-check text-primary"></i>
                    <span>æ‰“å¡è®°å½•</span>
                </h2>
                <div class="flex items-center space-x-2">
                    <button id="sync-btn" class="px-3 py-1 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600 transition-colors" onclick="syncOfflineCheckins()">
                        <i class="fas fa-sync-alt mr-1"></i>åŒæ­¥
                    </button>
                    <button id="close-modal-btn" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200">
                        <i class="fas fa-times text-gray-600"></i>
                    </button>
                </div>
            </div>
            
            <!-- æ‰“å¡ç»Ÿè®¡ -->
            <div class="p-4 bg-gradient-to-br from-blue-50 to-purple-50 flex-shrink-0">
                <div class="grid grid-cols-3 gap-3">
                    <div class="bg-white rounded-xl p-3 text-center shadow-sm">
                        <div class="text-2xl font-bold gradient-text" id="total-checkins">0</div>
                        <div class="text-xs text-gray-600 mt-1">æ€»æ‰“å¡</div>
                    </div>
                    <div class="bg-white rounded-xl p-3 text-center shadow-sm">
                        <div class="text-2xl font-bold text-success" id="continuous-days">0</div>
                        <div class="text-xs text-gray-600 mt-1">è¿ç»­å¤©æ•°</div>
                    </div>
                    <div class="bg-white rounded-xl p-3 text-center shadow-sm">
                        <div class="text-2xl font-bold text-warning" id="this-month">0</div>
                        <div class="text-xs text-gray-600 mt-1">æœ¬æœˆæ‰“å¡</div>
                    </div>
                </div>
            </div>
            
            <!-- æ‰“å¡æ—¥å†ï¼ˆå¯æ»šåŠ¨åŒºåŸŸï¼‰ -->
            <div class="p-4 flex-1 overflow-y-auto">
                <div class="flex items-center justify-between mb-3">
                    <button id="prev-month-btn" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">
                        <i class="fas fa-chevron-left text-gray-600 text-sm"></i>
                    </button>
                    <div class="text-center">
                        <div class="font-semibold text-gray-800" id="current-month">2025å¹´10æœˆ</div>
                    </div>
                    <button id="next-month-btn" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">
                        <i class="fas fa-chevron-right text-gray-600 text-sm"></i>
                    </button>
                </div>
                
                <!-- æ˜ŸæœŸæ ‡é¢˜ -->
                <div class="grid grid-cols-7 gap-1 mb-2">
                    <div class="text-center text-xs text-gray-500 py-1">æ—¥</div>
                    <div class="text-center text-xs text-gray-500 py-1">ä¸€</div>
                    <div class="text-center text-xs text-gray-500 py-1">äºŒ</div>
                    <div class="text-center text-xs text-gray-500 py-1">ä¸‰</div>
                    <div class="text-center text-xs text-gray-500 py-1">å››</div>
                    <div class="text-center text-xs text-gray-500 py-1">äº”</div>
                    <div class="text-center text-xs text-gray-500 py-1">å…­</div>
                </div>
                
                <!-- æ—¥å†æ ¼å­ -->
                <div id="calendar-container">
                    <!-- LoadingçŠ¶æ€ -->
                    <div id="calendar-loading" class="flex items-center justify-center py-8">
                        <div class="flex flex-col items-center space-y-3">
                            <div class="w-6 h-6 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>
                            <div class="text-sm text-gray-600">åŠ è½½ä¸­...</div>
                        </div>
                    </div>

                    <!-- æ—¥å†ç½‘æ ¼ -->
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1 min-h-[240px]" style="display: none;">
                        <!-- æ—¥å†å°†ç”±JavaScriptç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ğŸ”¥ é—®é¢˜1ï¼šæ£€æŸ¥ç™»å½•çŠ¶æ€ï¼Œæœªç™»å½•è·³è½¬åˆ°ç™»å½•é¡µ
            console.log('ğŸ” èŠå¤©é¡µé¢åŠ è½½æ—¶localStorageå†…å®¹:', Object.keys(localStorage));
            console.log('ğŸ” localStorageé•¿åº¦:', localStorage.length);
            console.log('ğŸ” api_tokenå€¼:', localStorage.getItem('api_token'));
            console.log('ğŸ” api_tokenç±»å‹:', typeof localStorage.getItem('api_token'));
            console.log('ğŸ” ç›´æ¥è®¿é—®localStorage.api_token:', localStorage.api_token);
            console.log('ğŸ” æ‰€æœ‰localStorageå€¼:');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                console.log(`  ${key}: ${localStorage.getItem(key)}`);
            }

            // å°è¯•æ‰‹åŠ¨è®¾ç½®tokençœ‹çœ‹æ˜¯å¦å·¥ä½œ
            console.log('ğŸ” æµ‹è¯•è®¾ç½®token...');
            localStorage.setItem('test_token', 'test_value');
            console.log('ğŸ” test_tokenå€¼:', localStorage.getItem('test_token'));

            const API_TOKEN_CHECK = AppConfig.getToken();
            console.log('ğŸ”‘ æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼ŒToken:', API_TOKEN_CHECK ? API_TOKEN_CHECK.substring(0, 50) + '...' : 'æœªè·å–');
            console.log('ğŸ”‘ Tokené•¿åº¦:', API_TOKEN_CHECK ? API_TOKEN_CHECK.length : 0);
            console.log('ğŸ”‘ AppConfig.STORAGE_KEYS.TOKEN:', AppConfig.STORAGE_KEYS.TOKEN);

            // æ¸…ç†localStorageä¸­çš„æ— æ•ˆtoken
            if (localStorage.getItem('api_token') === 'undefined') {
                console.log('ğŸ§¹ å‘ç°æ— æ•ˆtokenï¼Œæ­£åœ¨æ¸…ç†...');
                localStorage.removeItem('api_token');
                console.log('âœ… å·²æ¸…ç†æ— æ•ˆtoken');
            }
            if (!API_TOKEN_CHECK) {
                console.log('âŒ æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ');
                AppConfig.navigate('/login');
                return; // ç»ˆæ­¢åç»­æ‰§è¡Œ
            }

            // API é…ç½®ï¼ˆä½¿ç”¨ç»Ÿä¸€é…ç½®ï¼‰- æå‰å£°æ˜ï¼Œé¿å…åç»­å‡½æ•°ä½¿ç”¨æ—¶æœªåˆå§‹åŒ–
            const API_BASE_URL = AppConfig.API.BASE_URL;
            const API_TOKEN = AppConfig.getToken() || '';  // ä»æœ¬åœ°å­˜å‚¨è·å–token
            let currentAIMessageElement = null;  // å½“å‰AIæ¶ˆæ¯å…ƒç´ ï¼Œç”¨äºæµå¼æ›´æ–°

            const messageInput = document.querySelector('#message-input');

            // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–æµç¨‹
            async function initializePage() {
                try {
                    console.log("ğŸš€ å¼€å§‹é¡µé¢åˆå§‹åŒ–...");

                    // 1. åŠ è½½æ‰“å¡è®°å½•
                    await loadCheckinFromBackend();
                    console.log("âœ… æ‰“å¡è®°å½•å·²ä»åç«¯åŠ è½½");
                    updateCheckinStats();

                    // åˆå§‹åŒ–æœºå™¨äººåŠŸèƒ½
                    initializeRobotFeatures();

                    // 2. è·å–æœ€æ–°ä¼šè¯å¹¶åŠ è½½å¯¹è¯å†å²
                    const hasHistory = await loadLatestSessionAndHistory();

                    // 3. å¦‚æœæ²¡æœ‰å†å²å¯¹è¯ï¼Œæ˜¾ç¤ºå¼€åœºç™½
                    if (!hasHistory) {
                        console.log("ğŸ¤– æ²¡æœ‰å†å²å¯¹è¯ï¼Œæ˜¾ç¤ºAIå¼€åœºç™½");
                        setTimeout(() => {
                            addAIMessage('ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ä¸“å±å„¿ç«¥é’å°‘å¹´ç³–å°¿ç—…ç®¡ç†åŠ©æ‰‹æ™ºç³–å°åŠ©æ‰‹ï¼ğŸ˜Š\n\næˆ‘å¯ä»¥å¸®ä½ ï¼š\nâ€¢ è§£ç­”ç³–å°¿ç—…ç›¸å…³é—®é¢˜\nâ€¢ è®°å½•å’Œç®¡ç†è¡€ç³–æ•°æ®\nâ€¢ æä¾›é¥®é£Ÿå’Œè¿åŠ¨å»ºè®®\nâ€¢ æé†’é‡è¦äº‹é¡¹\nâ€¢ åˆ†æå¥åº·è¶‹åŠ¿\n\næœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ');
                        }, 1000);
                    } else {
                        console.log("âœ… å·²åŠ è½½å†å²å¯¹è¯ï¼Œè·³è¿‡å¼€åœºç™½");
                    }

                    console.log("ğŸ‰ é¡µé¢åˆå§‹åŒ–å®Œæˆ");

                } catch (error) {
                    console.error("âŒ é¡µé¢åˆå§‹åŒ–å¤±è´¥:", error);
                    // å³ä½¿åˆå§‹åŒ–å¤±è´¥ï¼Œä¹Ÿè¦æ˜¾ç¤ºå¼€åœºç™½
                    setTimeout(() => {
                        addAIMessage('ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ä¸“å±å„¿ç«¥é’å°‘å¹´ç³–å°¿ç—…ç®¡ç†åŠ©æ‰‹æ™ºç³–å°åŠ©æ‰‹ï¼ğŸ˜Š\n\næˆ‘å¯ä»¥å¸®ä½ ï¼š\nâ€¢ è§£ç­”ç³–å°¿ç—…ç›¸å…³é—®é¢˜\nâ€¢ è®°å½•å’Œç®¡ç†è¡€ç³–æ•°æ®\nâ€¢ æä¾›é¥®é£Ÿå’Œè¿åŠ¨å»ºè®®\nâ€¢ æé†’é‡è¦äº‹é¡¹\nâ€¢ åˆ†æå¥åº·è¶‹åŠ¿\n\næœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ');
                    }, 1000);
                }
            }

            // è·å–æœ€æ–°ä¼šè¯å¹¶åŠ è½½å†å²
            async function loadLatestSessionAndHistory() {
                try {
                    if (!API_TOKEN || !cachedUserId) {
                        console.log('ğŸ” æœªæ‰¾åˆ°API Tokenæˆ–ç”¨æˆ·IDï¼Œè·³è¿‡åŠ è½½æœ€æ–°ä¼šè¯');
                        return false;
                    }

                    console.log('ğŸ“š å¼€å§‹è·å–ç”¨æˆ·ä¼šè¯...');

                    // å…ˆå°è¯•ä»localStorageè·å–ä¼šè¯ID
                    let userConversationId = getUserConversationId();

                    // å¦‚æœæ²¡æœ‰ç¼“å­˜çš„ä¼šè¯IDï¼Œä»æœåŠ¡å™¨è·å–æœ€æ–°ä¼šè¯
                    if (!userConversationId) {
                        const response = await fetch(`${AppConfig.getApiUrl('/api/chat/sessions/latest')}?user_id=${cachedUserId}`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${API_TOKEN}`
                            }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            if (data.success && data.data && data.data.conversation_id) {
                                userConversationId = data.data.conversation_id;
                                conversationId = userConversationId;
                                setUserConversationId(userConversationId);
                                console.log('âœ… è·å–åˆ°æœ€æ–°ä¼šè¯ID:', userConversationId);
                            } else {
                                console.log('ğŸ“­ ç”¨æˆ·æš‚æ— å¯¹è¯ä¼šè¯ï¼Œå°†åˆ›å»ºæ–°ä¼šè¯');
                                return false;
                            }
                        } else {
                            console.warn('âš ï¸ è·å–æœ€æ–°ä¼šè¯å¤±è´¥ï¼ŒçŠ¶æ€ç :', response.status);
                            return false;
                        }
                    } else {
                        console.log('ğŸ’¾ ä½¿ç”¨ç¼“å­˜çš„ä¼šè¯ID:', userConversationId);
                        conversationId = userConversationId;
                    }

                    // å¦‚æœæœ‰ä¼šè¯IDï¼ŒåŠ è½½å¯¹è¯å†å²
                    if (conversationId) {
                        console.log("ğŸ“š å¼€å§‹åŠ è½½å¯¹è¯å†å²ï¼Œä¼šè¯ID:", conversationId);
                        await loadChatHistory();
                        return true; // æœ‰å†å²å¯¹è¯
                    }

                    return false; // æ²¡æœ‰å†å²å¯¹è¯

                } catch (error) {
                    console.error('âŒ åŠ è½½ç”¨æˆ·ä¼šè¯å¤±è´¥:', error);
                    return false; // å¤±è´¥æ—¶è®¤ä¸ºæ²¡æœ‰å†å²å¯¹è¯
                }
            }

            // å¼€å§‹åˆå§‹åŒ–
            initializePage();
            const sendBtn = document.querySelector('#send-btn');
            const voiceBtn = document.querySelector('#voice-btn');
            const ttsToggleBtn = document.querySelector('#tts-toggle-btn');
            const profileBtn = document.querySelector('#profile-btn');
            const chatMessages = document.querySelector('#chat-messages');
            const voiceRecordingStatus = document.querySelector('#voice-recording-status');
            const typingIndicator = document.querySelector('#typing-indicator');
            const calendarBtn = document.querySelector('#calendar-btn');
            const checkinModal = document.querySelector('#checkin-modal');
            const closeModalBtn = document.querySelector('#close-modal-btn');
            const quickCheckinBtn = document.querySelector('#quick-checkin-btn');

            // æœºå™¨äººç›¸å…³å…ƒç´ 
            const robotAvatarBtn = document.querySelector('#robot-avatar-btn');
            const robotSwitchBtn = document.querySelector('#robot-switch-btn');
            const robotModal = document.querySelector('#robot-modal');
            const closeRobotModalBtn = document.querySelector('#close-robot-modal-btn');
            const robotOptions = document.querySelector('#robot-options');
            const speedSlider = document.querySelector('#speed-slider');
            const speedValue = document.querySelector('#speed-value');

            // æ‰“å¡å¼¹çª—ç›¸å…³å…ƒç´ 
            const checkinPopup = document.querySelector('#checkin-popup');
            const closeCheckinPopupBtn = document.querySelector('#close-checkin-popup-btn');
            const glucoseStatusBtns = document.querySelectorAll('.glucose-status-btn');
            const feelingText = document.querySelector('#feeling-text');
            const feelingCount = document.querySelector('#feeling-count');
            const submitCheckinBtn = document.querySelector('#submit-checkin-btn');
            const recordingTime = document.querySelector('#recording-time');
            const stopRecordingBtn = document.querySelector('#stop-recording-btn');
            const cancelRecordingBtn = document.querySelector('#cancel-recording-btn');
            
            // ä¸ªäººä¸­å¿ƒç›¸å…³å…ƒç´ 
            const profileDrawer = document.querySelector('#profile-drawer');
            const profileDrawerContent = document.querySelector('#profile-drawer-content');
            const closeProfileBtn = document.querySelector('#close-profile-btn');
            const saveProfileBtn = document.querySelector('#save-profile-btn');
            const logoutBtn = document.querySelector('#logout-btn');

            let isRecording = false;
            let recordingStartTime = 0;
            let recordingTimer = null;
            let recordingCancelled = false; // å½•éŸ³æ˜¯å¦è¢«å–æ¶ˆ
            let mediaRecorder = null; // MediaRecorderå®ä¾‹
            let audioChunks = []; // å½•éŸ³æ•°æ®å—
            let messageCount = 3; // å½“å‰æ¶ˆæ¯æ•°é‡ï¼Œç”¨äºç”Ÿæˆæ–°æ¶ˆæ¯ID
            let chatHistoryPage = 1; // å½“å‰å†å²æ¶ˆæ¯é¡µç 
            let chatHistoryTotal = 0; // å†å²æ¶ˆæ¯æ€»æ•°
            let isLoadingHistory = false; // æ˜¯å¦æ­£åœ¨åŠ è½½å†å²æ¶ˆæ¯
            let hasMoreHistory = true; // æ˜¯å¦è¿˜æœ‰æ›´å¤šå†å²æ¶ˆæ¯
            let checkinData = JSON.parse(localStorage.getItem('checkinData')) || [];
            let currentCalendarDate = new Date();

            // æœºå™¨äººç›¸å…³å˜é‡
            let selectedRobot = RobotConfig.getCurrentRobot();
            
            // è¯­éŸ³è¯†åˆ«ç›¸å…³å˜é‡ï¼ˆæš‚æ—¶ä½¿ç”¨ä¼ ç»ŸAPIæ–¹å¼ï¼‰
            let isStreamingASR = false; // æš‚æ—¶å…³é—­æµå¼è¯†åˆ«

            // API_TOKEN, API_BASE_URL, currentAIMessageElement å·²åœ¨å‰é¢å£°æ˜

            // è·å–å¹¶éªŒè¯ç¼“å­˜çš„userId
            function getCachedUserId() {
                let userId = localStorage.getItem(AppConfig.STORAGE_KEYS.USER_ID);

                // å¦‚æœæ²¡æœ‰ç¼“å­˜çš„userIdï¼Œå°è¯•ä»tokenä¸­è§£æ
                if (!userId && API_TOKEN) {
                    try {
                        const payload = JSON.parse(atob(API_TOKEN.split('.')[1]));
                        userId = payload.user_id;
                        if (userId) {
                            localStorage.setItem(AppConfig.STORAGE_KEYS.USER_ID, userId);
                            console.log('âœ… ä»tokenä¸­è§£æå¹¶ç¼“å­˜user_id:', userId);
                        }
                    } catch (e) {
                        console.error('âŒ ä»tokenè§£æuser_idå¤±è´¥:', e);
                    }
                }

                return userId;
            }

            let cachedUserId = getCachedUserId();

            // è·å–ç”¨æˆ·ç›¸å…³çš„conversation_id
            function getUserConversationId() {
                const userKey = `${AppConfig.STORAGE_KEYS.CONVERSATION_ID}_${cachedUserId || 'unknown'}`;
                return localStorage.getItem(userKey) || null;
            }

            // ä¿å­˜ç”¨æˆ·ç›¸å…³çš„conversation_id
            function setUserConversationId(conversationId) {
                if (cachedUserId && conversationId) {
                    const userKey = `${AppConfig.STORAGE_KEYS.CONVERSATION_ID}_${cachedUserId}`;
                    localStorage.setItem(userKey, conversationId);
                    console.log(`ğŸ’¾ ä¿å­˜ç”¨æˆ· ${cachedUserId} çš„ä¼šè¯ID:`, conversationId);
                }
            }

            // åˆå§‹åŒ–ç”¨æˆ·ç›¸å…³çš„ä¼šè¯IDç¼“å­˜
            let conversationId = getUserConversationId();

            // ==================== å¯¹è¯å†å²åŠŸèƒ½ ====================

            // å®‰å…¨è§£ææ—¶é—´æˆ³ï¼Œæ”¯æŒå¤šç§æ ¼å¼
            function parseTimestamp(timestampStr) {
                if (!timestampStr) {
                    console.warn('parseTimestamp: æ—¶é—´æˆ³ä¸ºç©ºï¼Œè¿”å›å½“å‰æ—¶é—´');
                    return new Date();
                }

                try {
                    // å¦‚æœå·²ç»æ˜¯Dateå¯¹è±¡ï¼Œç›´æ¥è¿”å›
                    if (timestampStr instanceof Date) {
                        if (isNaN(timestampStr.getTime())) {
                            console.warn('parseTimestamp: Dateå¯¹è±¡æ— æ•ˆï¼Œè¿”å›å½“å‰æ—¶é—´');
                            return new Date();
                        }
                        return timestampStr;
                    }

                    // å¦‚æœæ˜¯æ•°å­—ï¼Œå¯èƒ½æ˜¯æ—¶é—´æˆ³ï¼ˆç§’æˆ–æ¯«ç§’ï¼‰
                    if (typeof timestampStr === 'number') {
                        // åˆ¤æ–­æ˜¯ç§’çº§æ—¶é—´æˆ³ï¼ˆ10ä½ï¼‰è¿˜æ˜¯æ¯«ç§’çº§æ—¶é—´æˆ³ï¼ˆ13ä½ï¼‰
                        let timestamp = timestampStr;
                        if (timestampStr < 10000000000) {
                            // ç§’çº§æ—¶é—´æˆ³ï¼Œè½¬æ¢ä¸ºæ¯«ç§’
                            timestamp = timestampStr * 1000;
                        }
                        const date = new Date(timestamp);
                        if (isNaN(date.getTime())) {
                            console.warn('parseTimestamp: æ•°å­—æ—¶é—´æˆ³æ— æ•ˆ:', timestampStr);
                            return new Date();
                        }
                        return date;
                    }

                    // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•å¤šç§è§£ææ–¹å¼
                    if (typeof timestampStr === 'string') {
                        // å…ˆæ£€æŸ¥æ˜¯å¦æ˜¯ GMT æ ¼å¼ï¼Œå¦‚æœæ˜¯ï¼Œéœ€è¦è½¬æ¢ä¸ºä¸­å›½æ—¶åŒºï¼ˆUTC+8ï¼‰
                        // ä¾‹å¦‚: "Fri, 28 Nov 2025 20:27:50 GMT"
                        const gmtMatch = timestampStr.match(/(\d{1,2})\s+(\w{3})\s+(\d{4})\s+(\d{1,2}):(\d{2}):(\d{2})\s+GMT/);
                        if (gmtMatch) {
                            const [, day, monthStr, year, hour, minute, second] = gmtMatch;
                            const monthMap = {
                                'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
                                'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11
                            };
                            const month = monthMap[monthStr];
                            if (month !== undefined) {
                                // GMT æ—¶é—´å°±æ˜¯ UTC æ—¶é—´ï¼Œå…ˆè§£æä¸º UTC æ—¶é—´
                                const utcDate = new Date(Date.UTC(
                                    parseInt(year),
                                    month,
                                    parseInt(day),
                                    parseInt(hour),
                                    parseInt(minute),
                                    parseInt(second || 0)
                                ));
                                // ç„¶å-8å°æ—¶è½¬æ¢ä¸ºä¸­å›½æ—¶åŒºï¼ˆå®é™…éœ€è¦-8å°æ—¶ï¼‰
                                if (!isNaN(utcDate.getTime())) {
                                    const chinaDate = new Date(utcDate.getTime() - 8 * 60 * 60 * 1000);
                                    return chinaDate;
                                }
                            }
                        }

                        // å°è¯•ç›´æ¥è§£æï¼ˆæ”¯æŒISOæ ¼å¼å’Œå…¶ä»–æ ¼å¼ï¼‰
                        const date = new Date(timestampStr);
                        if (!isNaN(date.getTime())) {
                            // å¦‚æœè§£ææˆåŠŸï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯ UTC æ—¶é—´ï¼ˆæ²¡æœ‰æ—¶åŒºä¿¡æ¯çš„æƒ…å†µï¼‰
                            // å¦‚æœæ—¶é—´å­—ç¬¦ä¸²ä»¥ Z ç»“å°¾æˆ–è€…æ˜¯ ISO æ ¼å¼ä½†æ²¡æœ‰æ—¶åŒºï¼Œå¯èƒ½éœ€è¦è°ƒæ•´
                            // ä½†è¿™é‡Œå…ˆç›´æ¥è¿”å›ï¼Œå› ä¸º GMT æ ¼å¼å·²ç»åœ¨ä¸Šé¢å¤„ç†äº†
                            return date;
                        }

                        // å°è¯•è§£æå…¶ä»–å¸¸è§æ ¼å¼ï¼Œå¦‚ "2024-11-25 14:30:00"
                        // å¦‚æœæ—¶é—´å­—ç¬¦ä¸²æ²¡æœ‰æ—¶åŒºä¿¡æ¯ï¼Œå‡è®¾å®ƒæ˜¯ UTC æ—¶é—´ï¼Œç„¶ååŠ ä¸Š 8 å°æ—¶è½¬æ¢ä¸ºä¸­å›½æ—¶åŒº
                        const dateTimeMatch = timestampStr.match(/(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2}):(\d{2})/);
                        if (dateTimeMatch) {
                            const [, year, month, day, hour, minute, second] = dateTimeMatch;
                            // å…ˆè§£æä¸º UTC æ—¶é—´
                            const utcDate = new Date(Date.UTC(
                                parseInt(year), 
                                parseInt(month) - 1, 
                                parseInt(day), 
                                parseInt(hour), 
                                parseInt(minute), 
                                parseInt(second || 0)
                            ));
                            // å¦‚æœè§£ææˆåŠŸï¼ŒåŠ ä¸Š 16 å°æ—¶ï¼ˆè½¬æ¢ä¸ºä¸­å›½æ—¶åŒºï¼Œå®é™…éœ€è¦åŠ 16å°æ—¶ï¼‰
                            if (!isNaN(utcDate.getTime())) {
                                const chinaDate = new Date(utcDate.getTime() + 16 * 60 * 60 * 1000);
                                return chinaDate;
                            }
                        }
                    }

                    // å¦‚æœæ‰€æœ‰è§£æéƒ½å¤±è´¥ï¼Œè®°å½•è­¦å‘Šå¹¶è¿”å›å½“å‰æ—¶é—´
                    console.warn('parseTimestamp: æ— æ³•è§£ææ—¶é—´æˆ³ï¼Œè¿”å›å½“å‰æ—¶é—´:', timestampStr, typeof timestampStr);
                    return new Date();
                } catch (error) {
                    console.error('parseTimestamp: æ—¶é—´æˆ³è§£æé”™è¯¯:', error, timestampStr);
                    return new Date();
                }
            }

            // åŠ è½½å¯¹è¯å†å²
            async function loadChatHistory(page = 1, append = false) {
                try {
                    if (!API_TOKEN) {
                        console.log('ğŸ” æœªæ‰¾åˆ°API Tokenï¼Œè·³è¿‡åŠ è½½å¯¹è¯å†å²');
                        return;
                    }

                    if (!conversationId) {
                        console.log('ğŸ’¬ æ²¡æœ‰ä¼šè¯IDï¼Œè·³è¿‡åŠ è½½å¯¹è¯å†å²');
                        return;
                    }

                    if (isLoadingHistory && page > 1) {
                        console.log('â³ æ­£åœ¨åŠ è½½å†å²æ¶ˆæ¯ï¼Œè·³è¿‡é‡å¤è¯·æ±‚');
                        return;
                    }

                    isLoadingHistory = true;

                    // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨ï¼ˆä»…åœ¨è¿½åŠ æ¨¡å¼ä¸‹ï¼‰
                    if (append) {
                        const loadingIndicator = document.querySelector('#history-loading-indicator');
                        loadingIndicator.classList.remove('hidden');
                    }

                    console.log(`ğŸ“š åŠ è½½å¯¹è¯å†å² (ç¬¬${page}é¡µ)...`);
                    console.log('   ğŸ”‘ Token:', API_TOKEN.substring(0, 50) + '...');
                    console.log('   ğŸ‘¤ UserID:', cachedUserId);
                    console.log('   ğŸ’¬ ConversationID:', conversationId);

                    const pageSize = 20; // æ¯é¡µåŠ è½½20æ¡æ¶ˆæ¯
                    const response = await fetch(`${AppConfig.getApiUrl('/api/chat/history')}?user_id=${cachedUserId}&conversation_id=${conversationId}&page=${page}&page_size=${pageSize}`, {
                        method: 'GET'
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();

                    console.log('ğŸ“¦ å¯¹è¯å†å²APIè¿”å›:', data);

                    if (data.success && data.data && data.data.turns && data.data.turns.length > 0) {
                        console.log(`âœ… åŠ è½½åˆ° ${data.data.turns.length} æ¡å†å²æ¶ˆæ¯`);

                        // æ›´æ–°åˆ†é¡µä¿¡æ¯
                        if (page === 1) {
                            chatHistoryTotal = data.total || data.data.total || data.data.turns.length;
                        }

                        // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤šå†å²æ¶ˆæ¯
                        hasMoreHistory = data.data.turns.length === pageSize;

                        // å°†å†å²æ¶ˆæ¯æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Š
                        await displayChatHistory(data.data, append);

                        // æ›´æ–°å½“å‰é¡µç 
                        chatHistoryPage = page;
                    } else {
                        console.log('ğŸ“­ æ²¡æœ‰æ‰¾åˆ°æ›´å¤šå¯¹è¯å†å²');
                        hasMoreHistory = false;
                        if (page === 1) {
                            chatHistoryTotal = 0;
                        }
                    }

                } catch (error) {
                    console.error('âŒ åŠ è½½å¯¹è¯å†å²å¤±è´¥:', error);
                    // åŠ è½½å¤±è´¥ä¸å½±å“æ­£å¸¸ä½¿ç”¨ï¼Œåªè®°å½•é”™è¯¯
                } finally {
                    isLoadingHistory = false;
                    // éšè—åŠ è½½æŒ‡ç¤ºå™¨
                    const loadingIndicator = document.querySelector('#history-loading-indicator');
                    loadingIndicator.classList.add('hidden');
                }
            }

            // æ˜¾ç¤ºå¯¹è¯å†å²
            async function displayChatHistory(data, append = false) {
                // åç«¯è¿”å›çš„æ˜¯turnsæ ¼å¼ï¼ˆå¯¹è¯è½®æ¬¡ï¼‰ï¼Œæ¯ä¸ªè½®æ¬¡åŒ…å«queryå’Œai_content
                let turns = [];

                if (Array.isArray(data)) {
                    // å¦‚æœç›´æ¥æ˜¯turnsæ•°ç»„
                    turns = data;
                } else if (data.turns && Array.isArray(data.turns)) {
                    // å¦‚æœæ˜¯åˆ†é¡µæ ¼å¼
                    turns = data.turns;
                } else {
                    console.warn('âš ï¸ å¯¹è¯å†å²æ•°æ®æ ¼å¼ä¸æ­£ç¡®:', data);
                    return;
                }

                console.log(`ğŸ“ æ˜¾ç¤ºå¯¹è¯å†å²ï¼Œå…± ${turns.length} ä¸ªå¯¹è¯è½®æ¬¡:`, turns);

                if (turns.length === 0) {
                    console.log('ğŸ“­ æ²¡æœ‰å¯¹è¯å†å²');
                    return;
                }

                // è·å–èŠå¤©æ¶ˆæ¯å®¹å™¨
                const chatMessages = document.querySelector('#chat-messages');

                // å¦‚æœä¸æ˜¯è¿½åŠ æ¨¡å¼ï¼Œæ¸…ç©ºå½“å‰æ¶ˆæ¯åŒºåŸŸ
                if (!append) {
                    chatMessages.innerHTML = '';
                }

                // åˆ›å»ºä¸€ä¸ªä¸´æ—¶å®¹å™¨æ¥å­˜æ”¾æ–°æ¶ˆæ¯
                const tempContainer = document.createElement('div');

                    // æ˜¾ç¤ºæ¯ä¸ªå¯¹è¯è½®æ¬¡ï¼ˆæ³¨æ„ï¼šå†å²æ¶ˆæ¯åº”è¯¥å€’åºæ˜¾ç¤ºï¼Œå› ä¸ºæœ€æ–°çš„åœ¨åº•éƒ¨ï¼‰
                for (const turn of turns) {
                    // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
                    if (turn.query) {
                        const userTimestamp = parseTimestamp(turn.created_at);
                        console.log('ğŸ“… ç”¨æˆ·æ¶ˆæ¯æ—¶é—´æˆ³:', {
                            åŸå§‹å€¼: turn.created_at,
                            è§£æå: userTimestamp,
                            æ ¼å¼åŒ–: formatMessageTime(userTimestamp)
                        });
                        const userMessageElement = createUserMessageElement(turn.query, userTimestamp);
                        tempContainer.appendChild(userMessageElement);
                    }

                    // æ˜¾ç¤ºAIå›å¤
                    if (turn.ai_content) {
                        const aiTimestamp = parseTimestamp(turn.ai_created_at || turn.created_at);
                        console.log('ğŸ“… AIæ¶ˆæ¯æ—¶é—´æˆ³:', {
                            åŸå§‹å€¼: turn.ai_created_at || turn.created_at,
                            è§£æå: aiTimestamp,
                            æ ¼å¼åŒ–: formatMessageTime(aiTimestamp)
                        });
                        const aiMessageElement = createAIMessageElement(turn.ai_content, aiTimestamp);
                        tempContainer.appendChild(aiMessageElement);
                    }
                }

                // å°†æ–°æ¶ˆæ¯æ’å…¥åˆ°é¡¶éƒ¨ï¼ˆå¦‚æœæ˜¯è¿½åŠ æ¨¡å¼ï¼‰
                if (append && chatMessages.children.length > 0) {
                    // åœ¨ç°æœ‰æ¶ˆæ¯å‰æ’å…¥å†å²æ¶ˆæ¯
                    chatMessages.insertBefore(tempContainer, chatMessages.firstChild);

                    // æ·»åŠ ä¸€ä¸ªåˆ†éš”ç¬¦
                    const separator = document.createElement('div');
                    separator.className = 'text-center py-2';
                    separator.innerHTML = '<div class="inline-block px-3 py-1 bg-gray-100 text-gray-500 text-xs rounded-full">ä»¥ä¸Šæ˜¯å†å²æ¶ˆæ¯</div>';
                    chatMessages.insertBefore(separator, chatMessages.children[turns.length * 2]); // æ¯è½®å¯¹è¯æœ‰2æ¡æ¶ˆæ¯
                } else {
                    // ç›´æ¥æ›¿æ¢æ‰€æœ‰æ¶ˆæ¯
                    chatMessages.innerHTML = '';
                    chatMessages.appendChild(tempContainer);
                }

                // æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆå¦‚æœæ˜¯é¦–æ¬¡åŠ è½½ï¼‰
                if (!append) {
                    setTimeout(() => {
                        scrollToBottom();
                    }, 100);
                }

                console.log('âœ… å¯¹è¯å†å²æ˜¾ç¤ºå®Œæˆ');
            }

            // ==================== ä¸ªäººä¸­å¿ƒåŠŸèƒ½ ====================

            // æ‰“å¼€ä¸ªäººä¸­å¿ƒæŠ½å±‰
            profileBtn.addEventListener('click', function() {
                openProfileDrawer();
            });

            // å…³é—­ä¸ªäººä¸­å¿ƒæŠ½å±‰
            closeProfileBtn.addEventListener('click', function() {
                closeProfileDrawer();
            });

            // ç‚¹å‡»èƒŒæ™¯å…³é—­æŠ½å±‰
            profileDrawer.addEventListener('click', function(e) {
                if (e.target === profileDrawer) {
                    closeProfileDrawer();
                }
            });

            // æ‰“å¼€æŠ½å±‰
            function openProfileDrawer() {
                profileDrawer.classList.remove('hidden');
                setTimeout(() => {
                    profileDrawerContent.classList.remove('-translate-x-full');
                }, 10);
                loadUserProfile();
            }

            // å…³é—­æŠ½å±‰
            function closeProfileDrawer() {
                profileDrawerContent.classList.add('-translate-x-full');
                setTimeout(() => {
                    profileDrawer.classList.add('hidden');
                }, 300);
            }
            
            // åŠ è½½ç”¨æˆ·ä¿¡æ¯
            async function loadUserProfile() {
                try {
                    if (!API_TOKEN) {
                        console.error('âŒ æœªæ‰¾åˆ°API Token');
                        return;
                    }

                    if (!cachedUserId) {
                        console.error('âŒ æœªæ‰¾åˆ°ç¼“å­˜çš„user_id');
                        return;
                    }

                    console.log('ğŸ“¥ åŠ è½½ç”¨æˆ·ä¿¡æ¯...');
                    console.log('   ğŸ”‘ Token:', API_TOKEN.substring(0, 50) + '...');
                    console.log('   ğŸ‘¤ UserID:', cachedUserId);

                    const response = await fetch(`${AppConfig.getApiUrl('/api/user/profile')}?user_id=${cachedUserId}`, {
                        method: 'GET'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    console.log('ğŸ“¦ APIè¿”å›æ•°æ®:', data);
                    
                    // æ£€æŸ¥æ•°æ®ç»“æ„
                    if (!data.success) {
                        throw new Error(data.message || 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
                    }
                    
                    const userProfile = data.data.user; // ä¿®å¤ï¼šä½¿ç”¨ data.data.user

                    if (!userProfile) {
                        throw new Error('ç”¨æˆ·ä¿¡æ¯ä¸å­˜åœ¨');
                    }

                    console.log('âœ… ç”¨æˆ·ä¿¡æ¯åŠ è½½æˆåŠŸ:', userProfile);

                    // æ›´æ–°é¡µé¢æ˜¾ç¤º
                    document.querySelector('#profile-nickname').textContent = userProfile.nickname || 'æœªè®¾ç½®';
                    document.querySelector('#profile-username').textContent = '@' + (userProfile.username || '');
                    document.querySelector('#profile-phone').value = userProfile.phone_number || '';
                    document.querySelector('#edit-nickname').value = userProfile.nickname || '';

                    // å¤„ç†ç”Ÿæ—¥å­—æ®µ
                    let dateOfBirth = userProfile.date_of_birth || null;
                    if (!dateOfBirth && data.data.tags && data.data.tags.basic) {
                        const birthdayTag = data.data.tags.basic.find(tag => tag.tag_key === 'date_of_birth');
                        if (birthdayTag && birthdayTag.tag_value) {
                            dateOfBirth = birthdayTag.tag_value;
                        }
                    }
                    document.querySelector('#edit-birthday').value = dateOfBirth || '';

                    // å¦‚æœæœ‰ç»Ÿè®¡ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥æ˜¾ç¤ºï¼ˆå¯é€‰ï¼‰
                    if (data.data.stats) {
                        console.log('ğŸ“Š ç”¨æˆ·ç»Ÿè®¡:', data.data.stats);
                    }
                    
                } catch (error) {
                    console.error('âŒ åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                    document.querySelector('#profile-nickname').textContent = 'åŠ è½½å¤±è´¥';
                }
            }
            
            // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
            saveProfileBtn.addEventListener('click', async function() {
                try {
                    if (!API_TOKEN) {
                        alert('æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•');
                        return;
                    }
                    
                    const nickname = document.querySelector('#edit-nickname').value.trim();
                    const birthday = document.querySelector('#edit-birthday').value;
                    
                    if (!nickname) {
                        alert('æ˜µç§°ä¸èƒ½ä¸ºç©º');
                        return;
                    }
                    
                    console.log('ğŸ’¾ ä¿å­˜ç”¨æˆ·ä¿¡æ¯...');

                    // è°ƒç”¨åç«¯APIæ›´æ–°ç”¨æˆ·ä¿¡æ¯
                    try {

                        // è·å–ç”¨æˆ·ID
                        let userId = null;
                        try {
                            const token = AppConfig.getToken();
                            if (token) {
                                const payload = JSON.parse(atob(token.split('.')[1]));
                                userId = payload.user_id;
                            }
                        } catch (e) {
                            console.error('è§£ætokenå¤±è´¥:', e);
                        }

                        if (!userId) {
                            throw new Error('æ— æ³•è·å–ç”¨æˆ·ID');
                        }

                        const response = await fetch(`${AppConfig.getApiUrl(`/api/users/${userId}`)}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${API_TOKEN}`
                            },
                            credentials: 'include',
                            body: JSON.stringify({
                                nickname: nickname,
                                date_of_birth: birthday
                            })
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.message || 'ä¿å­˜å¤±è´¥');
                        }

                        const result = await response.json();
                        console.log('âœ… ä¸ªäººä¿¡æ¯æ›´æ–°æˆåŠŸ:', result);

                        // æ›´æ–°æœ¬åœ°æ˜¾ç¤º
                        document.querySelector('#profile-nickname').textContent = nickname;

                        // æ˜¾ç¤ºæˆåŠŸæç¤º
                        saveProfileBtn.innerHTML = '<i class="fas fa-check mr-2"></i>ä¿å­˜æˆåŠŸ';
                        saveProfileBtn.classList.add('bg-green-500');

                        setTimeout(() => {
                            saveProfileBtn.innerHTML = '<i class="fas fa-save mr-2"></i>ä¿å­˜ä¿®æ”¹';
                            saveProfileBtn.classList.remove('bg-green-500');
                        }, 2000);

                    } catch (error) {
                        console.error('âŒ ä¿å­˜ä¸ªäººä¿¡æ¯å¤±è´¥:', error);
                        alert('ä¿å­˜å¤±è´¥: ' + error.message);
                        // æ¢å¤åŸå€¼
                        document.querySelector('#edit-nickname').value = document.querySelector('#profile-nickname').textContent;
                        document.querySelector('#edit-birthday').value = localStorage.getItem('user_birthday') || '';
                    }
                    
                    console.log('âœ… ç”¨æˆ·ä¿¡æ¯ä¿å­˜æˆåŠŸ');
                    
                } catch (error) {
                    console.error('âŒ ä¿å­˜ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                    alert('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            });
            
            // é€€å‡ºç™»å½•
            // æ‰“å¡è®°å½•æŒ‰é’®
            const checkinLinkBtn = document.querySelector('#checkin-link-btn');
            if (checkinLinkBtn) {
                checkinLinkBtn.addEventListener('click', function() {
                    openCheckinModal();
                });
            }

            logoutBtn.addEventListener('click', function() {
                if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                    // æ¸…é™¤æ‰€æœ‰ç¼“å­˜æ•°æ®
                    AppConfig.clearToken();
                    localStorage.removeItem(AppConfig.STORAGE_KEYS.USER_ID);
                    localStorage.removeItem(AppConfig.STORAGE_KEYS.USERNAME);
                    localStorage.removeItem('nickname');
                    // æ¸…é™¤ç”¨æˆ·ç›¸å…³çš„conversation_id
                    if (cachedUserId) {
                        const userKey = `${AppConfig.STORAGE_KEYS.CONVERSATION_ID}_${cachedUserId}`;
                        localStorage.removeItem(userKey);
                    }
                    // å…¼å®¹æ—§ç‰ˆæœ¬ï¼Œæ¸…é™¤å…¨å±€çš„conversation_id
                    localStorage.removeItem(AppConfig.STORAGE_KEYS.CONVERSATION_ID);
                    localStorage.removeItem('checkinData');
                    // æ¸…é™¤TTSçŠ¶æ€
                    localStorage.removeItem('ttsEnabled');

                    // æ¸…ç©ºå˜é‡
                    cachedUserId = null;
                    conversationId = null;

                    console.log('ğŸ‘‹ å·²é€€å‡ºç™»å½•å¹¶æ¸…é™¤æ‰€æœ‰ç¼“å­˜æ•°æ®');

                    // è·³è½¬åˆ°ç™»å½•é¡µé¢
                    AppConfig.navigate('/login');
                }
            });

            // ğŸ”¥ é—®é¢˜2ï¼šç¦æ­¢è¾“å…¥æ¡†è‡ªåŠ¨èšç„¦å’Œè‡ªåŠ¨è°ƒæ•´é«˜åº¦
            // ç§»é™¤è‡ªåŠ¨èšç„¦é€»è¾‘
            
            // æ–‡æœ¬è¾“å…¥æ¡†æ‰‹åŠ¨è°ƒæ•´é«˜åº¦ï¼ˆä¿æŒå›ºå®šå®½åº¦ï¼‰
            messageInput.addEventListener('input', function() {
                // ä¿æŒå›ºå®šå°ºå¯¸ï¼Œä¸å†è‡ªåŠ¨è°ƒæ•´é«˜åº¦
                // this.style.height = 'auto';
                // this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                
                // å‘é€æŒ‰é’®å§‹ç»ˆæ˜¾ç¤º
                sendBtn.style.display = 'flex';
            });

            // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
            function showToast(message, type = 'info') {
                // åˆ›å»ºæç¤ºå…ƒç´ 
                const toast = document.createElement('div');
                toast.className = `fixed top-20 left-1/2 transform -translate-x-1/2 z-50 px-4 py-2 rounded-lg shadow-lg text-sm font-medium ${
                    type === 'success' ? 'bg-green-500 text-white' :
                    type === 'error' ? 'bg-red-500 text-white' :
                    type === 'warning' ? 'bg-yellow-500 text-white' :
                    'bg-blue-500 text-white'
                }`;
                toast.textContent = message;
                
                document.body.appendChild(toast);
                
                // 3ç§’åè‡ªåŠ¨ç§»é™¤
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transition = 'opacity 0.3s';
                    setTimeout(() => {
                        document.body.removeChild(toast);
                    }, 300);
                }, 3000);
            }



            // è§£é”éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼ˆè§£å†³æµè§ˆå™¨è‡ªåŠ¨æ’­æ”¾é™åˆ¶ï¼‰
            async function unlockAudioContext() {
                try {
                    // ğŸ”¥ ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šä½¿ç”¨ç»Ÿä¸€çš„ ttsAudio å°è¯•è§£é”
                    if (!window.ttsAudio) {
                        window.ttsAudio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=');
                    }
                    window.ttsAudio.src = 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=';
                    window.ttsAudio.volume = 0.01;
                    
                    // è®¾ç½®éŸ³é¢‘å±æ€§ä»¥å…¼å®¹ç§»åŠ¨ç«¯
                    window.ttsAudio.muted = false;
                    window.ttsAudio.autoplay = false;
                    window.ttsAudio.preload = 'auto';
                    
                    const playPromise = window.ttsAudio.play();
                    if (playPromise !== undefined) {
                        try {
                            await playPromise;
                            window.ttsAudio.pause();
                            window.ttsAudio.currentTime = 0;
                            return true;
                        } catch (err) {
                            // ç§»åŠ¨ç«¯å¯èƒ½å¤±è´¥ï¼Œä½†ä¸é˜»æ­¢åç»­æµç¨‹
                            return false;
                        }
                    }
                    return true;
                } catch (error) {
                    return false;
                }
            }

            // å‘é€æ¶ˆæ¯
            function sendMessage() {
                const message = messageInput.value.trim();
                if (!message) return;

                // ğŸ”¥ é—®é¢˜1&2ï¼šåœæ­¢æ‰€æœ‰TTSæ’­æ”¾ï¼ˆåŒ…æ‹¬é˜Ÿåˆ—ï¼‰å’Œä¸­æ–­æµå¼å“åº”
                stopAllTTSPlayback(); // åœæ­¢æ‰€æœ‰æ­£åœ¨æ’­æ”¾å’Œé˜Ÿåˆ—ä¸­çš„TTS
                abortCurrentStreaming(); // ä¸­æ–­æ­£åœ¨è¿›è¡Œçš„æµå¼å“åº”

                // å¦‚æœTTSå¼€å¯ï¼Œå…ˆè§£é”éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼ˆè§£å†³æµè§ˆå™¨è‡ªåŠ¨æ’­æ”¾é™åˆ¶ï¼‰
                if (ttsEnabled) {
                    // unlockAudioContext();
                }

                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                addUserMessage(message);

                // æ¸…ç©ºè¾“å…¥æ¡†
                messageInput.value = '';
                messageInput.style.height = 'auto';

                // æ£€æµ‹æ˜¯å¦æ˜¯æ‰“å¡æŒ‡ä»¤
                if (message === 'æ‰“å¡' || message.includes('æ‰“å¡')) {
                    handleCheckin();
                    return;
                }

                // æ˜¾ç¤ºAIæ­£åœ¨è¾“å…¥
                showTypingIndicator();

                // è°ƒç”¨åç«¯æµå¼æ¥å£
                sendMessageToAPI(message);
            }
            
            // ä¸­æ–­å½“å‰æµå¼å“åº”
            function abortCurrentStreaming() {
                if (currentStreamingController) {
                    console.log('ğŸ›‘ ä¸­æ–­å½“å‰æµå¼å“åº”');
                    currentStreamingController.abort();
                    currentStreamingController = null;
                    isStreamingResponse = false;
                }
            }

            // è°ƒç”¨åç«¯APIå‘é€æ¶ˆæ¯ï¼ˆæµå¼ï¼‰
            async function sendMessageToAPI(message) {
                try {
                    // æ£€æŸ¥æ˜¯å¦æœ‰token
                    if (!API_TOKEN) {
                        console.error('æœªæ‰¾åˆ°API Tokenï¼Œè¯·å…ˆç™»å½•');
                        hideTypingIndicator();
                        addAIMessage('æŠ±æ­‰ï¼Œæ‚¨éœ€è¦å…ˆç™»å½•æ‰èƒ½ä½¿ç”¨å¯¹è¯åŠŸèƒ½ã€‚');
                        return;
                    }

                    // åˆ›å»ºAbortControllerç”¨äºä¸­æ–­è¯·æ±‚
                    currentStreamingController = new AbortController();
                    isStreamingResponse = true;

                    // å‡†å¤‡è¯·æ±‚æ•°æ®
                    const requestData = {
                        user_id: cachedUserId,  // æ·»åŠ ç”¨æˆ·ID
                        message_content: message,
                        enable_tts: ttsEnabled  // æ ¹æ®TTSå¼€å…³çŠ¶æ€å†³å®šæ˜¯å¦å¯ç”¨
                    };

                    // å¦‚æœæœ‰ä¼šè¯IDï¼Œæ·»åŠ åˆ°è¯·æ±‚ä¸­ï¼ˆé‡è¦ï¼šç”¨äºä¿æŒä¸Šä¸‹æ–‡ï¼‰
                    if (conversationId) {
                        requestData.conversation_id = conversationId;
                        console.log('ğŸ“ ä½¿ç”¨å·²æœ‰ä¼šè¯ID:', conversationId);
                    } else {
                        console.log('ğŸ†• é¦–æ¬¡å¯¹è¯ï¼Œç­‰å¾…æœåŠ¡å™¨è¿”å›conversation_id');
                    }

                    console.log('ğŸ“¤ å‘é€è¯·æ±‚:', requestData);
                    console.log('ğŸ”Š TTSçŠ¶æ€:', ttsEnabled ? 'å¯ç”¨' : 'ç¦ç”¨');
                    console.log('   ğŸ”‘ API_TOKEN =', API_TOKEN ? API_TOKEN.substring(0, 50) + '...' : 'ç©º');
                    console.log('   ğŸ‘¤ cachedUserId =', cachedUserId || 'ç©º');

                    // åˆ›å»ºAIæ¶ˆæ¯å…ƒç´ ï¼ˆç”¨äºæµå¼æ›´æ–°ï¼‰
                    currentAIMessageElement = createAIMessageElementForStreaming();
                    let aiMessageContent = '';

                    // ä½¿ç”¨fetchè¿›è¡Œæµå¼è¯·æ±‚ï¼ˆä½¿ç”¨å¸¦TTSçš„æ–°ç«¯ç‚¹ï¼‰
                    const response = await fetch(`${AppConfig.getApiUrl('/api/chat/stream_with_tts')}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${API_TOKEN}`
                        },
                        credentials: 'include',
                        body: JSON.stringify(requestData),
                        signal: currentStreamingController.signal // æ·»åŠ ä¸­æ–­ä¿¡å·
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    // è¯»å–æµå¼å“åº”
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    
                    let currentEvent = null; // ğŸ”‘ æŒä¹…åŒ–çš„äº‹ä»¶ç±»å‹çŠ¶æ€
                    let buffer = ''; // ğŸ”‘ ç¼“å†²åŒºï¼Œç”¨äºå¤„ç†è·¨chunkçš„ä¸å®Œæ•´è¡Œ
                    let hasReceivedAudio = false; // æ ‡è®°æ˜¯å¦åœ¨æµå¼è¿‡ç¨‹ä¸­æ”¶åˆ°äº†éŸ³é¢‘
                    let hasReceivedFollowUp = false; // æ ‡è®°æ˜¯å¦æ”¶åˆ°äº†follow_upäº‹ä»¶
                    let shouldBreak = false; // æ ‡è®°æ˜¯å¦åº”è¯¥ç»“æŸå¾ªç¯

                    // ğŸ”¥ ç§»åŠ¨ç«¯TTSä¼˜åŒ–ï¼šåœ¨å¼€å§‹æµå¼å“åº”æ—¶é‡ç½®ç»Ÿè®¡ä¿¡æ¯
                    streamingAudioStats = {
                        totalReceived: 0,
                        successfullyPlayed: 0,
                        failedCount: 0,
                        lastActivityTime: 0
                    };
                    
                    while (true) {
                        const {done, value} = await reader.read();
                        
                        if (done || shouldBreak) {
                            console.log('âœ… æµå¼å“åº”å®Œæˆ');
                            break;
                        }
                        
                        // è§£ç æ•°æ®å¹¶è¿½åŠ åˆ°ç¼“å†²åŒº
                        buffer += decoder.decode(value, {stream: true});
                        
                        // æŒ‰è¡Œåˆ†å‰²ï¼ˆä¿ç•™å®Œæ•´çš„è¡Œï¼‰
                        const lines = buffer.split('\n');
                        
                        // æœ€åä¸€è¡Œå¯èƒ½ä¸å®Œæ•´ï¼Œä¿ç•™åœ¨ç¼“å†²åŒº
                        buffer = lines.pop() || '';
                        
                        for (const line of lines) {
                            const trimmedLine = line.trim();
                            
                            // è·³è¿‡ç©ºè¡Œ
                            if (!trimmedLine) {
                                continue;
                            }
                            
                            if (line.startsWith('event:')) {
                                currentEvent = line.substring(6).trim();
                                console.log('ğŸ“¨ äº‹ä»¶:', currentEvent);
                            } else if (line.startsWith('data:')) {
                                try {
                                    const dataStr = line.substring(5).trim();
                                    if (!dataStr || dataStr === '[DONE]') continue;
                                    
                                    const data = JSON.parse(dataStr);
                                    
                                    // ä¼˜å…ˆå¤„ç†audioäº‹ä»¶ï¼ˆTTSéŸ³é¢‘ï¼‰
                                    if (currentEvent === 'audio' && data.audio) {
                                        console.log('ğŸµ æ”¶åˆ°éŸ³é¢‘:', data.sentence);
                                        hasReceivedAudio = true;
                                        playAudioFromBase64(data.audio);
                                        continue;
                                    }
                                    
                                    // ä¿å­˜conversation_idï¼ˆé‡è¦ï¼šç¡®ä¿æ¯æ¬¡æ”¶åˆ°éƒ½æ›´æ–°ï¼‰
                                    if (data.conversation_id) {
                                        conversationId = data.conversation_id;
                                        setUserConversationId(conversationId);
                                        console.log(`ğŸ’¾ ä¿å­˜ç”¨æˆ· ${cachedUserId} çš„conversation_id:`, conversationId);
                                    } else if (data.conversation_id === null) {
                                        // å¦‚æœæ”¶åˆ°nullï¼Œè¯´æ˜å¯èƒ½æ˜¯é¦–æ¬¡å¯¹è¯ï¼Œç­‰å¾…åç»­äº‹ä»¶
                                        console.log('â³ æ”¶åˆ°conversation_idä¸ºnullï¼Œç­‰å¾…åç»­äº‹ä»¶...');
                                    }
                                    
                                    // å¤„ç†æ¶ˆæ¯å¢é‡ï¼ˆAIå›å¤ï¼‰
                                    if (currentEvent === 'conversation.message.delta' && data.content) {
                                        aiMessageContent += data.content;
                                        updateAIMessage(currentAIMessageElement, aiMessageContent);
                                    }
                                    // å¤„ç†åç»­é—®é¢˜äº‹ä»¶ï¼ˆfollow_upï¼‰
                                    else if (currentEvent === 'conversation.message.follow_up') {
                                        console.log('âœ… æ”¶åˆ°follow_upäº‹ä»¶ï¼ŒAIå›å¤å®Œæˆ:', data.content);
                                        hasReceivedFollowUp = true;
                                        // æ ‡è®°åº”è¯¥ç»“æŸå¾ªç¯
                                        shouldBreak = true;
                                        // å¦‚æœTTSå¼€å¯ï¼Œç«‹å³è°ƒç”¨TTSåˆæˆ
                                        if (ttsEnabled && aiMessageContent) {
                                            console.log('ğŸ”Š æ”¶åˆ°follow_upï¼ŒTTSå¼€å¯ï¼Œç«‹å³è°ƒç”¨TTSåˆæˆ');
                                            // ä¸ç­‰å¾…ï¼Œå¼‚æ­¥è°ƒç”¨TTS
                                            playTextToSpeechFromAPI(aiMessageContent).catch(err => {
                                                console.error('âŒ TTSæ’­æŠ¥å¤±è´¥:', err);
                                            });
                                        } else if (!ttsEnabled) {
                                            console.log('ğŸ”‡ TTSæœªå¼€å¯ï¼Œç»“æŸç­‰å¾…ï¼Œç­‰ç”¨æˆ·ä¸‹æ¬¡è¯´è¯');
                                        }
                                        // ç«‹å³é€€å‡ºå†…å±‚å¾ªç¯ï¼Œå¤–å±‚å¾ªç¯ä¼šåœ¨ä¸‹æ¬¡readæ—¶æ£€æŸ¥shouldBreakå¹¶é€€å‡º
                                        break;
                                    }
                                    // å¤„ç†å®Œæˆäº‹ä»¶
                                    else if (currentEvent === 'conversation.chat.completed') {
                                        console.log('âœ… å¯¹è¯å®Œæˆ');
                                    }
                                    
                                } catch (e) {
                                    console.error('âŒ è§£æSSEæ•°æ®å¤±è´¥:', e, 'Line:', line);
                                }
                            }
                        }
                    }
                    
                    // é‡ç½®æµå¼å“åº”çŠ¶æ€
                    isStreamingResponse = false;
                    currentStreamingController = null;

                    // éšè—è¾“å…¥æŒ‡ç¤ºå™¨
                    hideTypingIndicator();

                    // å¦‚æœæ²¡æœ‰æ”¶åˆ°ä»»ä½•å†…å®¹ï¼Œæ˜¾ç¤ºé»˜è®¤æ¶ˆæ¯
                    if (!aiMessageContent) {
                        updateAIMessage(currentAIMessageElement, 'æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•å›ç­”æ‚¨çš„é—®é¢˜ã€‚');
                    }
                    
                    // å¦‚æœå·²ç»æ”¶åˆ°follow_upäº‹ä»¶ï¼ŒTTSå·²ç»åœ¨æ”¶åˆ°æ—¶è°ƒç”¨äº†ï¼Œè¿™é‡Œä¸å†é‡å¤è°ƒç”¨
                    if (hasReceivedFollowUp) {
                        console.log('âœ… å·²æ”¶åˆ°follow_upäº‹ä»¶ï¼ŒTTSå·²åœ¨æ”¶åˆ°æ—¶è°ƒç”¨ï¼Œæ— éœ€é‡å¤');
                    }
                    // å¦‚æœæ²¡æœ‰æ”¶åˆ°follow_upï¼ŒæŒ‰åŸæ¥çš„é€»è¾‘å¤„ç†TTS
                    else if (ttsEnabled && !hasReceivedAudio && aiMessageContent) {
                        console.log('ğŸ”Š TTSå¼€å¯ä½†æœªæ”¶åˆ°æµå¼éŸ³é¢‘ï¼Œè°ƒç”¨TTSæ¥å£è¿›è¡Œå®Œæ•´æ’­æŠ¥');
                        console.log('ğŸ“ AIæ¶ˆæ¯å†…å®¹:', aiMessageContent.substring(0, 100) + '...');
                        try {
                            await playTextToSpeechFromAPI(aiMessageContent);
                        } catch (error) {
                            console.error('âŒ TTSæ’­æŠ¥å¤±è´¥:', error);
                        }
                    } else if (ttsEnabled && hasReceivedAudio) {
                        console.log('âœ… å·²åœ¨æµå¼è¿‡ç¨‹ä¸­æ”¶åˆ°éŸ³é¢‘ï¼Œæ— éœ€é¢å¤–TTS');

                        // ğŸ”¥ ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šåŸºäºæ’­æ”¾ç»Ÿè®¡æ™ºèƒ½å¯ç”¨å¤‡ç”¨TTS
                        if (DeviceUtils.isMobile() && aiMessageContent) {
                            // å»¶è¿Ÿæ£€æŸ¥ï¼Œç¡®ä¿æµå¼éŸ³é¢‘æœ‰æ—¶é—´æ’­æ”¾å®Œæˆ
                            setTimeout(() => {
                                const now = Date.now();
                                const timeSinceLastActivity = now - streamingAudioStats.lastActivityTime;
                                const successRate = streamingAudioStats.totalReceived > 0 ?
                                    streamingAudioStats.successfullyPlayed / streamingAudioStats.totalReceived : 0;

                                const hasActivePlayback = AudioManager.currentType === AudioManager.states.AUTO_TTS ||
                                                         isPlayingAudio ||
                                                         audioQueue.length > 0;

                                console.log('ğŸ“Š ç§»åŠ¨ç«¯TTSç»Ÿè®¡:', {
                                    totalReceived: streamingAudioStats.totalReceived,
                                    successfullyPlayed: streamingAudioStats.successfullyPlayed,
                                    failedCount: streamingAudioStats.failedCount,
                                    successRate: (successRate * 100).toFixed(1) + '%',
                                    timeSinceLastActivity: timeSinceLastActivity + 'ms',
                                    hasActivePlayback: hasActivePlayback
                                });

                                // åˆ¤æ–­æ˜¯å¦éœ€è¦å¯ç”¨å¤‡ç”¨TTSçš„æ¡ä»¶ï¼š
                                // 1. æ²¡æœ‰æ´»è·ƒçš„æ’­æ”¾çŠ¶æ€
                                // 2. è·ç¦»æœ€åéŸ³é¢‘æ´»åŠ¨å·²ç»è¶…è¿‡2ç§’
                                // 3. æˆåŠŸç‡ä½äº80% æˆ– æ”¶åˆ°éŸ³é¢‘ç‰‡æ®µè¾ƒå°‘
                                const shouldFallback = !hasActivePlayback &&
                                                      timeSinceLastActivity > 2000 &&
                                                      (successRate < 0.8 || streamingAudioStats.totalReceived < 2);

                                if (shouldFallback) {
                                    console.log('ğŸ“± ç§»åŠ¨ç«¯æ£€æµ‹åˆ°æµå¼éŸ³é¢‘æ’­æ”¾ä¸å®Œæ•´ï¼Œå¯ç”¨å¤‡ç”¨TTS');
                                    // é‡ç½®ç»Ÿè®¡ä¿¡æ¯ä¸ºä¸‹æ¬¡å¯¹è¯åšå‡†å¤‡
                                    streamingAudioStats = {
                                        totalReceived: 0,
                                        successfullyPlayed: 0,
                                        failedCount: 0,
                                        lastActivityTime: 0
                                    };

                                    // è°ƒç”¨å®Œæ•´TTS
                                    playTextToSpeechFromAPI(aiMessageContent).catch(err => {
                                        console.error('âŒ ç§»åŠ¨ç«¯å¤‡ç”¨TTSæ’­æŠ¥å¤±è´¥:', err);
                                    });
                                } else {
                                    console.log('ğŸ“± ç§»åŠ¨ç«¯æµå¼éŸ³é¢‘æ’­æ”¾æ­£å¸¸ï¼Œæ— éœ€å¤‡ç”¨TTS');
                                    // æ’­æ”¾å®Œæˆåé‡ç½®ç»Ÿè®¡ä¿¡æ¯
                                    streamingAudioStats = {
                                        totalReceived: 0,
                                        successfullyPlayed: 0,
                                        failedCount: 0,
                                        lastActivityTime: 0
                                    };
                                }
                            }, 2500); // 2.5ç§’åæ£€æŸ¥ï¼Œç»™æµå¼æ’­æ”¾æ›´å¤šæ—¶é—´
                        } else {
                            // éç§»åŠ¨ç«¯ï¼šç«‹å³é‡ç½®ç»Ÿè®¡ä¿¡æ¯
                            streamingAudioStats = {
                                totalReceived: 0,
                                successfullyPlayed: 0,
                                failedCount: 0,
                                lastActivityTime: 0
                            };
                        }
                    } else if (!ttsEnabled) {
                        console.log('ğŸ”‡ TTSæœªå¼€å¯ï¼Œè·³è¿‡è¯­éŸ³æ’­æŠ¥');
                    } else if (!aiMessageContent) {
                        console.log('âš ï¸ AIæ¶ˆæ¯å†…å®¹ä¸ºç©ºï¼Œè·³è¿‡TTS');
                    }
                    
                } catch (error) {
                    // å¦‚æœæ˜¯è¢«ä¸­æ–­çš„è¯·æ±‚ï¼Œä¸æ˜¾ç¤ºé”™è¯¯
                    if (error.name === 'AbortError') {
                        console.log('â„¹ï¸ æµå¼è¯·æ±‚è¢«ç”¨æˆ·ä¸­æ–­');
                        return;
                    }

                    // é‡ç½®æµå¼å“åº”çŠ¶æ€
                    isStreamingResponse = false;
                    currentStreamingController = null;

                    console.error('âŒ å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                    hideTypingIndicator();

                    // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                    if (currentAIMessageElement) {
                        updateAIMessage(currentAIMessageElement, 'æŠ±æ­‰ï¼Œå‘é€æ¶ˆæ¯æ—¶å‡ºç°é”™è¯¯ã€‚è¯·ç¨åé‡è¯•ã€‚');
                    } else {
                        addAIMessage('æŠ±æ­‰ï¼Œå‘é€æ¶ˆæ¯æ—¶å‡ºç°é”™è¯¯ã€‚è¯·ç¨åé‡è¯•ã€‚');
                    }
                }
            }
            
            // åˆ›å»ºç”¨æˆ·æ¶ˆæ¯å…ƒç´ ï¼ˆç”¨äºå†å²æ¶ˆæ¯æ˜¾ç¤ºï¼‰
            function createUserMessageElement(message, timestamp = new Date()) {
                messageCount++;
                const messageElement = document.createElement('div');
                messageElement.id = `message-user-${messageCount}`;
                messageElement.className = 'flex items-start space-x-3 justify-end mb-6';

                // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸ºHTMLæ¢è¡Œæ ‡ç­¾ï¼ˆç”¨æˆ·æ¶ˆæ¯é€šå¸¸ä¸éœ€è¦markdownæ¸²æŸ“ï¼‰
                const formattedMessage = message.replace(/\n/g, '<br>');

                messageElement.innerHTML = `
                    <div class="message-bubble-user p-3 max-w-xs">
                        <p class="text-white text-lg">${formattedMessage}</p>
                        <div class="flex items-center justify-end mt-2">
                            <span class="text-blue-100 text-xs">${formatMessageTime(timestamp)}</span>
                        </div>
                    </div>
                    <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0">
                        <img src="https://s.coze.cn/image/es6fUICmNgw/"
                             alt="ç”¨æˆ·å¤´åƒ"
                             data-category="äººç‰©"
                             class="w-full h-full object-cover">
                    </div>
                `;
                return messageElement;
            }

            // åˆ›å»ºAIæ¶ˆæ¯å…ƒç´ ï¼ˆç”¨äºå†å²æ¶ˆæ¯æ˜¾ç¤ºï¼‰
            function createAIMessageElement(message, timestamp = new Date()) {
                messageCount++;
                const messageElement = document.createElement('div');
                messageElement.id = `message-ai-${messageCount}`;
                messageElement.className = 'flex items-start space-x-3 mb-6';

                // ä½¿ç”¨marked.jsæ¸²æŸ“Markdownä¸ºHTML
                let formattedMessage = message;
                if (typeof marked !== 'undefined') {
                    try {
                        // é…ç½®markedé€‰é¡¹
                        marked.setOptions({
                            breaks: true,        // æ”¯æŒGitHubé£æ ¼çš„æ¢è¡Œ
                            gfm: true,          // å¯ç”¨GitHubé£æ ¼çš„Markdown
                            headerIds: false,   // ç¦ç”¨æ ‡é¢˜ID
                            mangle: false       // ç¦ç”¨é‚®ç®±æ··æ·†
                        });

                        // å°†Markdownè½¬æ¢ä¸ºHTML
                        formattedMessage = marked.parse(message);
                    } catch (e) {
                        console.error('âŒ Markdownæ¸²æŸ“å¤±è´¥:', e);
                        // å¦‚æœæ¸²æŸ“å¤±è´¥ï¼Œå›é€€åˆ°çº¯æ–‡æœ¬
                        formattedMessage = message.replace(/\n/g, '<br>');
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰markedåº“ï¼Œå›é€€åˆ°çº¯æ–‡æœ¬
                    formattedMessage = message.replace(/\n/g, '<br>');
                }

                // è·å–å½“å‰æœºå™¨äººå¤´åƒ
                const currentRobot = RobotConfig.getCurrentRobot();

                messageElement.innerHTML = `
                    <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0">
                        <img src="${currentRobot.avatar}" alt="${currentRobot.name}" class="w-full h-full object-cover">
                    </div>
                    <div class="message-bubble-ai p-3 max-w-xs">
                        <p class="text-gray-800 text-lg markdown-content">${formattedMessage}</p>
                        <div class="flex items-center justify-between mt-2">
                            <button class="tts-play-btn flex items-center space-x-1 text-gray-500 hover:text-blue-500 transition-colors text-sm" data-message-id="${messageCount}" data-message-text="${message.replace(/"/g, '&quot;')}">
                                <i class="fas fa-volume-up"></i>
                                <span>æ’­æ”¾</span>
                            </button>
                            <span class="text-gray-400 text-xs">${formatMessageTime(timestamp)}</span>
                        </div>
                    </div>
                `;

                // éªŒè¯æ’­æ”¾æŒ‰é’®ç»“æ„æ˜¯å¦æ­£ç¡®åˆ›å»º
                setTimeout(() => {
                    const playBtn = messageElement.querySelector('.tts-play-btn');
                    if (playBtn) {
                        const icon = playBtn.querySelector('i');
                        const text = playBtn.querySelector('span');
                        if (!icon || !text) {
                            console.warn('âš ï¸ å†å²æ¶ˆæ¯æ’­æ”¾æŒ‰é’®ç»“æ„åˆ›å»ºå¤±è´¥ï¼Œæ­£åœ¨ä¿®å¤...');
                            playBtn.innerHTML = '<i class="fas fa-volume-up"></i><span>æ’­æ”¾</span>';
                        }
                    }
                }, 10);
                return messageElement;
            }

            // åˆ›å»ºAIæ¶ˆæ¯å…ƒç´ ï¼ˆç”¨äºæµå¼æ›´æ–°ï¼‰
            function createAIMessageElementForStreaming(timestamp = new Date()) {
                messageCount++;
                const messageElement = document.createElement('div');
                messageElement.id = `message-ai-${messageCount}`;
                messageElement.className = 'flex items-start space-x-3 mb-6';

                // è·å–å½“å‰æœºå™¨äººå¤´åƒ
                const currentRobot = RobotConfig.getCurrentRobot();

                messageElement.innerHTML = `
                    <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0">
                        <img src="${currentRobot.avatar}" alt="${currentRobot.name}" class="w-full h-full object-cover">
                    </div>
                    <div class="message-bubble-ai p-3 max-w-xs">
                        <p class="text-gray-800 text-base" id="ai-content-${messageCount}"></p>
                        <div class="flex items-center justify-between mt-2">
                            <button class="tts-play-btn flex items-center space-x-1 text-gray-500 hover:text-blue-500 transition-colors text-sm" data-message-id="${messageCount}" data-message-text="">
                                <i class="fas fa-volume-up"></i>
                                <span>æ’­æ”¾</span>
                            </button>
                            <span class="text-gray-400 text-xs">${formatMessageTime(timestamp)}</span>
                        </div>
                    </div>
                `;
                chatMessages.appendChild(messageElement);

                // éªŒè¯æ’­æ”¾æŒ‰é’®ç»“æ„æ˜¯å¦æ­£ç¡®åˆ›å»º
                setTimeout(() => {
                    const playBtn = messageElement.querySelector('.tts-play-btn');
                    if (playBtn) {
                        const icon = playBtn.querySelector('i');
                        const text = playBtn.querySelector('span');
                        if (!icon || !text) {
                            console.warn('âš ï¸ æµå¼æ¶ˆæ¯æ’­æ”¾æŒ‰é’®ç»“æ„åˆ›å»ºå¤±è´¥ï¼Œæ­£åœ¨ä¿®å¤...');
                            playBtn.innerHTML = '<i class="fas fa-volume-up"></i><span>æ’­æ”¾</span>';
                        }
                    }
                }, 10);

                scrollToBottom();
                return messageElement;
            }
            
            // æ›´æ–°AIæ¶ˆæ¯å†…å®¹ï¼ˆæµå¼ï¼‰
            function updateAIMessage(messageElement, content) {
                const contentElement = messageElement.querySelector(`p[id^="ai-content-"]`);
                if (contentElement) {
                    // ä½¿ç”¨marked.jsæ¸²æŸ“Markdownä¸ºHTML
                    if (typeof marked !== 'undefined') {
                        try {
                            // é…ç½®markedé€‰é¡¹
                            marked.setOptions({
                                breaks: true,        // æ”¯æŒGitHubé£æ ¼çš„æ¢è¡Œ
                                gfm: true,          // å¯ç”¨GitHubé£æ ¼çš„Markdown
                                headerIds: false,   // ç¦ç”¨æ ‡é¢˜ID
                                mangle: false       // ç¦ç”¨é‚®ç®±æ··æ·†
                            });

                            // å°†Markdownè½¬æ¢ä¸ºHTMLå¹¶è®¾ç½®
                            const htmlContent = marked.parse(content);
                            contentElement.innerHTML = htmlContent;

                            // æ·»åŠ markdown-contentç±»ä»¥åº”ç”¨æ ·å¼
                            if (!contentElement.classList.contains('markdown-content')) {
                                contentElement.classList.add('markdown-content');
                            }
                        } catch (e) {
                            console.error('âŒ Markdownæ¸²æŸ“å¤±è´¥:', e);
                            // å¦‚æœæ¸²æŸ“å¤±è´¥ï¼Œå›é€€åˆ°çº¯æ–‡æœ¬
                            contentElement.textContent = content;
                        }
                    } else {
                        // å¦‚æœmarkedåº“æœªåŠ è½½ï¼Œä½¿ç”¨çº¯æ–‡æœ¬
                        contentElement.textContent = content;
                    }

                    // æ›´æ–°æ’­æ”¾æŒ‰é’®çš„æ–‡æœ¬æ•°æ®
                    const playBtn = messageElement.querySelector('.tts-play-btn');
                    if (playBtn) {
                        playBtn.setAttribute('data-message-text', content);
                    }

                    scrollToBottom();
                }
            }

            // ğŸµ å…¨å±€éŸ³é¢‘æ’­æ”¾ç®¡ç†å™¨
            const AudioManager = {
                // æ’­æ”¾çŠ¶æ€
                states: {
                    VOICE_INPUT: 'voice_input',     // è¯­éŸ³è¾“å…¥æ’­æ”¾
                    MESSAGE_TTS: 'message_tts',     // å•ä¸ªæ¶ˆæ¯æ’­æ”¾
                    AUTO_TTS: 'auto_tts'           // è‡ªåŠ¨TTSæ’­æŠ¥
                },

                // å½“å‰æ’­æ”¾çŠ¶æ€
                currentType: null,        // å½“å‰æ’­æ”¾ç±»å‹
                currentMessageId: null,   // å½“å‰æ’­æ”¾çš„æ¶ˆæ¯IDï¼ˆç”¨äºæ¶ˆæ¯æ’­æ”¾ï¼‰

                // è‡ªåŠ¨TTSç›¸å…³çŠ¶æ€ï¼ˆå¼•ç”¨å…¨å±€å˜é‡ï¼‰

                // æ’­æ”¾æ§åˆ¶å‡½æ•°
                startPlayback(type, messageId = null) {
                    console.log(`ğŸµ å¼€å§‹æ’­æ”¾: ç±»å‹=${type}, æ¶ˆæ¯ID=${messageId}`);

                    // å¦‚æœæ­£åœ¨æ’­æ”¾å…¶ä»–ç±»å‹çš„éŸ³é¢‘ï¼Œå…ˆåœæ­¢
                    if (this.currentType && this.currentType !== type) {
                        this.stopPlayback(this.currentType);
                    }

                    this.currentType = type;
                    if (type === this.states.MESSAGE_TTS) {
                        this.currentMessageId = messageId;
                    }

                    this.updateUI();
                },

                stopPlayback(type) {
                    console.log(`ğŸ›‘ åœæ­¢æ’­æ”¾: ç±»å‹=${type}`);

                    if (this.currentType === type) {
                        if (type === this.states.AUTO_TTS) {
                            // åœæ­¢è‡ªåŠ¨TTSæ’­æ”¾
                            this.stopAllTTSPlayback();
                        } else if (type === this.states.MESSAGE_TTS) {
                            // åœæ­¢æ¶ˆæ¯æ’­æ”¾
                            this.stopMessagePlayback();
                        } else if (type === this.states.VOICE_INPUT) {
                            // åœæ­¢è¯­éŸ³è¾“å…¥æ’­æ”¾ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                            // è¿™é‡Œå¯èƒ½éœ€è¦æ·»åŠ å…·ä½“çš„åœæ­¢é€»è¾‘
                        }

                        this.currentType = null;
                        this.currentMessageId = null;
                        this.updateUI();
                    }
                },

                stopAllPlayback() {
                    console.log('ğŸ›‘ åœæ­¢æ‰€æœ‰æ’­æ”¾');

                    this.stopAllTTSPlayback();
                    this.stopMessagePlayback();
                    this.currentType = null;
                    this.currentMessageId = null;
                    this.updateUI();
                },

                stopAllTTSPlayback() {
                    // åœæ­¢å½“å‰æ’­æ”¾çš„éŸ³é¢‘å¹¶æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
                    if (window.ttsAudio) {
                        window.ttsAudio.pause();
                        window.ttsAudio.currentTime = 0;
                        // ğŸ”¥ æ¸…ç†äº‹ä»¶ç›‘å¬å™¨å’ŒéŸ³é¢‘æºï¼Œé˜²æ­¢æ®‹ç•™
                        window.ttsAudio.onended = null;
                        window.ttsAudio.onerror = null;
                        window.ttsAudio.onloadeddata = null;
                        // é‡ç½®srcä»¥é‡Šæ”¾èµ„æº
                        const currentSrc = window.ttsAudio.src;
                        if (currentSrc && currentSrc.startsWith('blob:')) {
                            try {
                                URL.revokeObjectURL(currentSrc);
                            } catch (e) {
                                // å¿½ç•¥å·²é‡Šæ”¾çš„URL
                            }
                        }
                        window.ttsAudio.src = '';
                        console.log('ğŸ›‘ å·²åœæ­¢å½“å‰æ’­æ”¾çš„éŸ³é¢‘å¹¶æ¸…ç†èµ„æº');
                    }

                    // æ¸…ç©ºéŸ³é¢‘é˜Ÿåˆ—å¹¶é‡Šæ”¾èµ„æº
                    const queueLength = audioQueue.length;
                    audioQueue.forEach(({ url }) => {
                        try {
                            URL.revokeObjectURL(url);
                        } catch (e) {
                            // å¿½ç•¥å·²é‡Šæ”¾çš„URL
                        }
                    });
                    audioQueue = [];
                    isPlayingAudio = false;
                    console.log(`ğŸ›‘ å·²æ¸…ç©ºéŸ³é¢‘é˜Ÿåˆ—ï¼Œå…±æ¸…ç† ${queueLength} ä¸ªéŸ³é¢‘`);
                },

                stopMessagePlayback() {
                    // ğŸ”¥ ä¸­æ–­æµå¼TTSè¯·æ±‚
                    if (currentMessageTTSController) {
                        console.log('ğŸ›‘ ä¸­æ–­æ¶ˆæ¯æ’­æ”¾çš„æµå¼TTSè¯·æ±‚');
                        currentMessageTTSController.abort();
                        currentMessageTTSController = null;
                    }

                    // åœæ­¢æ¶ˆæ¯æ’­æ”¾
                    if (this.currentMessageId) {
                        updatePlayButtonState(this.currentMessageId, false);
                        this.currentMessageId = null;
                    }
                },

                canStartPlayback(type, messageId = null) {
                    // æ£€æŸ¥æ˜¯å¦å¯ä»¥å¼€å§‹æŒ‡å®šç±»å‹çš„æ’­æ”¾
                    if (!this.currentType) return true;

                    // å¦‚æœæ˜¯åŒä¸€ç±»å‹çš„æ’­æ”¾
                    if (this.currentType === type) {
                        if (type === this.states.MESSAGE_TTS) {
                            // åŒä¸€æ¶ˆæ¯çš„æ’­æ”¾å¯ä»¥åœæ­¢
                            return this.currentMessageId === messageId;
                        }
                        return false;
                    }

                    // ä¸åŒç±»å‹çš„æ’­æ”¾ï¼Œéœ€è¦æ£€æŸ¥ä¼˜å…ˆçº§
                    // VOICE_INPUT > MESSAGE_TTS > AUTO_TTS
                    const priority = {
                        [this.states.VOICE_INPUT]: 3,
                        [this.states.MESSAGE_TTS]: 2,
                        [this.states.AUTO_TTS]: 1
                    };

                    return priority[type] >= priority[this.currentType];
                },

                updateUI() {
                    // æ›´æ–°UIçŠ¶æ€
                    const voiceBtn = document.querySelector('#voice-btn');
                    const ttsPlayButtons = document.querySelectorAll('.tts-play-btn');

                    // è¯­éŸ³è¾“å…¥æŒ‰é’®çŠ¶æ€ï¼šåªåœ¨å½•éŸ³æ—¶ç¦ç”¨ï¼Œå…¶ä»–æ—¶å€™éƒ½å¯ç”¨
                    // æ³¨æ„ï¼šè¿™é‡Œä¸ç›´æ¥ä¿®æ”¹è¯­éŸ³æŒ‰é’®çŠ¶æ€ï¼Œå› ä¸ºå½•éŸ³çŠ¶æ€ç”±å…¶ä»–åœ°æ–¹ç®¡ç†

                    // æ ¹æ®å½“å‰æ’­æ”¾çŠ¶æ€æ›´æ–°æ’­æ”¾æŒ‰é’®å¯ç”¨æ€§
                    if (this.currentType === this.states.MESSAGE_TTS) {
                        // æ¶ˆæ¯æ’­æ”¾ä¸­ï¼Œå…¶ä»–æ¶ˆæ¯æ’­æ”¾æŒ‰é’®ä¿æŒå¯ç”¨
                        ttsPlayButtons.forEach(btn => {
                            const btnMessageId = parseInt(btn.getAttribute('data-message-id'));
                            if (btnMessageId !== this.currentMessageId) {
                                btn.style.opacity = '1';
                                btn.style.pointerEvents = 'auto';
                            }
                        });
                    } else if (this.currentType === this.states.AUTO_TTS) {
                        // è‡ªåŠ¨TTSæ’­æ”¾ä¸­ï¼Œæ‰€æœ‰æ¶ˆæ¯æ’­æ”¾æŒ‰é’®å¯ç”¨ï¼ˆå¯ä»¥æ‰“æ–­ï¼‰
                        ttsPlayButtons.forEach(btn => {
                            btn.style.opacity = '1';
                            btn.style.pointerEvents = 'auto';
                        });
                    } else {
                        // æ²¡æœ‰æ’­æ”¾ï¼Œæ¢å¤æ‰€æœ‰æ’­æ”¾æŒ‰é’®
                        ttsPlayButtons.forEach(btn => {
                            btn.style.opacity = '1';
                            btn.style.pointerEvents = 'auto';
                        });
                    }
                }
            };

            // TTSè¯­éŸ³æ’­æŠ¥åŠŸèƒ½
            // let ttsEnabled = false; // TTSå¼€å…³çŠ¶æ€ï¼Œé»˜è®¤å…³é—­ï¼ˆç”¨æˆ·å¯æ‰‹åŠ¨å¼€å¯ï¼‰
            let ttsEnabled = true;
            let isPlayingAudio = false; // æ˜¯å¦æ­£åœ¨æ’­æ”¾éŸ³é¢‘
            let audioQueue = []; // éŸ³é¢‘é˜Ÿåˆ—ï¼Œç”¨äºé¡ºåºæ’­æ”¾å¤šä¸ªéŸ³é¢‘ç‰‡æ®µ
            let isStreamingResponse = false; // æ˜¯å¦æ­£åœ¨æ¥æ”¶AIæµå¼å“åº”
            let currentStreamingController = null; // å½“å‰çš„æµå¼è¯·æ±‚æ§åˆ¶å™¨ï¼Œç”¨äºä¸­æ–­è¯·æ±‚
            let currentMessageTTSController = null; // å½“å‰æ¶ˆæ¯æ’­æ”¾çš„æµå¼è¯·æ±‚æ§åˆ¶å™¨

            // ğŸ”¥ ç§»åŠ¨ç«¯TTSä¼˜åŒ–ï¼šè·Ÿè¸ªæµå¼éŸ³é¢‘æ’­æ”¾çŠ¶æ€
            let streamingAudioStats = {
                totalReceived: 0,      // æ”¶åˆ°çš„éŸ³é¢‘ç‰‡æ®µæ€»æ•°
                successfullyPlayed: 0, // æˆåŠŸæ’­æ”¾çš„ç‰‡æ®µæ•°
                failedCount: 0,        // æ’­æ”¾å¤±è´¥çš„ç‰‡æ®µæ•°
                lastActivityTime: 0    // æœ€åæ´»åŠ¨æ—¶é—´
            };

            // æ’­æ”¾Base64ç¼–ç çš„éŸ³é¢‘æ•°æ®ï¼ˆç”¨äºæµå¼TTSï¼‰
            function playAudioFromBase64(audioBase64) {
                try {
                    // å¦‚æœTTSæœªå¯ç”¨ï¼Œç›´æ¥è¿”å›
                    if (!ttsEnabled) {
                        return;
                    }

                    // ğŸ”¥ ç§»åŠ¨ç«¯TTSä¼˜åŒ–ï¼šæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    streamingAudioStats.totalReceived++;
                    streamingAudioStats.lastActivityTime = Date.now();

                    // ğŸ”¥ ä¿®å¤ï¼šåªåœ¨ç¬¬ä¸€ä¸ªéŸ³é¢‘ç‰‡æ®µæ—¶è®¾ç½®æ’­æ”¾çŠ¶æ€ï¼Œé¿å…é‡å¤è§¦å‘åœæ­¢é€»è¾‘
                    if (!isPlayingAudio && audioQueue.length === 0) {
                    // å¦‚æœæ­£åœ¨æ’­æ”¾å…¶ä»–ç±»å‹çš„éŸ³é¢‘ï¼Œåœæ­¢å®ƒä»¬
                    if (AudioManager.currentType && AudioManager.currentType !== AudioManager.states.AUTO_TTS) {
                        console.log('ğŸµ è‡ªåŠ¨TTSæ’­æ”¾å¼€å§‹ï¼Œåœæ­¢å…¶ä»–éŸ³é¢‘æ’­æ”¾');
                        AudioManager.stopPlayback(AudioManager.currentType);
                    }
                    // æ ‡è®°å¼€å§‹è‡ªåŠ¨TTSæ’­æ”¾
                    AudioManager.startPlayback(AudioManager.states.AUTO_TTS);
                    }

                    console.log('ğŸµ æ’­æ”¾éŸ³é¢‘ç‰‡æ®µ');

                    // å°†Base64è½¬æ¢ä¸ºäºŒè¿›åˆ¶æ•°æ®
                    const binaryString = window.atob(audioBase64);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }

                    // éªŒè¯éŸ³é¢‘æ•°æ®é•¿åº¦
                    if (bytes.length < 10) {
                        console.error('âŒ éŸ³é¢‘æ•°æ®å¤ªçŸ­ï¼Œæ— æ³•æ’­æ”¾');
                        return;
                    }

                    // æ£€æµ‹éŸ³é¢‘æ ¼å¼ï¼ˆæ£€æŸ¥å‰å‡ ä¸ªå­—èŠ‚ï¼‰
                    let mimeType = 'audio/mpeg'; // é»˜è®¤MP3
                    const firstBytes = Array.from(bytes.slice(0, 4));

                    // æ£€æŸ¥æ˜¯å¦ä¸ºWAVæ ¼å¼ (RIFF)
                    if (firstBytes[0] === 0x52 && firstBytes[1] === 0x49 && firstBytes[2] === 0x46 && firstBytes[3] === 0x46) {
                        mimeType = 'audio/wav';
                        console.log('ğŸµ æ£€æµ‹åˆ°WAVæ ¼å¼éŸ³é¢‘');
                    }
                    // æ£€æŸ¥æ˜¯å¦ä¸ºMP3æ ¼å¼ (ID3æˆ–ç›´æ¥MP3å¸§)
                    else if ((firstBytes[0] === 0x49 && firstBytes[1] === 0x44 && firstBytes[2] === 0x33) || // ID3
                             (firstBytes[0] === 0xFF && (firstBytes[1] & 0xE0) === 0xE0)) { // MP3å¸§åŒæ­¥å­—
                        mimeType = 'audio/mpeg';
                        console.log('ğŸµ æ£€æµ‹åˆ°MP3æ ¼å¼éŸ³é¢‘');
                    } else {
                        console.log('ğŸµ æœªçŸ¥éŸ³é¢‘æ ¼å¼ï¼Œä½¿ç”¨é»˜è®¤MP3ç±»å‹');
                    }

                    // è°ƒè¯•ï¼šæ˜¾ç¤ºå‰16ä¸ªå­—èŠ‚çš„åå…­è¿›åˆ¶å€¼
                    const hexPreview = Array.from(bytes.slice(0, 16))
                        .map(b => b.toString(16).padStart(2, '0'))
                        .join(' ');
                    console.log('ğŸ“¦ éŸ³é¢‘æ•°æ®ä¿¡æ¯:', {
                        mimeType: mimeType,
                        firstBytes: firstBytes,
                        hexPreview: hexPreview,
                        dataLength: bytes.length
                    });

                    // åˆ›å»ºBlobå¹¶æŒ‡å®šæ­£ç¡®çš„MIMEç±»å‹
                    const audioBlob = new Blob([bytes], { type: mimeType });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    console.log('ğŸ“¦ éŸ³é¢‘Blobå¤§å°:', audioBlob.size, 'bytes');
                    
                    // ä½¿ç”¨ç»Ÿä¸€çš„ ttsAudio æ’­æ”¾å™¨
                    if (!window.ttsAudio) {
                        window.ttsAudio = new Audio();
                    }
                    
                    // æ·»åŠ åˆ°é˜Ÿåˆ—
                    audioQueue.push({ url: audioUrl });
                    
                    // å¦‚æœå½“å‰æ²¡æœ‰æ’­æ”¾ï¼Œå¼€å§‹æ’­æ”¾é˜Ÿåˆ—
                    if (!isPlayingAudio) {
                        playNextAudio();
                    }
                    
                } catch (error) {
                    console.error('âŒ éŸ³é¢‘æ’­æ”¾é”™è¯¯:', error);
                }
            }

            // ğŸ”¥ æ–°å¢ï¼šä¸“é—¨ç”¨äºæ¶ˆæ¯æ’­æ”¾çš„éŸ³é¢‘å‡½æ•°ï¼Œä¸ä¼šå¹²æ‰°å½“å‰æ’­æ”¾çŠ¶æ€
            function playMessageAudioFromBase64(audioBase64) {
                try {
                    // å¦‚æœTTSæœªå¯ç”¨ï¼Œç›´æ¥è¿”å›
                    if (!ttsEnabled) {
                        return;
                    }

                    console.log('ğŸµ æ’­æ”¾æ¶ˆæ¯éŸ³é¢‘ç‰‡æ®µ');

                    // å°†Base64è½¬æ¢ä¸ºäºŒè¿›åˆ¶æ•°æ®
                    const binaryString = window.atob(audioBase64);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }

                    // éªŒè¯éŸ³é¢‘æ•°æ®é•¿åº¦
                    if (bytes.length < 10) {
                        console.error('âŒ éŸ³é¢‘æ•°æ®å¤ªçŸ­ï¼Œæ— æ³•æ’­æ”¾');
                        return;
                    }

                    // æ£€æµ‹éŸ³é¢‘æ ¼å¼
                    let mimeType = 'audio/mpeg'; // é»˜è®¤MP3
                    const firstBytes = Array.from(bytes.slice(0, 4));

                    // æ£€æŸ¥æ˜¯å¦ä¸ºWAVæ ¼å¼ (RIFF)
                    if (firstBytes[0] === 0x52 && firstBytes[1] === 0x49 && firstBytes[2] === 0x46 && firstBytes[3] === 0x46) {
                        mimeType = 'audio/wav';
                    }
                    // æ£€æŸ¥æ˜¯å¦ä¸ºMP3æ ¼å¼ (ID3æˆ–ç›´æ¥MP3å¸§)
                    else if ((firstBytes[0] === 0x49 && firstBytes[1] === 0x44 && firstBytes[2] === 0x33) || // ID3
                             (firstBytes[0] === 0xFF && (firstBytes[1] & 0xE0) === 0xE0)) { // MP3å¸§åŒæ­¥å­—
                        mimeType = 'audio/mpeg';
                    }

                    // åˆ›å»ºBlobå¹¶æŒ‡å®šæ­£ç¡®çš„MIMEç±»å‹
                    const audioBlob = new Blob([bytes], { type: mimeType });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    console.log('ğŸ“¦ æ¶ˆæ¯éŸ³é¢‘Blobå¤§å°:', audioBlob.size, 'bytes');
                    
                    // æ·»åŠ åˆ°é˜Ÿåˆ—ï¼ˆä¸å¹²æ‰°å½“å‰æ’­æ”¾çŠ¶æ€ï¼‰
                    audioQueue.push({ url: audioUrl });
                    
                    // å¦‚æœå½“å‰æ²¡æœ‰æ’­æ”¾ï¼Œå¼€å§‹æ’­æ”¾é˜Ÿåˆ—
                    if (!isPlayingAudio) {
                        playNextAudio();
                    }
                    
                } catch (error) {
                    console.error('âŒ æ¶ˆæ¯éŸ³é¢‘æ’­æ”¾é”™è¯¯:', error);
                }
            }
            
            // æ’­æ”¾é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªéŸ³é¢‘
            function playNextAudio() {
                if (audioQueue.length === 0) {
                    isPlayingAudio = false;
                    updateTtsButton(); // æ›´æ–°æŒ‰é’®çŠ¶æ€

                    // å¦‚æœå½“å‰æ˜¯è‡ªåŠ¨TTSæ’­æ”¾çŠ¶æ€ï¼Œåœæ­¢å®ƒ
                    if (AudioManager.currentType === AudioManager.states.AUTO_TTS) {
                        AudioManager.currentType = null;
                        AudioManager.updateUI();
                    }

                    console.log('âœ… éŸ³é¢‘é˜Ÿåˆ—æ’­æ”¾å®Œæˆ');
                    return;
                }
                
                isPlayingAudio = true;
                updateTtsButton(); // æ›´æ–°æŒ‰é’®çŠ¶æ€ä¸ºæ’­æ”¾ä¸­
                
                // ç¡®ä¿ window.ttsAudio å­˜åœ¨
                // if (!window.ttsAudio) {
                //     window.ttsAudio = new Audio();
                // }
                
                const { url } = audioQueue.shift();
                
                console.log('ğŸµ å¼€å§‹æ’­æ”¾éŸ³é¢‘ç‰‡æ®µï¼Œé˜Ÿåˆ—å‰©ä½™:', audioQueue.length);
                
                // å…ˆåœæ­¢å½“å‰æ’­æ”¾å¹¶æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
                window.ttsAudio.pause();
                window.ttsAudio.currentTime = 0;
                window.ttsAudio.onended = null;
                window.ttsAudio.onerror = null;
                
                // è®¾ç½®æ–°çš„éŸ³é¢‘æº
                window.ttsAudio.src = url;
                
                // è®¾ç½®éŸ³é‡ï¼ˆé¿å…é™éŸ³å¯¼è‡´æ— æ³•æ’­æ”¾ï¼‰
                window.ttsAudio.volume = 1.0;
                window.ttsAudio.muted = false;
                
                // ğŸ”¥ å…³é”®ä¿®å¤ï¼šå…ˆload()æ–°éŸ³é¢‘ï¼Œç¡®ä¿éŸ³é¢‘å·²åŠ è½½
                window.ttsAudio.load();
                
                // é”™è¯¯å¤„ç†è¾…åŠ©å‡½æ•°ï¼ˆæå‰å®šä¹‰ï¼‰
                function handlePlayError(err, isMobileDevice = DeviceUtils.isMobile()) {
                    console.error('âŒ éŸ³é¢‘æ’­æ”¾å¤±è´¥:', err);

                    // æ¸…ç†å½“å‰éŸ³é¢‘èµ„æº
                    if (window.ttsAudio && window.ttsAudio.src) {
                        window.ttsAudio.pause();
                        window.ttsAudio.currentTime = 0;
                        URL.revokeObjectURL(window.ttsAudio.src);
                        window.ttsAudio.src = '';
                    }

                    // ğŸ”¥ ç§»åŠ¨ç«¯ç‰¹æ®Šå¤„ç†ï¼šè‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢æ—¶ï¼Œä¸è¦æ¸…ç©ºæ•´ä¸ªé˜Ÿåˆ—ï¼Œè€Œæ˜¯ç»§ç»­æ’­æ”¾ä¸‹ä¸€ä¸ª
                    if (err.name === 'NotAllowedError') {
                        console.warn('âš ï¸ æµè§ˆå™¨é˜»æ­¢äº†è‡ªåŠ¨æ’­æ”¾');

                        if (isMobileDevice) {
                            console.log('ğŸ“± ç§»åŠ¨ç«¯ï¼šè·³è¿‡å½“å‰éŸ³é¢‘ç‰‡æ®µï¼Œç»§ç»­æ’­æ”¾é˜Ÿåˆ—ä¸­çš„å…¶ä»–ç‰‡æ®µ');
                            // ç§»åŠ¨ç«¯ï¼šä¸æ˜¾ç¤ºæç¤ºï¼Œç›´æ¥ç»§ç»­æ’­æ”¾ä¸‹ä¸€ä¸ªï¼Œé¿å…ç”¨æˆ·ä½“éªŒä¸­æ–­
                            playNextAudio();
                            return;
                        } else {
                            // PCç«¯ï¼šæ¸…ç©ºé˜Ÿåˆ—ï¼Œç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨è§¦å‘
                            console.log('ğŸ–¥ï¸ PCç«¯ï¼šæ¸…ç©ºé˜Ÿåˆ—ï¼Œç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨è§¦å‘');
                            audioQueue.forEach(({ url }) => {
                                URL.revokeObjectURL(url);
                            });
                            audioQueue = [];
                            isPlayingAudio = false;
                            updateTtsButton();

                            // åœæ­¢è‡ªåŠ¨TTSæ’­æ”¾çŠ¶æ€
                            if (AudioManager.currentType === AudioManager.states.AUTO_TTS) {
                                AudioManager.currentType = null;
                                AudioManager.updateUI();
                            }

                            // æ˜¾ç¤ºæç¤º
                            showToast('è¯·ç‚¹å‡»TTSæŒ‰é’®æ‰‹åŠ¨æ’­æ”¾è¯­éŸ³', 'info');
                        }
                    } else {
                        // å…¶ä»–é”™è¯¯ï¼šå¦‚æœæ˜¯ç§»åŠ¨ç«¯ï¼Œç»§ç»­æ’­æ”¾ä¸‹ä¸€ä¸ªï¼›PCç«¯åˆ™åœæ­¢æ’­æ”¾
                        if (isMobileDevice) {
                            console.log('ğŸ“± ç§»åŠ¨ç«¯ï¼šè·³è¿‡å¤±è´¥çš„éŸ³é¢‘ç‰‡æ®µï¼Œç»§ç»­æ’­æ”¾');
                            playNextAudio();
                        } else {
                            console.log('ğŸ–¥ï¸ PCç«¯ï¼šåœæ­¢æ’­æ”¾é˜Ÿåˆ—');
                            audioQueue.forEach(({ url }) => {
                                URL.revokeObjectURL(url);
                            });
                            audioQueue = [];
                            isPlayingAudio = false;
                            updateTtsButton();

                            // åœæ­¢è‡ªåŠ¨TTSæ’­æ”¾çŠ¶æ€
                            if (AudioManager.currentType === AudioManager.states.AUTO_TTS) {
                                AudioManager.currentType = null;
                                AudioManager.updateUI();
                            }

                            showToast('éŸ³é¢‘æ’­æ”¾å¤±è´¥ï¼Œå·²åœæ­¢', 'error');
                        }
                    }
                }
                
                // ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨æ ‡å¿—ä½é˜²æ­¢é‡å¤æ’­æ”¾
                let hasStartedPlaying = false;
                
                // æ’­æ”¾å®Œæˆåæ¸…ç†å¹¶æ’­æ”¾ä¸‹ä¸€ä¸ªï¼ˆå…ˆè®¾ç½®ï¼Œç¡®ä¿ä¸ä¼šä¸¢å¤±ï¼‰
                window.ttsAudio.onended = function() {
                    console.log('âœ… éŸ³é¢‘ç‰‡æ®µæ’­æ”¾å®Œæˆ');
                    URL.revokeObjectURL(url);
                    playNextAudio(); // æ’­æ”¾é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ª
                };
                
                // é”™è¯¯å¤„ç†
                window.ttsAudio.onerror = function(e) {
                    console.error('âŒ éŸ³é¢‘åŠ è½½é”™è¯¯:', e);
                    URL.revokeObjectURL(url);
                    handlePlayError(new Error('éŸ³é¢‘åŠ è½½å¤±è´¥'), DeviceUtils.isMobile());
                };
                
                // å°è¯•æ’­æ”¾çš„å‡½æ•°
                function tryPlay() {
                    if (hasStartedPlaying) return; // é˜²æ­¢é‡å¤æ’­æ”¾
                    hasStartedPlaying = true;
                    
                    const playPromise = window.ttsAudio.play();
                    if (playPromise !== undefined) {
                        playPromise
                            .then(() => {
                                console.log('âœ… éŸ³é¢‘æ’­æ”¾æˆåŠŸ');
                                // ğŸ”¥ ç§»åŠ¨ç«¯TTSä¼˜åŒ–ï¼šè®°å½•æˆåŠŸæ’­æ”¾
                                streamingAudioStats.successfullyPlayed++;
                            })
                            .catch(err => {
                                console.error('âŒ éŸ³é¢‘æ’­æ”¾å¤±è´¥:', err);
                                hasStartedPlaying = false; // é‡ç½®æ ‡å¿—ä½ï¼Œå…è®¸é‡è¯•
                                // ğŸ”¥ ç§»åŠ¨ç«¯TTSä¼˜åŒ–ï¼šè®°å½•æ’­æ”¾å¤±è´¥
                                streamingAudioStats.failedCount++;
                                handlePlayError(err, DeviceUtils.isMobile());
                            });
                    }
                }
                
                // ç­‰å¾…éŸ³é¢‘åŠ è½½å®Œæˆåå†æ’­æ”¾
                window.ttsAudio.onloadeddata = function() {
                    console.log('ğŸ“¦ éŸ³é¢‘æ•°æ®å·²åŠ è½½');
                    tryPlay();
                };
                
                // å¦‚æœåŠ è½½å¤±è´¥æˆ–è¶…æ—¶ï¼Œç›´æ¥å°è¯•æ’­æ”¾ï¼ˆå…¼å®¹æŸäº›æµè§ˆå™¨ï¼‰
                const loadTimeout = setTimeout(() => {
                    if (!hasStartedPlaying) {
                        console.warn('âš ï¸ éŸ³é¢‘åŠ è½½è¶…æ—¶ï¼Œå°è¯•ç›´æ¥æ’­æ”¾');
                        tryPlay();
                    }
                }, 2000); // 2ç§’è¶…æ—¶ï¼ˆå¢åŠ åˆ°2ç§’ï¼‰
                
                // æ¸…ç†è¶…æ—¶å®šæ—¶å™¨ï¼ˆå½“å¼€å§‹æ’­æ”¾æ—¶ï¼‰
                window.ttsAudio.onplay = function() {
                    clearTimeout(loadTimeout);
                };
                
                // æ’­æ”¾å‡ºé”™å¤„ç†
                window.ttsAudio.addEventListener('error', function onError(e) {
                    window.ttsAudio.removeEventListener('error', onError);
                    
                    // è·å–è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                    const audioError = window.ttsAudio.error;
                    let errorDetails = {
                        event: e,
                        isTrusted: e.isTrusted,
                        audioError: null,
                        errorCode: null,
                        errorMessage: null,
                        networkState: window.ttsAudio.networkState,
                        readyState: window.ttsAudio.readyState,
                        src: window.ttsAudio.src,
                        url: url
                    };
                    
                    // å¦‚æœ audio å…ƒç´ æœ‰é”™è¯¯å¯¹è±¡ï¼Œè·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
                    if (audioError) {
                        errorDetails.audioError = {
                            code: audioError.code,
                            message: audioError.message
                        };
                        errorDetails.errorCode = audioError.code;
                        errorDetails.errorMessage = audioError.message;
                        
                        // é”™è¯¯ä»£ç è¯´æ˜ï¼š
                        // MEDIA_ERR_ABORTED (1): ç”¨æˆ·ä¸­æ­¢
                        // MEDIA_ERR_NETWORK (2): ç½‘ç»œé”™è¯¯
                        // MEDIA_ERR_DECODE (3): è§£ç é”™è¯¯ï¼ˆéŸ³é¢‘æ ¼å¼ä¸æ”¯æŒæˆ–æ•°æ®æŸåï¼‰
                        // MEDIA_ERR_SRC_NOT_SUPPORTED (4): éŸ³é¢‘æºä¸æ”¯æŒ
                        const errorMessages = {
                            1: 'ç”¨æˆ·ä¸­æ­¢æ’­æ”¾',
                            2: 'ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½éŸ³é¢‘',
                            3: 'éŸ³é¢‘è§£ç å¤±è´¥ï¼ˆæ ¼å¼ä¸æ”¯æŒæˆ–æ•°æ®æŸåï¼‰',
                            4: 'éŸ³é¢‘æ ¼å¼ä¸æ”¯æŒ'
                        };
                        errorDetails.errorMessage = errorMessages[audioError.code] || audioError.message;
                    }
                    
                    // networkState è¯´æ˜ï¼š
                    // NETWORK_EMPTY (0): æœªåˆå§‹åŒ–
                    // NETWORK_IDLE (1): å·²é€‰æ‹©èµ„æºï¼Œä½†æœªä½¿ç”¨ç½‘ç»œ
                    // NETWORK_LOADING (2): æ­£åœ¨ä¸‹è½½
                    // NETWORK_NO_SOURCE (3): æœªæ‰¾åˆ°éŸ³é¢‘æº
                    const networkStates = {
                        0: 'æœªåˆå§‹åŒ–',
                        1: 'ç©ºé—²',
                        2: 'åŠ è½½ä¸­',
                        3: 'æœªæ‰¾åˆ°éŸ³é¢‘æº'
                    };
                    
                    // readyState è¯´æ˜ï¼š
                    // HAVE_NOTHING (0): æ²¡æœ‰ä¿¡æ¯
                    // HAVE_METADATA (1): å·²è·å–å…ƒæ•°æ®
                    // HAVE_CURRENT_DATA (2): å·²è·å–å½“å‰å¸§æ•°æ®
                    // HAVE_FUTURE_DATA (3): å·²è·å–æœªæ¥æ•°æ®
                    // HAVE_ENOUGH_DATA (4): æœ‰è¶³å¤Ÿæ•°æ®æ’­æ”¾
                    const readyStates = {
                        0: 'æ— æ•°æ®',
                        1: 'å…ƒæ•°æ®',
                        2: 'å½“å‰å¸§',
                        3: 'æœªæ¥æ•°æ®',
                        4: 'è¶³å¤Ÿæ•°æ®'
                    };
                    
                    errorDetails.networkStateText = networkStates[errorDetails.networkState] || 'æœªçŸ¥';
                    errorDetails.readyStateText = readyStates[errorDetails.readyState] || 'æœªçŸ¥';
                    
                    console.error('âŒ éŸ³é¢‘æ’­æ”¾å‡ºé”™ - è¯¦ç»†ä¿¡æ¯:', errorDetails);
                    
                    // æ ¹æ®é”™è¯¯ç±»å‹ç»™å‡ºå…·ä½“æç¤º
                    if (errorDetails.errorCode === 3) {
                        console.error('ğŸ” å¯èƒ½åŸå› : éŸ³é¢‘æ•°æ®æŸåæˆ–æ ¼å¼ä¸å…¼å®¹');
                        console.error('ğŸ’¡ å»ºè®®: æ£€æŸ¥éŸ³é¢‘Blobæ•°æ®æ˜¯å¦å®Œæ•´ï¼Œæˆ–å°è¯•é‡æ–°ç”ŸæˆéŸ³é¢‘');
                    } else if (errorDetails.errorCode === 4) {
                        console.error('ğŸ” å¯èƒ½åŸå› : æµè§ˆå™¨ä¸æ”¯æŒè¯¥éŸ³é¢‘æ ¼å¼');
                        console.error('ğŸ’¡ å»ºè®®: æ£€æŸ¥éŸ³é¢‘æ ¼å¼ï¼Œç¡®ä¿ä½¿ç”¨æµè§ˆå™¨æ”¯æŒçš„æ ¼å¼ï¼ˆå¦‚WAVã€MP3ï¼‰');
                    } else if (errorDetails.networkState === 3) {
                        console.error('ğŸ” å¯èƒ½åŸå› : Blob URLå·²å¤±æ•ˆæˆ–æ— æ•ˆ');
                        console.error('ğŸ’¡ å»ºè®®: æ£€æŸ¥URLæ˜¯å¦åœ¨è®¾ç½®srcä¹‹å‰è¢«revoke');
                    }
                    
                    clearTimeout(loadTimeout);
                    URL.revokeObjectURL(url);
                    playNextAudio(); // ç»§ç»­æ’­æ”¾ä¸‹ä¸€ä¸ª
                }, { once: true });
            }

            // è°ƒç”¨TTSæµå¼æ¥å£è¿›è¡Œå®Œæ•´æ’­æŠ¥
            async function playTextToSpeechFromAPI(text) {
                // å¦‚æœTTSæœªå¯ç”¨ï¼Œç›´æ¥è¿”å›
                if (!ttsEnabled) {
                    console.log('ğŸ”‡ TTSå·²å…³é—­ï¼Œè·³è¿‡è¯­éŸ³æ’­æŠ¥');
                    return;
                }
                
                try {
                    // ç§»é™¤æ–‡æœ¬é•¿åº¦é™åˆ¶ï¼Œåç«¯å·²æ”¯æŒæµå¼å¤„ç†ï¼Œå¯ä»¥å¤„ç†ä»»æ„é•¿åº¦çš„æ–‡æœ¬
                    // åç«¯ä¼šè‡ªåŠ¨æŒ‰å¥å­åˆ†å‰²å¹¶é€å¥åˆæˆï¼Œæ— éœ€å‰ç«¯æˆªæ–­
                    const ttsText = text;
                    
                    console.log('ğŸ”Š å¼€å§‹TTSæµå¼è¯­éŸ³åˆæˆï¼Œæ–‡æœ¬é•¿åº¦:', ttsText.length, 'å­—ç¬¦');
                    console.log('ğŸ“ æ–‡æœ¬é¢„è§ˆ:', ttsText.substring(0, 100) + (ttsText.length > 100 ? '...' : ''));
                    
                    // è·å–å½“å‰æœºå™¨äººå’Œè¯­é€Ÿ
                    const currentRobot = RobotConfig.getCurrentRobot();
                    const currentSpeed = RobotConfig.getCurrentSpeed();

                    // è°ƒç”¨TTSæµå¼æ¥å£
                    const response = await fetch(`${AppConfig.getApiUrl('/api/tts/stream')}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${API_TOKEN}`
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            text: ttsText,
                            voice_id: currentRobot.voiceId,
                            speed: currentSpeed,
                            use_cache: true  // å¯ç”¨ç¼“å­˜ï¼Œå¦‚æœç›¸åŒæ–‡æœ¬+éŸ³è‰²+è¯­é€Ÿå·²å­˜åœ¨ç¼“å­˜ï¼Œç›´æ¥å¤ç”¨
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`TTSè¯·æ±‚å¤±è´¥: ${response.status}`);
                    }
                    
                    // è¯»å–æµå¼å“åº”
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    let currentEvent = null; // åœ¨å¾ªç¯å¤–éƒ¨ä¿æŒcurrentEventï¼Œé¿å…è·¨chunkä¸¢å¤±
                    
                    while (true) {
                        const {done, value} = await reader.read();
                        
                        if (done) {
                            console.log('âœ… TTSæµå¼å“åº”å®Œæˆ');
                            break;
                        }
                        
                        // è§£ç æ•°æ®å¹¶è¿½åŠ åˆ°ç¼“å†²åŒº
                        buffer += decoder.decode(value, {stream: true});
                        
                        // æŒ‰è¡Œåˆ†å‰²
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || '';
                        for (const line of lines) {
                            const trimmedLine = line.trim();
                            if (!trimmedLine) {
                                // ç©ºè¡Œè¡¨ç¤ºä¸€ä¸ªSSEæ¶ˆæ¯ç»“æŸï¼Œé‡ç½®currentEvent
                                currentEvent = null;
                                continue;
                            }
                            
                            if (line.startsWith('event:')) {
                                currentEvent = line.substring(6).trim();
                                console.log('ğŸ“¨ TTSäº‹ä»¶ç±»å‹:', currentEvent);
                            } else if (line.startsWith('data:')) {
                                try {
                                    const dataStr = line.substring(5).trim();
                                    if (!dataStr || dataStr === '[DONE]') {
                                        currentEvent = null;
                                        continue;
                                    }
                                    
                                    console.log('ğŸ“¦ TTSæ•°æ®é•¿åº¦:', dataStr.length, 'äº‹ä»¶ç±»å‹:', currentEvent);
                                    
                                    const data = JSON.parse(dataStr);
                                    
                                    // å¤„ç†audioäº‹ä»¶
                                    if (currentEvent === 'audio') {
                                        if (data.audio) {
                                            const index = data.index || '?';
                                            const total = data.total || '?';
                                            console.log(`ğŸµ æ”¶åˆ°TTSéŸ³é¢‘ç‰‡æ®µ [${index}/${total}]:`, data.sentence?.substring(0, 30) || 'æ— æ–‡æœ¬');
                                            console.log('ğŸ“¦ éŸ³é¢‘æ•°æ®é•¿åº¦:', data.audio.length);
                                        playAudioFromBase64(data.audio);
                                        } else {
                                            console.warn('âš ï¸ æ”¶åˆ°audioäº‹ä»¶ä½†æ— éŸ³é¢‘æ•°æ®:', data);
                                        }
                                    } else if (currentEvent === 'audio_error') {
                                        const index = data.index || '?';
                                        const total = data.total || '?';
                                        console.warn(`âš ï¸ TTSéŸ³é¢‘è½¬æ¢å¤±è´¥ [${index}/${total}]:`, data.message || 'æœªçŸ¥é”™è¯¯', data.sentence?.substring(0, 30));
                                        // ç»§ç»­å¤„ç†ï¼Œä¸ä¸­æ–­æµç¨‹
                                    } else if (currentEvent === 'completed') {
                                        const total = data.total || 0;
                                        const success = data.success || 0;
                                        console.log(`âœ… TTSæµå¼è½¬æ¢å®Œæˆ: å…± ${total} å¥ï¼ŒæˆåŠŸ ${success} å¥`);
                                    } else if (currentEvent === 'error') {
                                        console.error('âŒ TTSæµå¼è½¬æ¢é”™è¯¯:', data.message);
                                    } else {
                                        console.log('âš ï¸ æœªå¤„ç†çš„äº‹ä»¶:', currentEvent, 'æ•°æ®é”®:', Object.keys(data));
                                    }
                                    
                                    // æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œé‡ç½®currentEventï¼Œå› ä¸ºSSEæ ¼å¼ä¸­ï¼Œeventå’Œdataä¹‹é—´å¯èƒ½æœ‰ç©ºè¡Œ
                                    // currentEventä¼šåœ¨é‡åˆ°ç©ºè¡Œæ—¶é‡ç½®
                                } catch (e) {
                                    console.error('âŒ è§£æTTS SSEæ•°æ®å¤±è´¥:', e, 'Line:', line.substring(0, 100));
                                    currentEvent = null;
                                }
                            } else {
                                console.log('âš ï¸ æœªè¯†åˆ«çš„è¡Œ:', line.substring(0, 50));
                            }
                        }
                    }
                    
                    console.log('âœ… TTSè¯­éŸ³æ’­æŠ¥å®Œæˆ');
                    
                } catch (error) {
                    console.error('âŒ TTSè¯­éŸ³åˆæˆå¤±è´¥:', error);
                    // TTSå¤±è´¥ä¸å½±å“æ­£å¸¸å¯¹è¯ï¼Œåªè®°å½•é”™è¯¯
                }
            }

            // æ—§çš„TTSå‡½æ•°ï¼ˆä¿ç•™ä½œä¸ºå¤‡ç”¨ï¼‰
            async function playTextToSpeech(text) {
                // å¦‚æœTTSæœªå¯ç”¨ï¼Œç›´æ¥è¿”å›
                if (!ttsEnabled) {
                    console.log('ğŸ”‡ TTSå·²å…³é—­ï¼Œè·³è¿‡è¯­éŸ³æ’­æŠ¥');
                    return;
                }
                
                try {
                    // é™åˆ¶æ–‡æœ¬é•¿åº¦ï¼Œé¿å…è¿‡é•¿å¯¼è‡´åˆæˆæ—¶é—´è¿‡é•¿
                    const maxLength = 200; // æœ€å¤š200å­—ç¬¦
                    let ttsText = text;
                    if (text.length > maxLength) {
                        ttsText = text.substring(0, maxLength) + '...';
                        console.log(`âš ï¸ æ–‡æœ¬è¿‡é•¿ï¼Œæˆªå–å‰${maxLength}å­—ç¬¦`);
                    }
                    
                    console.log('ğŸ”Š å¼€å§‹TTSè¯­éŸ³åˆæˆ:', ttsText.substring(0, 50) + '...');
                    
                    // ç¡®ä¿ window.ttsAudio å­˜åœ¨
                    if (!window.ttsAudio) {
                        window.ttsAudio = new Audio();
                    }
                    
                    // å¦‚æœæœ‰æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘ï¼Œå…ˆåœæ­¢
                    if (window.ttsAudio && !window.ttsAudio.paused) {
                        window.ttsAudio.pause();
                        window.ttsAudio.currentTime = 0;
                    }

                    // è°ƒç”¨TTSæ¥å£ï¼ˆä½¿ç”¨16000Hzæé«˜è´¨é‡å’Œé€Ÿåº¦ï¼‰
                    const response = await fetch(`${AppConfig.getApiUrl('/api/coze/audio/text-to-speech')}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${API_TOKEN}`
                        },
                        credentials: 'include',
                        body: JSON.stringify(requestData)
                    });

                    if (!response.ok) {
                        throw new Error(`TTSè¯·æ±‚å¤±è´¥: ${response.status}`);
                    }

                    // è·å–éŸ³é¢‘æ•°æ®
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);

                    // ä½¿ç”¨ç»Ÿä¸€çš„ ttsAudio æ’­æ”¾å™¨æ’­æ”¾
                    window.ttsAudio.src = audioUrl;
                    window.ttsAudio.play();

                    console.log('âœ… TTSè¯­éŸ³æ’­æ”¾å¼€å§‹');

                    // æ’­æ”¾å®Œæˆåæ¸…ç†
                    window.ttsAudio.addEventListener('ended', function onEnded() {
                        URL.revokeObjectURL(audioUrl);
                        window.ttsAudio.removeEventListener('ended', onEnded);
                        console.log('âœ… TTSè¯­éŸ³æ’­æ”¾å®Œæˆ');
                    });

                    // æ’­æ”¾å‡ºé”™å¤„ç†
                    window.ttsAudio.addEventListener('error', function onError(e) {
                        console.error('âŒ TTSæ’­æ”¾å‡ºé”™:', e);
                        URL.revokeObjectURL(audioUrl);
                        window.ttsAudio.removeEventListener('error', onError);
                    });

                } catch (error) {
                    console.error('âŒ TTSè¯­éŸ³åˆæˆå¤±è´¥:', error);
                    // TTSå¤±è´¥ä¸å½±å“æ­£å¸¸å¯¹è¯ï¼Œåªè®°å½•é”™è¯¯
                }
            }

            // åœæ­¢å½“å‰è¯­éŸ³æ’­æ”¾
            function stopCurrentAudio() {
                // åœæ­¢å½“å‰æ’­æ”¾çš„éŸ³é¢‘
                if (window.ttsAudio && !window.ttsAudio.paused) {
                    window.ttsAudio.pause();
                    window.ttsAudio.currentTime = 0;
                }

                isPlayingAudio = false;
                updateTtsButton(); // æ›´æ–°æŒ‰é’®çŠ¶æ€
                console.log('ğŸ”‡ åœæ­¢å½“å‰è¯­éŸ³æ’­æ”¾');
            }

            // åœæ­¢æ‰€æœ‰TTSæ’­æ”¾ï¼ˆåŒ…æ‹¬é˜Ÿåˆ—ä¸­çš„ï¼‰
            function stopAllTTSPlayback() {
                // åœæ­¢å½“å‰æ’­æ”¾çš„éŸ³é¢‘
                if (window.ttsAudio && !window.ttsAudio.paused) {
                    window.ttsAudio.pause();
                    window.ttsAudio.currentTime = 0;
                }

                // æ¸…ç©ºéŸ³é¢‘é˜Ÿåˆ—
                audioQueue.forEach(({ url }) => {
                    // URL.revokeObjectURL(url);
                });
                audioQueue = [];

                isPlayingAudio = false;
                // ğŸ”¥ ä¿®å¤æ— é™é€’å½’ï¼šä¸åœ¨è¿™é‡Œè°ƒç”¨updateTtsButtonï¼Œç”±è°ƒç”¨æ–¹å†³å®šæ˜¯å¦æ›´æ–°
                console.log('ğŸ”‡ åœæ­¢æ‰€æœ‰TTSæ’­æ”¾');
            }

            // æ›´æ–°TTSæŒ‰é’®çŠ¶æ€çš„å‡½æ•°ï¼ˆä¼˜åŒ–ï¼šåˆå¹¶ä¸ºä¸€ä¸ªæŒ‰é’®ï¼‰
            function updateTtsButton() {
                const stopTtsBtn = document.querySelector('#stop-tts-btn');

                // å¦‚æœæ­£åœ¨æ’­æ”¾éŸ³é¢‘æˆ–é˜Ÿåˆ—ä¸­æœ‰éŸ³é¢‘ï¼Œæ˜¾ç¤ºåœæ­¢çŠ¶æ€
                if ((isPlayingAudio || audioQueue.length > 0) && ttsEnabled) {
                    // TTSå¼€å…³æŒ‰é’®å˜ä¸ºåœæ­¢çŠ¶æ€ï¼ˆçº¢è‰²åœæ­¢å›¾æ ‡ï¼‰
                    ttsToggleBtn.classList.add('bg-red-500');
                    ttsToggleBtn.classList.remove('bg-gradient-primary', 'bg-gray-300');
                    ttsToggleBtn.title = 'æ­£åœ¨æ’­æ”¾ï¼ˆç‚¹å‡»åœæ­¢ï¼‰';
                    ttsToggleBtn.innerHTML = '<i class="fas fa-stop text-white text-lg"></i>';

                    // éšè—ç‹¬ç«‹çš„åœæ­¢æŒ‰é’®ï¼ˆå› ä¸ºTTSå¼€å…³æŒ‰é’®å·²ç»æ‰¿æ‹…åœæ­¢åŠŸèƒ½ï¼‰
                    if (stopTtsBtn) {
                        stopTtsBtn.classList.add('hidden');
                    }
                    return;
                }

                // æ­£å¸¸çŠ¶æ€ä¸‹çš„æŒ‰é’®æ˜¾ç¤º
                if (ttsEnabled) {
                    // å¼€å¯çŠ¶æ€ï¼šç´«è‰²èƒŒæ™¯ + ç™½è‰²å–‡å­å›¾æ ‡
                    ttsToggleBtn.classList.add('bg-gradient-primary');
                    ttsToggleBtn.classList.remove('bg-gray-300', 'bg-red-500');
                    ttsToggleBtn.title = 'è¯­éŸ³æ’­æŠ¥ï¼ˆç‚¹å‡»å…³é—­ï¼‰';

                    // æ›´æ–°å›¾æ ‡
                    ttsToggleBtn.innerHTML = '<i class="fas fa-volume-high text-white text-lg"></i>';
                } else {
                    // å…³é—­çŠ¶æ€ï¼šç°è‰²èƒŒæ™¯ + ç°è‰²é™éŸ³å›¾æ ‡
                    ttsToggleBtn.classList.remove('bg-gradient-primary', 'bg-red-500');
                    ttsToggleBtn.classList.add('bg-gray-300');
                    ttsToggleBtn.title = 'è¯­éŸ³æ’­æŠ¥ï¼ˆç‚¹å‡»å¼€å¯ï¼‰';

                    // æ›´æ–°å›¾æ ‡
                    ttsToggleBtn.innerHTML = '<i class="fas fa-volume-xmark text-gray-600 text-lg"></i>';

                    // ğŸ”¥ ä¿®å¤æ— é™é€’å½’ï¼šTTSå…³é—­æ—¶åœæ­¢æ’­æ”¾ï¼Œä½†ä¸å†è°ƒç”¨updateTtsButton
                    if (isPlayingAudio || audioQueue.length > 0) {
                        stopAllTTSPlayback();
                    }
                }

                // éšè—ç‹¬ç«‹çš„åœæ­¢æŒ‰é’®
                if (stopTtsBtn) {
                    stopTtsBtn.classList.add('hidden');
                }
            }

            // è¯­éŸ³æƒé™æ£€æµ‹å’Œå¼¹æ¡†ç®¡ç†
            const audioPermissionModal = document.querySelector('#audio-permission-modal');
            const audioPermissionContent = document.querySelector('#audio-permission-content');
            const audioPermissionAllow = document.querySelector('#audio-permission-allow');
            const audioPermissionCancel = document.querySelector('#audio-permission-cancel');
            let hasCheckedAudioPermission = localStorage.getItem('hasCheckedAudioPermission') === 'true';

            // æ˜¾ç¤ºè¯­éŸ³æƒé™å¼¹æ¡†
            function showAudioPermissionModal() {
                audioPermissionModal.classList.remove('hidden');
                setTimeout(() => {
                    audioPermissionContent.classList.remove('scale-95');
                    audioPermissionContent.classList.add('scale-100');
                }, 10);
            }

            // éšè—è¯­éŸ³æƒé™å¼¹æ¡†
            function hideAudioPermissionModal() {
                audioPermissionContent.classList.remove('scale-100');
                audioPermissionContent.classList.add('scale-95');
                setTimeout(() => {
                    audioPermissionModal.classList.add('hidden');
                }, 300);
            }

            // æ£€æµ‹éŸ³é¢‘æƒé™ï¼ˆé€šè¿‡å°è¯•æ’­æ”¾ä¸€ä¸ªé™éŸ³éŸ³é¢‘ï¼‰
            async function checkAudioPermission() {
                try {
                    // ğŸ”¥ ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šä½¿ç”¨ç»Ÿä¸€çš„ ttsAudio å°è¯•æ’­æ”¾
                    if (!window.ttsAudio) {
                        window.ttsAudio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=');
                    }
                    window.ttsAudio.src = 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=';
                    window.ttsAudio.volume = 0.01;
                    window.ttsAudio.muted = false;
                    
                    const playPromise = window.ttsAudio.play();
                    if (playPromise !== undefined) {
                        await playPromise;
                        window.ttsAudio.pause();
                        window.ttsAudio.currentTime = 0;
                        return true; // æƒé™å·²æˆäºˆ
                    }
                    return true;
                } catch (error) {
                    if (error.name === 'NotAllowedError') {
                        // ç§»åŠ¨ç«¯å¯èƒ½ä¼šæ‹’ç»ï¼Œä½†å®é™…æ’­æ”¾æ—¶å¯èƒ½å…è®¸
                        return true; // ğŸ”¥ å…³é”®ï¼šç§»åŠ¨ç«¯è¿”å›trueï¼Œè®©ç”¨æˆ·èƒ½å¼€å¯TTS
                    }
                    return true; // å…¶ä»–é”™è¯¯ï¼Œå‡è®¾å¯ä»¥æ’­æ”¾
                }
            }

            // å…è®¸æ’­æ”¾æŒ‰é’®ç‚¹å‡»
            audioPermissionAllow.addEventListener('click', async function() {
                hideAudioPermissionModal();
                
                // å°è¯•è§£é”éŸ³é¢‘ä¸Šä¸‹æ–‡
                await unlockAudioContext();
                
                // æ£€æµ‹æƒé™
                const hasPermission = await checkAudioPermission();
                
                if (hasPermission) {
                    // æƒé™å·²æˆäºˆï¼Œä½†ä¸è‡ªåŠ¨å¼€å¯TTSï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®
                    hasCheckedAudioPermission = true;
                    localStorage.setItem('hasCheckedAudioPermission', 'true');
                    showToast('âœ… éŸ³é¢‘æƒé™å·²æˆäºˆï¼Œè¯·ç‚¹å‡»TTSæŒ‰é’®å¼€å¯è¯­éŸ³æ’­æŠ¥', 'success');
                } else {
                    // æƒé™è¢«æ‹’ç»
                    showToast('âš ï¸ éœ€è¦æˆæƒéŸ³é¢‘æ’­æ”¾æƒé™æ‰èƒ½ä½¿ç”¨è¯­éŸ³æ’­æŠ¥', 'warning');
                }
            });

            // å–æ¶ˆæŒ‰é’®ç‚¹å‡»
            audioPermissionCancel.addEventListener('click', function() {
                hideAudioPermissionModal();
                hasCheckedAudioPermission = true;
                localStorage.setItem('hasCheckedAudioPermission', 'true');
            });

            // ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹æ¡†
            audioPermissionModal.addEventListener('click', function(e) {
                if (e.target === audioPermissionModal) {
                    hideAudioPermissionModal();
                    hasCheckedAudioPermission = true;
                    localStorage.setItem('hasCheckedAudioPermission', 'true');
                }
            });

            // TTSåˆ‡æ¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            ttsToggleBtn.addEventListener('click', async function() {
                try {
                    // ğŸ”¥ ç§»åŠ¨ç«¯Safariå’Œå¾®ä¿¡å…¼å®¹æ€§ä¼˜åŒ–
                    
                    // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œç‚¹å‡»åœæ­¢æ’­æ”¾
                    if (isPlayingAudio || audioQueue.length > 0) {
                        // ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨ AudioManager ç»Ÿä¸€ç®¡ç†ï¼Œç¡®ä¿çŠ¶æ€åŒæ­¥
                        AudioManager.stopAllPlayback();
                        updateTtsButton();
                        showToast('å·²åœæ­¢æ’­æ”¾', 'info');
                        return;
                    }
                    

                    // å¦‚æœå½“å‰æ˜¯å…³é—­çŠ¶æ€ï¼Œå‡†å¤‡å¼€å¯ï¼ˆè¿›è¡Œæƒé™æ£€æŸ¥ï¼‰
                    if (!ttsEnabled) {
                        // ğŸ”¥ ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šåœ¨ç”¨æˆ·ç‚¹å‡»æ—¶ç«‹å³è§£é”éŸ³é¢‘
                        try {
                            // 1. å…ˆè§£é”éŸ³é¢‘ä¸Šä¸‹æ–‡
                            const unlockResult = await unlockAudioContext();
                            
                            // 2. å°è¯•æ’­æ”¾æµ‹è¯•éŸ³é¢‘
                            const hasPermission = await checkAudioPermission();
                            
                            if (hasPermission) {
                                // æƒé™OKï¼Œç›´æ¥å¼€å¯
                            } else {
                                // æƒé™å¤±è´¥ï¼Œä½†ä»ç„¶å¼€å¯ï¼ˆç§»åŠ¨ç«¯å¯èƒ½ç¬¬ä¸€æ¬¡å¤±è´¥ï¼‰
                            }
                            
                            // ğŸ”¥ å…³é”®ï¼šæ— è®ºæƒé™æ£€æŸ¥ç»“æœå¦‚ä½•ï¼Œéƒ½æ ‡è®°ä¸ºå·²æ£€æŸ¥
                            hasCheckedAudioPermission = true;
                            localStorage.setItem('hasCheckedAudioPermission', 'true');
                            
                        } catch (error) {
                            // å³ä½¿å¤±è´¥ä¹Ÿç»§ç»­ï¼Œç­‰å®é™…æ’­æ”¾æ—¶å†å¤„ç†
                        }
                    } else {
                    }

                    // ğŸ”¥ å…³é”®æ”¹è¿›ï¼šæ— è®ºæƒé™å¦‚ä½•ï¼Œéƒ½åˆ‡æ¢TTSçŠ¶æ€
                    ttsEnabled = !ttsEnabled;
                    // è®©ç”¨æˆ·èƒ½çœ‹åˆ°æŒ‰é’®å˜åŒ–ï¼Œå®é™…æ’­æ”¾æ—¶æµè§ˆå™¨ä¼šå†æ¬¡è¯·æ±‚æƒé™
                    const oldValue = ttsEnabled;
                    
                    // ç«‹å³æ›´æ–°æŒ‰é’®æ˜¾ç¤º
                    updateTtsButton();

                    // ä¿å­˜çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem('ttsEnabled', ttsEnabled);
                    
                    // æ˜¾ç¤ºåé¦ˆ
                    if (ttsEnabled) {
                        showToast('âœ… è¯­éŸ³æ’­æŠ¥å·²å¼€å¯', 'success');
                    } else {
                        showToast('ğŸ”‡ è¯­éŸ³æ’­æŠ¥å·²å…³é—­', 'info');
                    }
                    
                    // ğŸ”¥ ç§»åŠ¨ç«¯Safariï¼šå¤šæ¬¡å¼ºåˆ¶é‡ç»˜ç¡®ä¿çŠ¶æ€æ›´æ–°
                    setTimeout(() => {
                        updateTtsButton();
                    }, 50);
                    setTimeout(() => {
                        updateTtsButton();
                    }, 100);
                } catch (error) {
                    showToast('è¯­éŸ³æ’­æŠ¥åˆ‡æ¢å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            });

            // åœæ­¢æ’­æ”¾æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼ˆå·²åˆå¹¶åˆ°TTSå¼€å…³æŒ‰é’®ï¼Œä¸å†éœ€è¦ï¼‰
            const stopTtsBtn = document.querySelector('#stop-tts-btn');
            if (stopTtsBtn) {
                // éšè—ç‹¬ç«‹çš„åœæ­¢æŒ‰é’®ï¼ŒåŠŸèƒ½å·²åˆå¹¶åˆ°TTSå¼€å…³æŒ‰é’®
                stopTtsBtn.classList.add('hidden');
            }

            // å•ä¸ªæ¶ˆæ¯æ’­æ”¾æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨

            function updatePlayButtonState(messageId, isPlaying) {
                try {
                    console.log(`ğŸ”„ æ›´æ–°æ’­æ”¾æŒ‰é’®çŠ¶æ€: æ¶ˆæ¯ID=${messageId}, æ’­æ”¾ä¸­=${isPlaying}`);

                    // é‡ç½®æ‰€æœ‰æ’­æ”¾æŒ‰é’®çŠ¶æ€
                    const playButtons = document.querySelectorAll('.tts-play-btn');
                    console.log(`ğŸ“Š æ‰¾åˆ° ${playButtons.length} ä¸ªæ’­æ”¾æŒ‰é’®`);

                    playButtons.forEach((btn, index) => {
                        try {
                            let icon = btn.querySelector('i');
                            let text = btn.querySelector('span');
                            const btnMessageId = btn.getAttribute('data-message-id');

                            // ç¡®ä¿å…ƒç´ å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä¿®å¤
                            if (!icon || !text) {
                                console.warn(`âš ï¸ æ’­æ”¾æŒ‰é’® ${index} ç»“æ„ä¸å®Œæ•´ï¼Œæ­£åœ¨ä¿®å¤...`);
                                // ä¿®å¤æŒ‰é’®ç»“æ„
                                btn.innerHTML = `
                                    <i class="fas fa-volume-up"></i>
                                    <span>æ’­æ”¾</span>
                                `;
                                icon = btn.querySelector('i');
                                text = btn.querySelector('span');

                                if (!icon || !text) {
                                    console.error(`âŒ æ’­æ”¾æŒ‰é’® ${index} ä¿®å¤å¤±è´¥ï¼Œè·³è¿‡çŠ¶æ€æ›´æ–°`);
                                return;
                                }
                                console.log(`âœ… æ’­æ”¾æŒ‰é’® ${index} ç»“æ„ä¿®å¤å®Œæˆ`);
                            }

                            console.log(`ğŸ” æ£€æŸ¥æŒ‰é’® ${index}: data-message-id=${btnMessageId}, ç›®æ ‡ID=${messageId}`);

                            if (btnMessageId === messageId.toString()) {
                                if (isPlaying) {
                                    icon.className = 'fas fa-stop';
                                    text.textContent = 'åœæ­¢';
                                    btn.classList.remove('text-gray-500', 'hover:text-blue-500');
                                    btn.classList.add('text-red-500', 'hover:text-red-600');
                                    console.log(`âœ… è®¾ç½®æŒ‰é’® ${messageId} ä¸ºæ’­æ”¾çŠ¶æ€`);
                                } else {
                                    icon.className = 'fas fa-volume-up';
                                    text.textContent = 'æ’­æ”¾';
                                    btn.classList.remove('text-red-500', 'hover:text-red-600');
                                    btn.classList.add('text-gray-500', 'hover:text-blue-500');
                                    console.log(`â¹ï¸ è®¾ç½®æŒ‰é’® ${messageId} ä¸ºåœæ­¢çŠ¶æ€`);
                                }
                            } else {
                                // å…¶ä»–æŒ‰é’®é‡ç½®ä¸ºåœæ­¢çŠ¶æ€
                                icon.className = 'fas fa-volume-up';
                                text.textContent = 'æ’­æ”¾';
                                btn.classList.remove('text-red-500', 'hover:text-red-600');
                                btn.classList.add('text-gray-500', 'hover:text-blue-500');
                            }
                        } catch (btnError) {
                            console.error(`âŒ å¤„ç†æŒ‰é’® ${index} æ—¶å‡ºé”™:`, btnError);
                        }
                    });

                    console.log('âœ… æ’­æ”¾æŒ‰é’®çŠ¶æ€æ›´æ–°å®Œæˆ');
                } catch (error) {
                    console.error('âŒ æ›´æ–°æ’­æ”¾æŒ‰é’®çŠ¶æ€æ—¶å‡ºé”™:', error);
                }
            }

            async function playIndividualMessage(messageId, messageText) {
                try {
                    // æ£€æŸ¥æ˜¯å¦å¯ä»¥å¼€å§‹æ’­æ”¾
                    if (!AudioManager.canStartPlayback(AudioManager.states.MESSAGE_TTS, messageId)) {
                        console.log('ğŸµ å…¶ä»–éŸ³é¢‘æ­£åœ¨æ’­æ”¾ä¸­ï¼Œåœæ­¢å…¶ä»–æ’­æ”¾åé‡è¯•');
                        // å¦‚æœæ˜¯ç‚¹å‡»åŒä¸€æ¶ˆæ¯ï¼Œåœæ­¢æ’­æ”¾
                        if (AudioManager.currentType === AudioManager.states.MESSAGE_TTS &&
                            AudioManager.currentMessageId === messageId) {
                            AudioManager.stopPlayback(AudioManager.states.MESSAGE_TTS);
                            return;
                        }
                        // å¦åˆ™åœæ­¢å½“å‰æ’­æ”¾ï¼Œç„¶åå¼€å§‹æ–°æ’­æ”¾
                        AudioManager.stopAllPlayback();
                        // çŸ­æš‚å»¶è¿Ÿç¡®ä¿åœæ­¢å®Œæˆ
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }

                    console.log(`ğŸµ å¼€å§‹æ’­æ”¾æ¶ˆæ¯ ${messageId}:`, messageText.substring(0, 50) + '...');

                    // ğŸ”¥ åˆ›å»ºAbortControllerç”¨äºä¸­æ–­è¯·æ±‚
                    currentMessageTTSController = new AbortController();

                    // æ ‡è®°å¼€å§‹æ’­æ”¾
                    AudioManager.startPlayback(AudioManager.states.MESSAGE_TTS, messageId);

                    // è·å–å½“å‰æœºå™¨äººå’Œè¯­é€Ÿ
                    const currentRobot = RobotConfig.getCurrentRobot();
                    const currentSpeed = RobotConfig.getCurrentSpeed();

                    // è°ƒç”¨TTSæµå¼æ¥å£ï¼ˆæ·»åŠ signalå‚æ•°ï¼‰
                    const response = await fetch(`${AppConfig.getApiUrl('/api/tts/stream')}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${API_TOKEN}`
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            text: messageText,
                            voice_id: currentRobot.voiceId,
                            speed: currentSpeed,
                            use_cache: true
                        }),
                        signal: currentMessageTTSController.signal // ğŸ”¥ æ·»åŠ ä¸­æ–­ä¿¡å·
                    });

                    if (!response.ok) {
                        throw new Error(`TTSè¯·æ±‚å¤±è´¥: ${response.status}`);
                    }

                    // å¤„ç†æµå¼å“åº”
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    let currentEvent = null; // ğŸ”¥ æ·»åŠ ï¼šè·Ÿè¸ªå½“å‰äº‹ä»¶ç±»å‹

                    while (true) {
                        // ğŸ”¥ æ£€æŸ¥æ˜¯å¦åº”è¯¥ä¸­æ–­ï¼ˆä¿®å¤ï¼šå…ˆæ£€æŸ¥controlleræ˜¯å¦å­˜åœ¨ï¼‰
                        if (!currentMessageTTSController || currentMessageTTSController.signal.aborted) {
                            console.log(`ğŸ›‘ æ¶ˆæ¯ ${messageId} TTSæ’­æ”¾è¢«ä¸­æ–­`);
                            reader.cancel();
                            break;
                        }

                        const {done, value} = await reader.read();

                        if (done) {
                            console.log(`âœ… æ¶ˆæ¯ ${messageId} TTSæ’­æ”¾å®Œæˆ`);
                            break;
                        }

                        buffer += decoder.decode(value, {stream: true});
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || '';

                        for (const line of lines) {
                            const trimmedLine = line.trim();
                            
                            // ğŸ”¥ ä¿®å¤ï¼šè§£æ event: è¡Œ
                            if (line.startsWith('event:')) {
                                currentEvent = line.substring(6).trim();
                                console.log(`ğŸ“¨ æ¶ˆæ¯ ${messageId} æ’­æ”¾äº‹ä»¶: ${currentEvent}`);
                                continue;
                            }
                            
                            if (!trimmedLine) {
                                // ç©ºè¡Œè¡¨ç¤ºä¸€ä¸ªäº‹ä»¶ç»“æŸï¼Œä½†ä¸é‡ç½®äº‹ä»¶ç±»å‹ï¼ˆç»§ç»­ç”¨äºä¸‹ä¸€ä¸ªdataè¡Œï¼‰
                                // currentEvent = null;  // ğŸ”¥ ç§»é™¤ï¼šä¸è¦é‡ç½®ï¼ŒSSEæ ¼å¼ä¸­eventå’Œdataä¹‹é—´å¯èƒ½æœ‰ç©ºè¡Œ
                                continue;
                            }

                            // ğŸ”¥ ä¿®å¤ï¼šæ ¹æ®äº‹ä»¶ç±»å‹å¤„ç† data: è¡Œ
                            if (line.startsWith('data:')) {
                                try {
                                    const dataStr = line.substring(5).trim();
                                    if (!dataStr || dataStr === '[DONE]') {
                                        currentEvent = null; // ğŸ”¥ æ”¶åˆ°ç»“æŸæ ‡è®°åé‡ç½®äº‹ä»¶
                                        continue;
                                    }

                                    const data = JSON.parse(dataStr);

                                    // ğŸ”¥ ä¿®å¤ï¼šåªå¤„ç† audio äº‹ä»¶
                                    if (currentEvent === 'audio' && data.audio) {
                                        console.log(`ğŸµ æ¶ˆæ¯ ${messageId} æ”¶åˆ°éŸ³é¢‘ç‰‡æ®µ [${data.index}/${data.total}]:`, data.sentence?.substring(0, 30) || '', `(${data.audio.length} bytes)`);
                                        // ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨ä¸“ç”¨çš„æ¶ˆæ¯æ’­æ”¾å‡½æ•°ï¼Œé¿å…ä¸è‡ªåŠ¨TTSå†²çª
                                        playMessageAudioFromBase64(data.audio);
                                        currentEvent = null; // ğŸ”¥ å¤„ç†å®Œä¸€ä¸ªäº‹ä»¶åé‡ç½®
                                    } else if (currentEvent === 'audio_error') {
                                        console.warn(`âš ï¸ éŸ³é¢‘è½¬æ¢å¤±è´¥ [${data.index}/${data.total}]:`, data.message || 'æœªçŸ¥é”™è¯¯');
                                        currentEvent = null;
                                    } else if (currentEvent === 'completed') {
                                        console.log(`âœ… TTSè½¬æ¢å®Œæˆ:`, data.message);
                                        currentEvent = null;
                                    } else if (currentEvent === 'error') {
                                        console.error(`âŒ TTSé”™è¯¯:`, data.message);
                                        currentEvent = null;
                                    } else {
                                        console.warn(`âš ï¸ æœªçŸ¥äº‹ä»¶ç±»å‹: ${currentEvent}, data:`, data);
                                    }
                                } catch (e) {
                                    console.error('âŒ è§£æTTSæ•°æ®å¤±è´¥:', e, 'Line:', line.substring(0, 100));
                                    currentEvent = null;
                                }
                            }
                        }
                    }

                    // ğŸ”¥ æ’­æ”¾å®Œæˆåæ¸…ç†controller
                    currentMessageTTSController = null;

                } catch (error) {
                    // ğŸ”¥ å¦‚æœæ˜¯è¢«ä¸­æ–­çš„è¯·æ±‚ï¼Œä¸æ˜¾ç¤ºé”™è¯¯
                    if (error.name === 'AbortError') {
                        console.log(`â„¹ï¸ æ¶ˆæ¯ ${messageId} æ’­æ”¾è¢«ç”¨æˆ·ä¸­æ–­`);
                        return;
                    }

                    console.error(`âŒ æ’­æ”¾æ¶ˆæ¯ ${messageId} å¤±è´¥:`, error);
                    showToast('æ’­æ”¾å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');

                    // å‘ç”Ÿé”™è¯¯æ—¶ä¹Ÿè¦é‡ç½®çŠ¶æ€
                    AudioManager.stopPlayback(AudioManager.states.MESSAGE_TTS);
                    
                    // ğŸ”¥ æ¸…ç†controller
                    currentMessageTTSController = null;
                }
            }

            function stopIndividualMessage() {
                AudioManager.stopPlayback(AudioManager.states.MESSAGE_TTS);
            }

            // ç¡®ä¿æ’­æ”¾æŒ‰é’®ç»“æ„å®Œæ•´
            function ensurePlayButtonStructure(btn) {
                if (!btn) return false;

                const icon = btn.querySelector('i');
                const text = btn.querySelector('span');

                if (!icon || !text) {
                    console.warn('ğŸ”§ ä¿®å¤æ’­æ”¾æŒ‰é’®ç»“æ„:', btn);

                    // æ¸…ç©ºæŒ‰é’®å†…å®¹å¹¶é‡æ–°åˆ›å»ºç»“æ„
                    btn.innerHTML = `
                        <i class="fas fa-volume-up"></i>
                        <span>æ’­æ”¾</span>
                    `;

                    console.log('âœ… æ’­æ”¾æŒ‰é’®ç»“æ„å·²ä¿®å¤');
                    return true; // æ ‡è®°ä¸ºå·²ä¿®å¤
                }

                // æ£€æŸ¥å›¾æ ‡ç±»åæ˜¯å¦æ­£ç¡®
                if (icon && !icon.className.includes('fa-volume-up') && !icon.className.includes('fa-stop')) {
                    console.warn('ğŸ”§ ä¿®å¤æ’­æ”¾æŒ‰é’®å›¾æ ‡ç±»å:', icon.className);
                    icon.className = 'fas fa-volume-up';
                }

                // æ£€æŸ¥æ–‡æœ¬å†…å®¹æ˜¯å¦æ­£ç¡®
                if (text && text.textContent !== 'æ’­æ”¾' && text.textContent !== 'åœæ­¢') {
                    console.warn('ğŸ”§ ä¿®å¤æ’­æ”¾æŒ‰é’®æ–‡æœ¬å†…å®¹:', text.textContent);
                    text.textContent = 'æ’­æ”¾';
                }

                return false; // ç»“æ„æœ¬æ¥å°±æ˜¯å®Œæ•´çš„
            }

            // ä¸ºæ‰€æœ‰æ’­æ”¾æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼‰
            document.addEventListener('click', function(e) {
                if (e.target.closest('.tts-play-btn')) {
                    e.preventDefault();
                    const btn = e.target.closest('.tts-play-btn');

                    // ç¡®ä¿æŒ‰é’®ç»“æ„å®Œæ•´ï¼Œå¦‚æœä¸å®Œæ•´åˆ™ä¿®å¤
                    const wasFixed = ensurePlayButtonStructure(btn);

                    const icon = btn.querySelector('i');
                    const text = btn.querySelector('span');

                    if (!icon || !text) {
                        console.error('âŒ æ’­æ”¾æŒ‰é’®ç»“æ„ä¿®å¤å¤±è´¥:', btn);
                        showToast('æ’­æ”¾æŒ‰é’®åŠ è½½å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                        return;
                    }

                    if (wasFixed) {
                        console.log('ğŸ”§ æŒ‰é’®ç»“æ„å·²è‡ªåŠ¨ä¿®å¤ï¼Œç»§ç»­æ’­æ”¾');
                    }

                    const messageId = parseInt(btn.getAttribute('data-message-id'));
                    const messageText = btn.getAttribute('data-message-text');

                    if (isNaN(messageId)) {
                        console.error('âŒ æ— æ•ˆçš„æ¶ˆæ¯ID:', btn.getAttribute('data-message-id'));
                        showToast('æ¶ˆæ¯IDæ— æ•ˆ', 'error');
                        return;
                    }

                    if (!messageText || messageText.trim() === '') {
                        showToast('æ¶ˆæ¯å†…å®¹ä¸ºç©ºï¼Œæ— æ³•æ’­æ”¾', 'warning');
                        return;
                    }

                    console.log(`ğŸµ ç”¨æˆ·ç‚¹å‡»æ’­æ”¾æŒ‰é’®: æ¶ˆæ¯ID=${messageId}, æ–‡æœ¬é•¿åº¦=${messageText.length}`);
                    playIndividualMessage(messageId, messageText);
                }
            });

            // ä»æœ¬åœ°å­˜å‚¨è¯»å–TTSçŠ¶æ€å¹¶åˆå§‹åŒ–æŒ‰é’®æ ·å¼ï¼ˆé»˜è®¤å¼€å¯ï¼‰
            const savedTtsState = localStorage.getItem('ttsEnabled');
            if (savedTtsState !== null) {
                ttsEnabled = savedTtsState === 'true';
            } else {
                // å¦‚æœæœ¬åœ°å­˜å‚¨ä¸­æ²¡æœ‰å€¼ï¼Œé»˜è®¤å¼€å¯
                ttsEnabled = true;
                localStorage.setItem('ttsEnabled', 'true');
            }
            updateTtsButton();

            // å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            sendBtn.addEventListener('click', sendMessage);

            // è¾“å…¥æ¡†å›è½¦å‘é€
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // ğŸ”¥ é—®é¢˜4 & 5ï¼šè¯­éŸ³å½•å…¥æ”¹ä¸ºç‚¹å‡»å¼¹çª—æ¨¡å¼ï¼Œä¸”æŒ‰ä½è¯´è¯æ—¶åœæ­¢æ‰€æœ‰TTS
            // ç§»é™¤æŒ‰ä½å½•éŸ³çš„äº‹ä»¶ç›‘å¬ï¼Œæ”¹ä¸ºå•å‡»è§¦å‘
            voiceBtn.addEventListener('click', function(e) {
                e.preventDefault();

                // å¦‚æœæ­£åœ¨å½•éŸ³ï¼Œä¸å¤„ç†ç‚¹å‡»
                if (isRecording) return;

                // ğŸ”¥ é—®é¢˜5ï¼šåœæ­¢æ‰€æœ‰éŸ³é¢‘æ’­æ”¾ï¼ˆåŒ…æ‹¬é˜Ÿåˆ—ä¸­çš„ï¼‰
                if (AudioManager.currentType) {
                    console.log('ğŸµ è¯­éŸ³è¾“å…¥æ—¶åœæ­¢æ‰€æœ‰éŸ³é¢‘æ’­æ”¾');
                    AudioManager.stopAllPlayback();
                    updateTtsButton(); // ğŸ”¥ åœæ­¢åæ›´æ–°æŒ‰é’®çŠ¶æ€
                    showToast('å·²åœæ­¢æ‰€æœ‰æ’­æŠ¥', 'info');
                }

                // å¦‚æœæ­£åœ¨æ’­æ”¾éŸ³é¢‘ï¼Œå…ˆåœæ­¢ï¼ˆè¯­éŸ³è¾“å…¥ä¼˜å…ˆçº§æœ€é«˜ï¼‰
                if (AudioManager.currentType) {
                    console.log('ğŸ¤ å½•éŸ³å¼€å§‹ï¼Œåœæ­¢å…¶ä»–éŸ³é¢‘æ’­æ”¾');
                    AudioManager.stopPlayback(AudioManager.currentType);
                }

                // ç‚¹å‡»å¼€å§‹å½•éŸ³
                console.log('ğŸ¤ ç‚¹å‡»è¯­éŸ³æŒ‰é’®ï¼Œå¼€å§‹å½•éŸ³');
                startVoiceRecording();
            });

            // åœæ­¢å½•éŸ³æŒ‰é’®
            stopRecordingBtn.addEventListener('click', function() {
                console.log('âœ… ç‚¹å‡»åœæ­¢å½•éŸ³');
                stopVoiceRecording(false); // falseè¡¨ç¤ºä¸å–æ¶ˆï¼Œæ­£å¸¸å‘é€
            });

            // å–æ¶ˆå½•éŸ³æŒ‰é’®
            cancelRecordingBtn.addEventListener('click', function() {
                console.log('âŒ ç‚¹å‡»å–æ¶ˆå½•éŸ³');
                stopVoiceRecording(true); // trueè¡¨ç¤ºå–æ¶ˆå½•éŸ³
            });

            // ç§»é™¤æ—§çš„handleVoiceStartã€handleVoiceMoveã€handleVoiceEndå‡½æ•°
            // ç°åœ¨ä½¿ç”¨ç‚¹å‡»å¼¹çª—æ¨¡å¼ï¼Œä¸å†éœ€è¦æŒ‰ä½å’Œä¸Šæ»‘å–æ¶ˆçš„é€»è¾‘

            // å¼€å§‹è¯­éŸ³å½•åˆ¶
            async function startVoiceRecording() {
                try {
                    // è¯·æ±‚éº¦å…‹é£æƒé™
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            sampleRate: 16000, // 16kHzé‡‡æ ·ç‡
                            channelCount: 1,   // å•å£°é“
                            echoCancellation: true,
                            noiseSuppression: true
                        } 
                    });
                    
                    console.log('ğŸ¤ å¼€å§‹å½•éŸ³...');
                    
                    // ğŸ”¥ æµå¼ASRæš‚æ—¶ä¸å¯ç”¨ï¼Œç›´æ¥ä½¿ç”¨ä¼ ç»ŸAPIæ–¹å¼
                    isStreamingASR = false;
                    
                    // åˆ›å»ºMediaRecorderï¼Œä¼˜å…ˆä½¿ç”¨WAVæ ¼å¼ï¼ˆCoze APIæ”¯æŒçš„æ ¼å¼ï¼‰
                    let mimeType = 'audio/wav'; // ä¼˜å…ˆä½¿ç”¨WAV

                    // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒçš„æ ¼å¼ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åº
                    if (MediaRecorder.isTypeSupported('audio/wav')) {
                        mimeType = 'audio/wav';
                    } else if (MediaRecorder.isTypeSupported('audio/ogg;codecs=opus')) {
                        mimeType = 'audio/ogg;codecs=opus'; // OGGå®¹å™¨Opusç¼–ç 
                    } else if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
                        mimeType = 'audio/webm;codecs=opus'; // WebMå®¹å™¨Opusç¼–ç 
                    } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                        mimeType = 'audio/mp4';
                    }

                    console.log('ğŸ¤ ä½¿ç”¨å½•éŸ³æ ¼å¼:', mimeType);

                    mediaRecorder = new MediaRecorder(stream, {
                        mimeType: mimeType
                    });
                    
                    audioChunks = []; // æ¸…ç©ºä¹‹å‰çš„å½•éŸ³æ•°æ®
                    
                    // ç›‘å¬æ•°æ®å¯ç”¨äº‹ä»¶
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                            
                        }
                    };
                    
                    // ç›‘å¬å½•éŸ³åœæ­¢äº‹ä»¶
                    mediaRecorder.onstop = async () => {
                        // åœæ­¢æ‰€æœ‰éŸ³é¢‘è½¨é“
                        stream.getTracks().forEach(track => track.stop());
                        
                        // ğŸ”¥ ä¿®å¤æœªå®šä¹‰å˜é‡ï¼šä½¿ç”¨recordingCancelledä»£æ›¿shouldCancel
                        if (recordingCancelled) {
                            console.log('âŒ å½•éŸ³å·²å–æ¶ˆ');
                            recordingCancelled = false; // é‡ç½®æ ‡å¿—
                            return;
                        }
                        
                        // å¤„ç†å½•éŸ³æ•°æ®
                        await processRecording();
                    };
                    
                    // å¼€å§‹å½•éŸ³
                    mediaRecorder.start(100); // æ¯100msæ”¶é›†ä¸€æ¬¡æ•°æ®
                    
                    isRecording = true;
                    recordingStartTime = Date.now();
                    
                    // æŒ‰é’®è§†è§‰åé¦ˆ
                    voiceBtn.classList.add('bg-primary', 'scale-95');
                    voiceBtn.classList.remove('bg-gray-100');
                    
                    // æ˜¾ç¤ºå½•éŸ³å¼¹çª—
                    voiceRecordingStatus.classList.remove('hidden');
                    
                    // å¼€å§‹è®¡æ—¶
                    updateRecordingTime();
                    recordingTimer = setInterval(updateRecordingTime, 100);
                    
                } catch (error) {
                    console.error('âŒ å½•éŸ³å¤±è´¥:', error);
                    alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
                    isRecording = false;
                }
            }
            
            // ==================== æµå¼ASRåŠŸèƒ½ ====================
            
            // åˆå§‹åŒ–æµå¼ASR WebSocketè¿æ¥
            function initStreamingASR() {
                return new Promise((resolve, reject) => {
                    try {
                        // ä½¿ç”¨HTTP(S)åè®®è½¬æ¢ä¸ºWS(S)åè®®
                        const wsProtocol = API_BASE_URL.startsWith('https') ? 'wss' : 'ws';
                        const wsUrl = `${wsProtocol}://${API_BASE_URL.replace(/^https?:\/\//, '')}/api/chat/asr/stream`;
                        
                        console.log('ğŸ”Œ è¿æ¥æµå¼ASR WebSocket:', wsUrl);
                        
                        asrWebSocket = new WebSocket(wsUrl);
                        
                        // è¿æ¥æˆåŠŸ
                        asrWebSocket.onopen = () => {
                            console.log('âœ… WebSocketè¿æ¥æˆåŠŸ');
                            // å‘é€è®¤è¯ä¿¡æ¯
                            asrWebSocket.send(JSON.stringify({
                                type: 'auth',
                                token: API_TOKEN
                            }));
                            resolve();
                        };
                        
                        // æ¥æ”¶è¯†åˆ«ç»“æœ
                        asrWebSocket.onmessage = (event) => {
                            try {
                                const data = JSON.parse(event.data);
                                
                                if (data.type === 'result') {
                                    // ä¸­é—´ç»“æœï¼ˆå®æ—¶æ˜¾ç¤ºï¼‰
                                    if (data.is_final === false) {
                                        streamingRecognitionText = data.text || '';
                                        updateStreamingRecognitionDisplay();
                                    } 
                                    // æœ€ç»ˆç»“æœ
                                    else if (data.is_final === true) {
                                        streamingRecognitionText = data.text || '';
                                        console.log('âœ… æœ€ç»ˆè¯†åˆ«ç»“æœ:', streamingRecognitionText);
                                    }
                                } else if (data.type === 'error') {
                                    console.error('âŒ ASRé”™è¯¯:', data.message);
                                    showToast('è¯­éŸ³è¯†åˆ«å‡ºé”™: ' + data.message, 'error');
                                }
                            } catch (e) {
                                console.error('âŒ è§£æASRæ¶ˆæ¯å¤±è´¥:', e);
                            }
                        };
                        
                        // è¿æ¥é”™è¯¯
                        asrWebSocket.onerror = (error) => {
                            console.error('âŒ WebSocketé”™è¯¯:', error);
                            reject(error);
                        };
                        
                        // è¿æ¥å…³é—­
                        asrWebSocket.onclose = () => {
                            console.log('ğŸ”Œ WebSocketè¿æ¥å·²å…³é—­');
                            asrWebSocket = null;
                        };
                        
                    } catch (error) {
                        console.error('âŒ åˆå§‹åŒ–WebSocketå¤±è´¥:', error);
                        reject(error);
                    }
                });
            }
            
            // æ›´æ–°æµå¼è¯†åˆ«æ–‡æœ¬æ˜¾ç¤º
            function updateStreamingRecognitionDisplay() {
                // åœ¨å½•åˆ¶å¼¹çª—ä¸­æ˜¾ç¤ºå®æ—¶è¯†åˆ«æ–‡æœ¬
                const streamingAsrDiv = document.querySelector('#streaming-asr-text');
                const streamingAsrContent = document.querySelector('#streaming-asr-content');
                
                if (streamingAsrDiv && streamingAsrContent) {
                    // æ˜¾ç¤ºè¯†åˆ«åŒºåŸŸ
                    if (streamingRecognitionText) {
                        streamingAsrDiv.classList.remove('hidden');
                        streamingAsrContent.textContent = streamingRecognitionText;
                    } else {
                        // å¦‚æœæ²¡æœ‰è¯†åˆ«åˆ°å†…å®¹ï¼Œæ˜¾ç¤ºç­‰å¾…æç¤º
                        streamingAsrDiv.classList.remove('hidden');
                        streamingAsrContent.textContent = '(ç­‰å¾…è¯†åˆ«...)';
                    }
                }
            }
            
            // ç»“æŸæµå¼ASRå¹¶è·å–æœ€ç»ˆç»“æœ
            async function finalizeStreamingASR() {
                return new Promise((resolve) => {
                    if (asrWebSocket && asrWebSocket.readyState === WebSocket.OPEN) {
                        // å‘é€ç»“æŸä¿¡å·
                        asrWebSocket.send(JSON.stringify({
                            type: 'end'
                        }));
                        
                        // ç­‰å¾…æœ€ç»ˆç»“æœ
                        setTimeout(() => {
                            const finalText = streamingRecognitionText;
                            
                            // å…³é—­WebSocket
                            if (asrWebSocket) {
                                asrWebSocket.close();
                                asrWebSocket = null;
                            }
                            
                            // ç§»é™¤æµå¼è¯†åˆ«çš„æ¶ˆæ¯å…ƒç´ 
                            if (streamingMessageElement) {
                                streamingMessageElement.remove();
                                streamingMessageElement = null;
                            }
                            
                            resolve(finalText);
                        }, 500);
                    } else {
                        resolve(streamingRecognitionText);
                    }
                });
            }
            
            // å¤„ç†å½•éŸ³æ•°æ®
            async function processRecording() {
                try {
                    console.log('ğŸ“¦ å¤„ç†å½•éŸ³æ•°æ®...');
                    
                    
                    // éæµå¼ASRï¼šå°†å½•éŸ³æ•°æ®è½¬æ¢ä¸ºBlob
                    // ä½¿ç”¨ä¸MediaRecorderç›¸åŒçš„æ ¼å¼
                    const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
                    console.log('ğŸ“¦ å½•éŸ³æ ¼å¼:', mediaRecorder.mimeType, 'å¤§å°:', audioBlob.size, 'bytes');

                    // æ£€æŸ¥éŸ³é¢‘è´¨é‡ï¼ˆå¤ªå°å¯èƒ½è¡¨ç¤ºå½•éŸ³æœ‰é—®é¢˜ï¼‰
                    if (audioBlob.size < 1000) { // å°äº1KB
                        showToast('å½•éŸ³æ—¶é—´å¤ªçŸ­ï¼Œè¯·é‡æ–°è¯´è¯', 'warning');
                        return;
                    }
                    
                    // è½¬æ¢ä¸ºBase64
                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        const base64Audio = reader.result.split(',')[1]; // ç§»é™¤data:audio/webm;base64,å‰ç¼€
                        
                        // è°ƒç”¨åç«¯APIè¿›è¡Œè¯­éŸ³è¯†åˆ«
                        await sendAudioToAPI(base64Audio);
                    };
                    reader.readAsDataURL(audioBlob);
                    
                } catch (error) {
                    console.error('âŒ å¤„ç†å½•éŸ³å¤±è´¥:', error);
                    showToast('å½•éŸ³å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            }
            
            // å‘é€éŸ³é¢‘åˆ°åç«¯è¿›è¡Œè¯†åˆ«ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
            async function sendAudioToAPI(audioBase64, retryCount = 0) {
                const maxRetries = 2;

                try {
                    if (!API_TOKEN) {
                        showToast('æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•', 'error');
                        return;
                    }

                    console.log(`ğŸ“¤ å‘é€éŸ³é¢‘åˆ°åç«¯è¿›è¡Œè¯†åˆ«... (å°è¯• ${retryCount + 1}/${maxRetries + 1})`);
                    
                    // æ˜¾ç¤ºè¯†åˆ«ä¸­æç¤º
                    showToast('æ­£åœ¨è¯†åˆ«è¯­éŸ³...', 'info');
                    showTypingIndicator();
                    
                    // è§£æéŸ³é¢‘æ ¼å¼ï¼Œå‘é€Coze APIæ”¯æŒçš„æ ¼å¼åç§°
                    let audioFormat = 'wav'; // é»˜è®¤WAV
                    if (mediaRecorder.mimeType.includes('wav')) {
                        audioFormat = 'wav';
                    } else if (mediaRecorder.mimeType.includes('webm') || mediaRecorder.mimeType.includes('opus')) {
                        audioFormat = 'opus'; // WebMå®¹å™¨ä¸­çš„Opusç¼–ç 
                    } else if (mediaRecorder.mimeType.includes('ogg')) {
                        audioFormat = 'opus'; // OGGå®¹å™¨ä¸­çš„Opusç¼–ç 
                    } else if (mediaRecorder.mimeType.includes('mp4') || mediaRecorder.mimeType.includes('m4a')) {
                        audioFormat = 'm4a';
                    } else if (mediaRecorder.mimeType.includes('mp3')) {
                        audioFormat = 'mp3';
                    }

                    // è°ƒç”¨ASRæ¥å£
                    const response = await fetch(`${AppConfig.getApiUrl('/api/chat/speech_to_text')}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${API_TOKEN}`
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            user_id: cachedUserId,
                            audio_base64: audioBase64,
                            audio_format: audioFormat
                        })
                    });
                    
                    if (!response.ok) {
                        // å¦‚æœæ˜¯500é”™è¯¯ï¼Œæ˜¾ç¤ºå‹å¥½æç¤º
                        if (response.status === 500) {
                            hideTypingIndicator();
                            showToast('æ²¡å¬æ¸…æ¥šï¼Œè¯·é‡è¯´ï¼Œæˆ–è€…æ–‡å­—å‘Šè¯‰æˆ‘ä½ æƒ³è¯´çš„å†…å®¹', 'warning');
                            return;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log('âœ… è¯­éŸ³è¯†åˆ«ç»“æœ:', result);
                    
                    hideTypingIndicator();
                    
                    if (result.success && result.text) {
                        // è¯†åˆ«æˆåŠŸï¼Œå°†æ–‡æœ¬å‘é€ç»™AI
                        const recognizedText = result.text;
                        console.log('ğŸ“ è¯†åˆ«åˆ°çš„æ–‡æœ¬:', recognizedText);

                        // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ï¼ˆè¯­éŸ³è½¬æ–‡å­—ï¼‰
                        addUserMessage(recognizedText);

                        // è°ƒç”¨AIå¯¹è¯æ¥å£
                        sendMessageToAPI(recognizedText);

                    } else if (result.success && result.text === '') {
                        // è¯†åˆ«æˆåŠŸä½†æ–‡æœ¬ä¸ºç©ºï¼ˆå¯èƒ½æ˜¯å£°éŸ³å¤ªçŸ­ï¼‰
                        console.log('âš ï¸ è¯†åˆ«åˆ°ç©ºæ–‡æœ¬');
                        showToast('å¤ªçŸ­äº†ï¼Œè¯·é‡æ–°è¯´è¯', 'warning');

                    } else {
                        // è¯†åˆ«å¤±è´¥
                        showToast(result.message || 'è¯­éŸ³è¯†åˆ«å¤±è´¥', 'error');
                    }
                    
                } catch (error) {
                    console.error(`âŒ è¯­éŸ³è¯†åˆ«å¤±è´¥ (å°è¯• ${retryCount + 1}):`, error);

                    // å¦‚æœæ˜¯500é”™è¯¯ï¼Œæ˜¾ç¤ºå‹å¥½æç¤º
                    if (error.message && error.message.includes('status: 500')) {
                        hideTypingIndicator();
                        showToast('æ²¡å¬æ¸…æ¥šï¼Œè¯·é‡è¯´ï¼Œæˆ–è€…æ–‡å­—å‘Šè¯‰æˆ‘ä½ æƒ³è¯´çš„å†…å®¹', 'warning');
                        return;
                    }

                    // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ä¸”æœªè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œåˆ™é‡è¯•
                    if (retryCount < maxRetries && (error.message.includes('network') || error.message.includes('fetch'))) {
                        console.log(`ğŸ”„ ${retryCount + 1} ç§’åé‡è¯•...`);
                        setTimeout(() => {
                            sendAudioToAPI(audioBase64, retryCount + 1);
                        }, 1000 * (retryCount + 1)); // é€’å¢å»¶è¿Ÿ
                        return;
                    }

                    hideTypingIndicator();
                    showToast('è¯­éŸ³è¯†åˆ«å¤±è´¥: ' + error.message, 'error');
                }
            }

            // æ›´æ–°å½•éŸ³æ—¶é•¿
            function updateRecordingTime() {
                const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                recordingTime.textContent = 
                    String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
                
                // æœ€é•¿60ç§’è‡ªåŠ¨åœæ­¢
                if (elapsed >= 60) {
                    stopVoiceRecording(false);
                }
            }

            // åœæ­¢è¯­éŸ³å½•åˆ¶
            function stopVoiceRecording(cancel = false) {
                if (!isRecording) {
                    return;
                }
                
                // ğŸ”¥ è®¾ç½®å–æ¶ˆæ ‡å¿—
                recordingCancelled = cancel;
                
                isRecording = false;
                
                // æ¸…é™¤è®¡æ—¶å™¨
                if (recordingTimer) {
                    clearInterval(recordingTimer);
                    recordingTimer = null;
                }
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                voiceBtn.classList.remove('bg-primary', 'scale-95');
                voiceBtn.classList.add('bg-gray-100');
                
                // éšè—å½•éŸ³å¼¹çª—
                voiceRecordingStatus.classList.add('hidden');
                recordingTime.textContent = '00:00';
                
                // åœæ­¢å½•éŸ³ï¼ˆä¼šè§¦å‘mediaRecorder.onstopäº‹ä»¶ï¼‰
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                    console.log('ğŸ›‘ å½•éŸ³å·²åœæ­¢');
                }
                
                // å¦‚æœå–æ¶ˆï¼Œæ¸…ç©ºå½•éŸ³æ•°æ®å¹¶å…³é—­WebSocket
                if (cancel) {
                    audioChunks = [];
                    
                    
                    isStreamingASR = false;
                    streamingRecognitionText = '';
                    console.log('âŒ å½•éŸ³å·²å–æ¶ˆ');
                }
            }

            // æ·»åŠ ç”¨æˆ·æ–‡æœ¬æ¶ˆæ¯
            function addUserMessage(message, timestamp = new Date()) {
                messageCount++;
                const messageElement = document.createElement('div');
                messageElement.id = `message-user-${messageCount}`;
                messageElement.className = 'flex items-start space-x-3 justify-end mb-6';
                // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸ºHTMLæ¢è¡Œæ ‡ç­¾
                const formattedMessage = message.replace(/\n/g, '<br>');
                messageElement.innerHTML = `
                    <div class="message-bubble-user p-3 max-w-xs">
                        <p class="text-white text-base">${formattedMessage}</p>
                        <div class="flex items-center justify-end mt-2">
                            <span class="text-blue-100 text-xs">${formatMessageTime(timestamp)}</span>
                        </div>
                    </div>
                    <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0">
                        <img src="https://s.coze.cn/image/es6fUICmNgw/"
                             alt="ç”¨æˆ·å¤´åƒ"
                             data-category="äººç‰©"
                             class="w-full h-full object-cover">
                    </div>
                `;
                chatMessages.appendChild(messageElement);
                scrollToBottom();
            }

            // æ·»åŠ ç”¨æˆ·è¯­éŸ³æ¶ˆæ¯
            function addUserVoiceMessage(timestamp = new Date()) {
                messageCount++;
                const messageElement = document.createElement('div');
                messageElement.id = `message-user-${messageCount}`;
                messageElement.className = 'flex items-start space-x-3 justify-end mb-6';
                messageElement.innerHTML = `
                    <div class="message-bubble-user p-3 max-w-xs">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-microphone text-white text-sm"></i>
                            <span class="text-white text-sm">è¯­éŸ³æ¶ˆæ¯</span>
                        </div>
                        <div class="flex items-center justify-end mt-2">
                            <span class="text-blue-100 text-xs">${formatMessageTime(timestamp)}</span>
                        </div>
                    </div>
                    <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0">
                        <img src="https://s.coze.cn/image/--9SXJ2XZz8/" 
                             alt="ç”¨æˆ·å¤´åƒ" 
                             data-category="äººç‰©"
                             class="w-full h-full object-cover">
                    </div>
                `;
                chatMessages.appendChild(messageElement);
                scrollToBottom();
            }

            // æ·»åŠ AIæ¶ˆæ¯
            function addAIMessage(message, timestamp = new Date()) {
                const messageElement = createAIMessageElementForStreaming(timestamp);
                const contentElement = messageElement.querySelector(`p[id^="ai-content-"]`);
                if (contentElement) {
                    // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸ºHTMLæ¢è¡Œæ ‡ç­¾
                    const formattedMessage = message.replace(/\n/g, '<br>');
                    contentElement.innerHTML = formattedMessage;

                    // æ·»åŠ markdown-contentç±»ä»¥åº”ç”¨æ ·å¼
                    if (!contentElement.classList.contains('markdown-content')) {
                        contentElement.classList.add('markdown-content');
                    }
                }

                // æ¨¡æ‹Ÿè¯­éŸ³æ’­æ”¾ï¼ˆTTSï¼‰
                setTimeout(() => {
                    console.log('éœ€è¦è°ƒç”¨ç¬¬ä¸‰æ–¹æ¥å£å®ç°è¯­éŸ³åˆæˆåŠŸèƒ½');
                }, 500);
            }

            // æ˜¾ç¤ºAIæ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
            function showTypingIndicator() {
                typingIndicator.classList.remove('hidden');
            }

            // éšè—AIæ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
            function hideTypingIndicator() {
                typingIndicator.classList.add('hidden');
            }

            // æ»šåŠ¨åˆ°åº•éƒ¨
            function scrollToBottom() {
                setTimeout(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 100);
            }

            // ç”ŸæˆAIå›å¤ï¼ˆæ¨¡æ‹Ÿï¼‰
            function generateAIResponse(userMessage) {
                const responses = [
                    "æˆ‘ç†è§£æ‚¨çš„æƒ…å†µã€‚è®©æˆ‘ä»¬ä¸€èµ·åˆ†æä¸€ä¸‹å¯èƒ½çš„åŸå› ã€‚",
                    "æ ¹æ®æ‚¨çš„æè¿°ï¼Œæˆ‘å»ºè®®æ‚¨å¯ä»¥å°è¯•ä»¥ä¸‹æ–¹æ³•ï¼š",
                    "è¿™æ˜¯ä¸€ä¸ªå¾ˆå¸¸è§çš„é—®é¢˜ï¼Œåˆ«æ‹…å¿ƒã€‚è®©æˆ‘ä¸ºæ‚¨è¯¦ç»†è§£ç­”ã€‚",
                    "æ‚¨æåˆ°çš„æƒ…å†µéœ€è¦å…³æ³¨ï¼Œæˆ‘å»ºè®®æ‚¨è®°å½•ä¸€ä¸‹ç›¸å…³æ•°æ®ã€‚",
                    "å¾ˆå¥½çš„é—®é¢˜ï¼å…³äºè¿™ä¸ªï¼Œæˆ‘å¯ä»¥ä»å‡ ä¸ªæ–¹é¢æ¥ä¸ºæ‚¨è§£é‡Šã€‚"
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }

            // åˆå§‹åŒ–æ—¶æ»šåŠ¨åˆ°åº•éƒ¨
            scrollToBottom();

            // æ·»åŠ æ»šåŠ¨ç›‘å¬å™¨ï¼Œç”¨äºåŠ è½½æ›´å¤šå†å²æ¶ˆæ¯
            const chatContainer = document.querySelector('#chat-messages');
            chatContainer.addEventListener('scroll', async function() {
                // æ£€æŸ¥æ˜¯å¦æ»šåŠ¨åˆ°é¡¶éƒ¨é™„è¿‘ï¼ˆè·ç¦»é¡¶éƒ¨100pxå†…ï¼‰
                if (chatContainer.scrollTop <= 100 && hasMoreHistory && !isLoadingHistory) {
                    console.log('ğŸ”„ æ£€æµ‹åˆ°ä¸Šæ»‘åˆ°é¡¶éƒ¨ï¼Œå¼€å§‹åŠ è½½æ›´å¤šå†å²æ¶ˆæ¯...');
                    await loadChatHistory(chatHistoryPage + 1, true);
                }
            });
            
            // ========== å¼€å‘è°ƒè¯•åŠŸèƒ½ ==========
            // åœ¨æ§åˆ¶å°ä¸­å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‡½æ•°æ¥è®¾ç½®tokenå’Œæ¸…é™¤ä¼šè¯
            window.setAPIToken = function(token) {
                AppConfig.setToken(token);
                console.log('âœ… Tokenå·²ä¿å­˜:', token);
                console.log('ğŸ’¡ åˆ·æ–°é¡µé¢åç”Ÿæ•ˆ');
            };
            
            window.clearConversation = function() {
                // æ¸…é™¤å½“å‰ç”¨æˆ·çš„conversation_id
                if (cachedUserId) {
                    const userKey = `${AppConfig.STORAGE_KEYS.CONVERSATION_ID}_${cachedUserId}`;
                    localStorage.removeItem(userKey);
                }
                // å…¼å®¹æ—§ç‰ˆæœ¬ï¼Œæ¸…é™¤å…¨å±€çš„conversation_id
                localStorage.removeItem(AppConfig.STORAGE_KEYS.CONVERSATION_ID);
                conversationId = null;
                console.log(`âœ… ç”¨æˆ· ${cachedUserId} çš„ä¼šè¯IDå·²æ¸…é™¤ï¼Œä¸‹æ¬¡å¯¹è¯å°†åˆ›å»ºæ–°ä¼šè¯`);
            };
            
            window.getConversationId = function() {
                console.log(`ç”¨æˆ· ${cachedUserId} çš„å½“å‰ä¼šè¯ID:`, conversationId);
                return conversationId;
            };
            
            window.testAPI = async function(message = 'ä½ å¥½') {
                console.log('ğŸ§ª æµ‹è¯•APIæ¥å£...');
                console.log('ğŸ“ APIåœ°å€:', API_BASE_URL);
                console.log('ğŸ”‘ Token:', API_TOKEN ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®');
                console.log('ğŸ’¬ ä¼šè¯ID:', conversationId || 'æ— ');
                
                if (!API_TOKEN) {
                    console.error('âŒ è¯·å…ˆè®¾ç½®Token: setAPIToken("your_token_here")');
                    return;
                }
                
                await sendMessageToAPI(message);
            };
            
            // å¯åŠ¨æ—¶æ£€æŸ¥é…ç½®
            console.log('=== æ™ºç³–å°åŠ©æ‰‹ - å¯¹è¯ç³»ç»Ÿ ===');
            console.log('ğŸ“ APIåœ°å€:', API_BASE_URL);
            console.log('ğŸ”‘ TokençŠ¶æ€:', API_TOKEN ? 'å·²è®¾ç½® âœ“' : 'æœªè®¾ç½® âœ—');
            console.log('ğŸ‘¤ ç”¨æˆ·ID:', cachedUserId || 'æœªçŸ¥');
            console.log('ğŸ’¬ ä¼šè¯ID:', conversationId || 'æ— ï¼ˆé¦–æ¬¡å¯¹è¯ï¼‰');
            console.log('\nğŸ’¡ è°ƒè¯•å‘½ä»¤:');
            console.log('  - setAPIToken("token")  // è®¾ç½®API Token');
            console.log('  - clearConversation()   // æ¸…é™¤ä¼šè¯ID');
            console.log('  - getConversationId()   // æŸ¥çœ‹å½“å‰ä¼šè¯ID');
            console.log('  - testAPI("æ¶ˆæ¯å†…å®¹")   // æµ‹è¯•å‘é€æ¶ˆæ¯');
            console.log('================================\n');


            // ============ æœºå™¨äººåŠŸèƒ½ ============

            // åˆå§‹åŒ–æœºå™¨äººåŠŸèƒ½
            function initializeRobotFeatures() {
                // åˆå§‹åŒ–UIæ˜¾ç¤º
                RobotConfig.updateUI();

                // è®¾ç½®è¯­é€Ÿæ»‘å—
                const currentSpeed = RobotConfig.getCurrentSpeed();
                speedSlider.value = currentSpeed;
                speedValue.textContent = currentSpeed + 'x';

                // ç”Ÿæˆæœºå™¨äººé€‰é¡¹
                renderRobotOptions();

                console.log('ğŸ¤– æœºå™¨äººåŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
            }

            // ç”Ÿæˆæœºå™¨äººé€‰é¡¹
            function renderRobotOptions() {
                robotOptions.innerHTML = '';

                Object.values(RobotConfig.robots).forEach(robot => {
                    const isSelected = RobotConfig.getCurrentRobot().id === robot.id;

                    const robotOption = document.createElement('div');
                    robotOption.className = `flex items-center p-3 rounded-lg border-2 cursor-pointer transition-all ${
                        isSelected ? 'border-primary bg-blue-50' : 'border-gray-200 hover:border-gray-300'
                    }`;
                    robotOption.onclick = () => selectRobot(robot.id);

                    robotOption.innerHTML = `
                        <img src="${robot.avatar}" alt="${robot.name}"
                             class="w-12 h-12 rounded-full object-cover mr-3">
                        <div class="flex-1">
                            <div class="font-medium text-gray-800">${robot.name}</div>
                            <div class="text-sm text-gray-500">${robot.description}</div>
                        </div>
                        ${isSelected ? '<i class="fas fa-check text-primary ml-2"></i>' : ''}
                    `;

                    robotOptions.appendChild(robotOption);
                });
            }

            // é€‰æ‹©æœºå™¨äºº
            function selectRobot(robotId) {
                RobotConfig.setCurrentRobot(robotId);
                renderRobotOptions();
                showToast(`å·²åˆ‡æ¢åˆ° ${RobotConfig.getCurrentRobot().name}`, 'success');
            }

            // ============ äº‹ä»¶ç›‘å¬å™¨ ============

            // æœºå™¨äººå¤´åƒæŒ‰é’®å’Œåˆ‡æ¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            robotAvatarBtn.addEventListener('click', function() {
                openRobotModal();
            });

            robotSwitchBtn.addEventListener('click', function() {
                openRobotModal();
            });

            // å…³é—­æœºå™¨äººå¼¹çª—
            closeRobotModalBtn.addEventListener('click', function() {
                closeRobotModal();
            });

            // ç‚¹å‡»èƒŒæ™¯å…³é—­æœºå™¨äººå¼¹çª—
            robotModal.addEventListener('click', function(e) {
                if (e.target === robotModal) {
                    closeRobotModal();
                }
            });

            // è¯­é€Ÿæ»‘å—å˜åŒ–äº‹ä»¶
            speedSlider.addEventListener('input', function() {
                const speed = parseFloat(this.value);
                speedValue.textContent = speed.toFixed(1) + 'x';
                RobotConfig.setCurrentSpeed(speed);
            });

            // æ‰“å¼€æœºå™¨äººå¼¹çª—
            function openRobotModal() {
                robotModal.classList.remove('hidden');
                // æ›´æ–°è¯­é€Ÿæ˜¾ç¤º
                const currentSpeed = RobotConfig.getCurrentSpeed();
                speedSlider.value = currentSpeed;
                speedValue.textContent = currentSpeed.toFixed(1) + 'x';
            }

            // å…³é—­æœºå™¨äººå¼¹çª—
            function closeRobotModal() {
                robotModal.classList.add('hidden');
            }

            // æ—¥å†æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            calendarBtn.addEventListener('click', function() {
                openCheckinModal();
            });

            // å…³é—­å¼¹çª—
            closeModalBtn.addEventListener('click', function() {
                closeCheckinModal();
            });

            // ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹çª—
            checkinModal.addEventListener('click', function(e) {
                if (e.target === checkinModal) {
                    closeCheckinModal();
                }
            });

            // æ‰“å¡å¼¹çª—äº‹ä»¶
            closeCheckinPopupBtn.addEventListener('click', function() {
                closeCheckinPopup();
            });

            checkinPopup.addEventListener('click', function(e) {
                if (e.target === checkinPopup) {
                    closeCheckinPopup();
                }
            });

            // æ§ç³–çŠ¶æ€é€‰æ‹©
            let selectedGlucoseStatus = null;
            glucoseStatusBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    // ç§»é™¤å…¶ä»–æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
                    glucoseStatusBtns.forEach(b => b.classList.remove('bg-primary'));
                    glucoseStatusBtns.forEach(b => b.classList.add('bg-gray-100'));

                    // è®¾ç½®å½“å‰æŒ‰é’®ä¸ºé€‰ä¸­çŠ¶æ€ï¼ˆåªæ”¹å˜èƒŒæ™¯è‰²ï¼Œä¿æŒæ–‡å­—é¢œè‰²ä¸å˜ï¼‰
                    this.classList.remove('bg-gray-100');
                    this.classList.add('bg-primary');

                    selectedGlucoseStatus = this.dataset.status;
                });
            });

            // æ„Ÿå—æ–‡å­—è®¡æ•°
            feelingText.addEventListener('input', function() {
                const count = this.value.length;
                feelingCount.textContent = count;
                if (count > 180) {
                    feelingCount.classList.add('text-red-500');
                } else {
                    feelingCount.classList.remove('text-red-500');
                }
            });

            // æäº¤æ‰“å¡
            submitCheckinBtn.addEventListener('click', function() {
                const feeling = feelingText.value.trim();
                if (!selectedGlucoseStatus) {
                    alert('è¯·é€‰æ‹©ä»Šå¤©çš„æ§ç³–çŠ¶æ€');
                    return;
                }
                handleCheckin(selectedGlucoseStatus, feeling);
            });

            // å¿«æ·æ‰“å¡æŒ‰é’® - æ˜¾ç¤ºæ‰“å¡å¼¹çª—
            quickCheckinBtn.addEventListener('click', function() {
                showCheckinPopup();
            });


            // æ˜¾ç¤ºæ‰“å¡å¼¹çª—
            function showCheckinPopup() {
                // é‡ç½®çŠ¶æ€
                selectedGlucoseStatus = null;
                glucoseStatusBtns.forEach(btn => {
                    // é‡ç½®ä¸ºé»˜è®¤æ ·å¼ï¼šç°è‰²èƒŒæ™¯ï¼Œä¿æŒåŸæœ‰æ–‡å­—é¢œè‰²
                    btn.classList.remove('bg-primary');
                    btn.classList.add('bg-gray-100');
                });
                feelingText.value = '';
                feelingCount.textContent = '0';
                feelingCount.classList.remove('text-red-500');

                checkinPopup.classList.remove('hidden');
            }

            // å…³é—­æ‰“å¡å¼¹çª—
            function closeCheckinPopup() {
                checkinPopup.classList.add('hidden');
            }

            // æ‰“å¡å¤„ç†å‡½æ•°
            async function handleCheckin(glucoseStatus = null, feelingText = '') {
                console.log('å¼€å§‹æ‰“å¡å¤„ç†...');

                const now = new Date();
                const today = formatDate(now);

                console.log('ä»Šæ—¥æ—¥æœŸ:', today);
                console.log('æ§ç³–çŠ¶æ€:', glucoseStatus);
                console.log('æ„Ÿå—æ–‡å­—:', feelingText);
                console.log('æœ¬åœ°æ‰“å¡æ•°æ®:', checkinData);

                // å…³é—­å¼¹çª—
                closeCheckinPopup();

                // ç›´æ¥è°ƒç”¨åç«¯APIï¼ˆè®©åç«¯æ¥åˆ¤æ–­æ˜¯å¦é‡å¤ï¼‰
                try {
                    const token = AppConfig.getToken();
                    console.log('è·å–åˆ°çš„token:', token);

                    const requestData = {
                        checkin_type: 'blood_glucose',
                        checkin_value: `æ—¥å¸¸æ‰“å¡ - ${formatTime(now)}`,
                        glucose_status: glucoseStatus,
                        feeling_text: feelingText
                    };
                    console.log('å‘é€çš„è¯·æ±‚æ•°æ®:', requestData);

                    const response = await fetch(`${AppConfig.getApiUrl('/api/checkin')}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        credentials: 'include',
                        body: JSON.stringify(requestData)
                    });

                    console.log('APIå“åº”çŠ¶æ€:', response.status);

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('APIé”™è¯¯å“åº”:', errorData);
                        
                        // å¦‚æœæ˜¯"ä»Šå¤©å·²ç»æ‰“å¡è¿‡è¯¥ç±»å‹äº†"ï¼Œç»™å‡ºå‹å¥½æç¤º
                        if (errorData.message && errorData.message.includes('å·²ç»æ‰“å¡')) {
                            showTypingIndicator();
                            setTimeout(() => {
                                hideTypingIndicator();
                                addAIMessage('æ‚¨ä»Šå¤©å·²ç»æ‰“å¡è¿‡äº†ï¼ç»§ç»­ä¿æŒå“¦ ğŸ’ª æ¯ç§ç±»å‹æ¯å¤©åªèƒ½æ‰“å¡ä¸€æ¬¡~');
                            }, 800);
                            return;
                        }
                        
                        throw new Error(errorData.message || 'æ‰“å¡å¤±è´¥');
                    }

                    const result = await response.json();
                    console.log('APIæˆåŠŸå“åº”:', result);

                    // æ·»åŠ åˆ°æœ¬åœ°æ‰“å¡è®°å½•
                    checkinData.push({
                        date: today,
                        time: formatTime(now),
                        timestamp: now.getTime(),
                        checkin_type: 'blood_glucose',
                        checkin_value: requestData.checkin_value || `æ—¥å¸¸æ‰“å¡ - ${formatTime(now)}`,
                        glucose_status: glucoseStatus, // æ§ç³–çŠ¶æ€
                        feeling_text: feelingText, // æ„Ÿå—æ–‡å­—
                        points_earned: result.points_earned || 0,
                        synced: true, // æ ‡è®°ä¸ºå·²åŒæ­¥åˆ°åç«¯
                        backend_id: result.record_id // ä¿å­˜åç«¯è®°å½•ID
                    });

                    // ä¿å­˜åˆ°localStorage
                    localStorage.setItem('checkinData', JSON.stringify(checkinData));

                    // AIå›å¤ - æ ¹æ®æ§ç³–çŠ¶æ€å’Œæ„Ÿå—ä¸ªæ€§åŒ–å›å¤
                    showTypingIndicator();
                    setTimeout(() => {
                        hideTypingIndicator();
                        const continuousDays = calculateContinuousDays();
                        const pointsText = result.points_earned ? ` è·å¾— ${result.points_earned} ç§¯åˆ†ï¼` : '';
                        const currentPoints = result.current_points || 0;

                        let aiMessage = `æ‰“å¡æˆåŠŸï¼ğŸ‰ æ‚¨å·²è¿ç»­æ‰“å¡ ${continuousDays} å¤©ï¼Œç»§ç»­åŠ æ²¹ï¼${pointsText}`;

                        // æ ¹æ®æ§ç³–çŠ¶æ€æ·»åŠ ä¸ªæ€§åŒ–å›å¤
                        if (glucoseStatus) {
                            switch (glucoseStatus) {
                                case 'å¥½':
                                    aiMessage += '\n\nğŸ’š å¤ªæ£’äº†ï¼è¡€ç³–æ§åˆ¶å¾—å¾ˆå¥½ï¼Œç»§ç»­ä¿æŒè¿™æ ·çš„å¥½çŠ¶æ€ï¼æœ‰ä»€ä¹ˆä¿æŒçš„å¥½æ–¹æ³•å¯ä»¥åˆ†äº«ç»™å¤§å®¶å—ï¼Ÿ';
                                    break;
                                case 'è‰¯å¥½':
                                    aiMessage += '\n\nğŸ’› ä¸é”™å“¦ï¼è¡€ç³–æ§åˆ¶å¾—è¿˜ç®—ç¨³å®šï¼Œç»§ç»­åŠªåŠ›ä¿æŒå¥åº·çš„ç”Ÿæ´»ä¹ æƒ¯ï¼';
                                    break;
                                case 'ä¸€èˆ¬':
                                    aiMessage += '\n\nğŸ’™ ä»Šå¤©çŠ¶æ€ä¸€èˆ¬ï¼Œæ²¡å…³ç³»ï¼Œæ˜å¤©ä¼šæ›´å¥½ï¼æˆ‘ä»¬å¯ä»¥ä¸€èµ·æƒ³æƒ³æ€ä¹ˆæ”¹è¿›è¡€ç³–æ§åˆ¶å“¦~';
                                    break;
                            }
                        }

                        // æ·»åŠ æ„Ÿå—å›å¤
                        if (feelingText) {
                            aiMessage += '\n\nğŸ’¬ è°¢è°¢åˆ†äº«ä½ çš„æ„Ÿå—ï¼æˆ‘ä¼šä¸€ç›´é™ªä¼´ä½ ï¼Œæ”¯æŒä½ æ›´å¥½çš„ç®¡ç†ç³–å°¿ç—…ã€‚';
                        }

                        addAIMessage(aiMessage);
                    }, 800);

                    // æ›´æ–°ç»Ÿè®¡æ•°æ®å’Œbadge
                    updateCheckinStats();

                } catch (error) {
                    console.error('æ‰“å¡å¤±è´¥:', error);

                    // å¦‚æœåç«¯æ‰“å¡å¤±è´¥ï¼Œä»ç„¶ä¿å­˜åˆ°æœ¬åœ°ï¼ˆç¦»çº¿æ¨¡å¼ï¼‰
                    checkinData.push({
                        date: today,
                        time: formatTime(now),
                        timestamp: now.getTime(),
                        checkin_type: 'blood_glucose',
                        synced: false, // æ ‡è®°ä¸ºæœªåŒæ­¥
                        error: error.message
                    });

                    localStorage.setItem('checkinData', JSON.stringify(checkinData));

                    // æ›´æ–°åŒæ­¥æŒ‰é’®çŠ¶æ€
                    updateSyncButton();

                    // AIå›å¤ï¼ˆç¦»çº¿æ¨¡å¼ï¼‰
                    showTypingIndicator();
                    setTimeout(() => {
                        hideTypingIndicator();
                        addAIMessage('æ‰“å¡è®°å½•å·²ä¿å­˜åˆ°æœ¬åœ°ï¼ˆç¦»çº¿æ¨¡å¼ï¼‰ã€‚è¯·ç¨åè¿æ¥ç½‘ç»œåŒæ­¥æ•°æ®ã€‚ğŸ’¾');
                    }, 800);

                    // æ›´æ–°ç»Ÿè®¡æ•°æ®å’Œbadge
                    updateCheckinStats();
                }
            }

            // åŒæ­¥æœªåŒæ­¥çš„æ‰“å¡è®°å½•
            async function syncOfflineCheckins() {
                const offlineItems = checkinData.filter(item => !item.synced && item.error);

                if (offlineItems.length === 0) {
                    showToast('æ²¡æœ‰éœ€è¦åŒæ­¥çš„ç¦»çº¿æ•°æ®', 'info');
                    return;
                }

                let syncedCount = 0;
                for (const item of offlineItems) {
                    try {
                        const token = AppConfig.getToken();
                        const response = await fetch(`${AppConfig.getApiUrl('/api/checkin')}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            credentials: 'include',
                            body: JSON.stringify({
                                checkin_type: 'blood_glucose', // ä½¿ç”¨è¡€ç³–ç›‘æµ‹ç±»å‹ï¼ˆå­—ç¬¦ä¸²æ ¼å¼ï¼‰
                                checkin_value: `æ—¥å¸¸æ‰“å¡ - ${item.time}`
                            })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            item.synced = true;
                            item.points_earned = result.points_earned || 0;
                            delete item.error;
                            syncedCount++;
                        }
                    } catch (error) {
                        console.error('åŒæ­¥å•ä¸ªæ‰“å¡å¤±è´¥:', error);
                    }
                }

                localStorage.setItem('checkinData', JSON.stringify(checkinData));

                if (syncedCount > 0) {
                    showToast(`æˆåŠŸåŒæ­¥ ${syncedCount} æ¡æ‰“å¡è®°å½•`, 'success');
                    // æ›´æ–°ç»Ÿè®¡æ•°æ®å’Œbadge
                    updateCheckinStats();
                    updateSyncButton();
                } else {
                    showToast('åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                }
                }
            

            // æ‰“å¼€æ‰“å¡è®°å½•å¼¹çª—
            async function openCheckinModal() {
                checkinModal.classList.remove('hidden');

                // æ˜¾ç¤ºloadingçŠ¶æ€
                showCalendarLoading();

                try {
                    // ä»åç«¯åŠ è½½æ‰“å¡è®°å½•ï¼Œå¹¶ä¸æœ¬åœ°è®°å½•åˆå¹¶
                    await loadCheckinFromBackend();

                    // æ¸²æŸ“å®Œæˆåéšè—loadingï¼Œæ˜¾ç¤ºæ—¥å†
                    hideCalendarLoading();
                    renderCalendar();
                    updateCheckinStats();
                    updateSyncButton();
                } catch (error) {
                    console.error('åŠ è½½æ‰“å¡æ•°æ®å¤±è´¥:', error);
                    hideCalendarLoading();
                    // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                    showCalendarError();
                }
            }

            // ä»åç«¯åŠ è½½æ‰“å¡è®°å½•å¹¶ä¸æœ¬åœ°è®°å½•åˆå¹¶
            async function loadCheckinFromBackend() {
                try {
                    console.log("ğŸ”„ å¼€å§‹ä»åç«¯åŠ è½½æ‰“å¡è®°å½•...");
                    const backendRecords = await loadCheckinRecords();
                    console.log("ğŸ“¦ åç«¯è¿”å›çš„åŸå§‹è®°å½•:", backendRecords);

                    // å°†åç«¯è®°å½•è½¬æ¢ä¸ºæœ¬åœ°æ ¼å¼
                    const formattedBackendRecords = backendRecords.map(record => {
                        // è§£ææ—¶é—´æˆ³ï¼ˆæ ¼å¼: "2025-11-14 02:21:27"ï¼‰
                        let date = '';
                        let time = '';
                        let timestamp = Date.now();
                        
                        if (record.timestamp) {
                            // å¤„ç†ä¸¤ç§æ ¼å¼: "2025-11-14 02:21:27" æˆ– ISOæ ¼å¼ "2025-11-14T02:21:27"
                            const timestampStr = record.timestamp.replace('T', ' '); // ç»Ÿä¸€ä¸ºç©ºæ ¼åˆ†éš”
                            const parts = timestampStr.split(' ');
                            if (parts.length >= 2) {
                                date = parts[0]; // "2025-11-14"
                                time = parts[1]; // "02:21:27"
                            }
                            
                            // è½¬æ¢ä¸ºæ—¶é—´æˆ³ï¼ˆå…¼å®¹å¤šç§æ ¼å¼ï¼‰
                            const dateObj = new Date(record.timestamp);
                            if (!isNaN(dateObj.getTime())) {
                                timestamp = dateObj.getTime();
                            }
                        }
                        
                        return {
                            date: date || formatDate(new Date()),
                            time: time || formatTime(new Date()),
                            timestamp: timestamp,
                            checkin_type: record.checkin_type || 'blood_glucose',
                            checkin_value: record.checkin_value || '',
                            glucose_status: record.glucose_status, // æ§ç³–çŠ¶æ€
                            feeling_text: record.feeling_text, // æ„Ÿå—æ–‡å­—
                            synced: true, // åç«¯è®°å½•æ ‡è®°ä¸ºå·²åŒæ­¥
                            backend_id: record.record_id, // ä¿å­˜åç«¯ID
                            points_earned: record.points_earned || 0 // å¦‚æœæœ‰ç§¯åˆ†ä¿¡æ¯
                        };
                    });

                    // åˆå¹¶æœ¬åœ°è®°å½•å’Œåç«¯è®°å½•ï¼ˆé¿å…é‡å¤ï¼‰
                    // ä½¿ç”¨åç«¯è®°å½•ä½œä¸ºä¸»è¦æ•°æ®æºï¼ˆå› ä¸ºåç«¯æ•°æ®æ›´å‡†ç¡®ï¼‰
                    const mergedRecords = [...formattedBackendRecords];
                    
                    // åˆ›å»ºåç«¯IDé›†åˆï¼Œç”¨äºå»é‡
                    const backendIds = new Set(formattedBackendRecords.map(r => r.backend_id));

                    // å°†æœ¬åœ°æœªåŒæ­¥çš„è®°å½•ä¹ŸåŠ å…¥ï¼ˆæ’é™¤å·²å­˜åœ¨çš„åç«¯è®°å½•ï¼‰
                    const unsyncedRecords = checkinData.filter(item => 
                        !item.synced && 
                        (!item.backend_id || !backendIds.has(item.backend_id))
                    );
                    mergedRecords.push(...unsyncedRecords);

                    // æ›´æ–°æœ¬åœ°å­˜å‚¨
                    checkinData = mergedRecords;
                    localStorage.setItem('checkinData', JSON.stringify(checkinData));

                    console.log("âœ… æ‰“å¡è®°å½•åŠ è½½å®Œæˆ:", mergedRecords.length, "æ¡è®°å½•");
                    console.log("ğŸ“‹ è®°å½•è¯¦æƒ…:", mergedRecords.slice(0, 3)); // æ‰“å°å‰3æ¡è®°å½•ç”¨äºè°ƒè¯•
                    console.log("ğŸ’¾ å·²æ›´æ–°checkinDataå˜é‡:", checkinData.length, "æ¡è®°å½•");

                } catch (error) {
                    console.error("âŒ ä»åç«¯åŠ è½½æ‰“å¡è®°å½•å¤±è´¥:", error);
                    // å¦‚æœåç«¯åŠ è½½å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨æœ¬åœ°è®°å½•
                }
            }

            // æ›´æ–°åŒæ­¥æŒ‰é’®çŠ¶æ€
            function updateSyncButton() {
                const syncBtn = document.querySelector('#sync-btn');
                const offlineItems = checkinData.filter(item => !item.synced && item.error);

                if (offlineItems.length > 0) {
                    syncBtn.innerHTML = `<i class="fas fa-sync-alt mr-1"></i>åŒæ­¥(${offlineItems.length})`;
                    syncBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    syncBtn.classList.add('bg-orange-500', 'hover:bg-orange-600');
                } else {
                    syncBtn.innerHTML = '<i class="fas fa-sync-alt mr-1"></i>åŒæ­¥';
                    syncBtn.classList.remove('bg-orange-500', 'hover:bg-orange-600');
                    syncBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                }
            }


            // æ˜¾ç¤ºæ—¥å†loadingçŠ¶æ€
            function showCalendarLoading() {
                const loadingEl = document.getElementById('calendar-loading');
                const gridEl = document.getElementById('calendar-grid');
                if (loadingEl) loadingEl.style.display = 'flex';
                if (gridEl) gridEl.style.display = 'none';
            }

            // éšè—æ—¥å†loadingçŠ¶æ€
            function hideCalendarLoading() {
                const loadingEl = document.getElementById('calendar-loading');
                const gridEl = document.getElementById('calendar-grid');
                if (loadingEl) loadingEl.style.display = 'none';
                if (gridEl) gridEl.style.display = 'grid';
            }

            // æ˜¾ç¤ºæ—¥å†é”™è¯¯çŠ¶æ€
            function showCalendarError() {
                const loadingEl = document.getElementById('calendar-loading');
                if (loadingEl) {
                    loadingEl.innerHTML = `
                        <div class="flex flex-col items-center space-y-3">
                            <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
                            <div class="text-sm text-red-600">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>
                        </div>
                    `;
                    loadingEl.style.display = 'flex';
                }
                const gridEl = document.getElementById('calendar-grid');
                if (gridEl) gridEl.style.display = 'none';
            }

            // å…³é—­æ‰“å¡è®°å½•å¼¹çª—
            function closeCheckinModal() {
                checkinModal.classList.add('hidden');
            }

            // æ¸²æŸ“æ—¥å†
            function renderCalendar() {
                const year = currentCalendarDate.getFullYear();
                const month = currentCalendarDate.getMonth();
                
                // æ›´æ–°æœˆä»½æ˜¾ç¤º
                document.querySelector('#current-month').textContent = year + 'å¹´' + (month + 1) + 'æœˆ';
                
                // è·å–å½“æœˆç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startWeekday = firstDay.getDay();
                
                // æ¸…ç©ºæ—¥å†
                const calendarGrid = document.querySelector('#calendar-grid');
                calendarGrid.innerHTML = '';
                
                // å¡«å……ç©ºç™½ï¼ˆæœˆåˆç©ºç™½ï¼‰
                for (let i = 0; i < startWeekday; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.className = 'aspect-square';
                    calendarGrid.appendChild(emptyCell);
                }
                
                // å¡«å……æ—¥æœŸ
                const today = formatDate(new Date());
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = formatDate(new Date(year, month, day));
                    const checkinRecord = checkinData.find(item => item.date === dateStr);

                    const dayCell = document.createElement('div');
                    dayCell.className = 'aspect-square flex items-center justify-center text-sm rounded-lg relative';

                    if (checkinRecord) {
                        // æœ‰æ‰“å¡è®°å½•ï¼Œæ ¹æ®æ§ç³–çŠ¶æ€æ˜¾ç¤ºä¸åŒé¢œè‰²çš„è¡¨æƒ…ï¼Œé»˜è®¤"å¥½"
                        const status = checkinRecord.glucose_status || 'å¥½'; // é»˜è®¤ä¸º"å¥½"
                        let emoji = '';
                        let bgColor = '';

                        switch (status) {
                            case 'å¥½':
                                emoji = 'ğŸ˜Š';
                                bgColor = 'bg-green-100 text-green-800 border-green-200';
                                break;
                            case 'è‰¯å¥½':
                                emoji = 'ğŸ™‚';
                                bgColor = 'bg-yellow-100 text-yellow-800 border-yellow-200';
                                break;
                            case 'ä¸€èˆ¬':
                                emoji = 'ğŸ˜';
                                bgColor = 'bg-gray-100 text-gray-800 border-gray-200';
                                break;
                            default:
                                emoji = 'ğŸ˜Š'; // é»˜è®¤ä¹Ÿç”¨"å¥½"çš„è¡¨æƒ…
                                bgColor = 'bg-green-100 text-green-800 border-green-200';
                        }

                        // å°†bgColorå­—ç¬¦ä¸²æŒ‰ç©ºæ ¼åˆ†å‰²ï¼Œç„¶ååˆ†åˆ«æ·»åŠ æ¯ä¸ªclass
                        bgColor.split(' ').forEach(className => {
                            dayCell.classList.add(className);
                        });
                        dayCell.classList.add('font-semibold', 'border');

                        // å¦‚æœæ˜¯ä»Šå¤©ï¼Œæ·»åŠ ç‰¹æ®Šçš„æ ·å¼
                        if (dateStr === today) {
                            dayCell.classList.add('ring-2', 'ring-blue-300');
                        }

                        dayCell.innerHTML = `${day}<br><span class="text-xs">${emoji}</span>`;
                    } else if (dateStr === today) {
                        dayCell.classList.add('bg-primary', 'text-white', 'font-bold');
                        dayCell.textContent = day;
                    } else {
                        dayCell.classList.add('text-gray-700');
                        dayCell.textContent = day;
                    }

                    calendarGrid.appendChild(dayCell);
                }

                // ğŸ”¥ å¼ºåˆ¶æ˜¾ç¤º6è¡Œï¼ˆ42ä¸ªå•å…ƒæ ¼ï¼‰- ç§»åŠ¨ç«¯é€‚é…
                const totalCells = calendarGrid.children.length; // å½“å‰å·²æ·»åŠ çš„å•å…ƒæ ¼æ•°
                const targetCells = 42; // ç›®æ ‡ï¼š6è¡Œ Ã— 7åˆ— = 42ä¸ªå•å…ƒæ ¼
                const remainingCells = targetCells - totalCells;

                // å¡«å……å‰©ä½™çš„ç©ºç™½å•å…ƒæ ¼ä»¥ç¡®ä¿æ˜¾ç¤ºå®Œæ•´çš„6è¡Œ
                for (let i = 0; i < remainingCells; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.className = 'aspect-square';
                    calendarGrid.appendChild(emptyCell);
                }
                
                console.log(`ğŸ“… æ—¥å†æ¸²æŸ“å®Œæˆ: ${year}å¹´${month+1}æœˆ, å…±${calendarGrid.children.length}ä¸ªå•å…ƒæ ¼ (åº”ä¸º42ä¸ª)`);
            }

            // ä¸Šä¸€æœˆ
            document.querySelector('#prev-month-btn').addEventListener('click', function() {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                renderCalendar();
            });

            // ä¸‹ä¸€æœˆ
            document.querySelector('#next-month-btn').addEventListener('click', function() {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                renderCalendar();
            });

            // æ›´æ–°æ‰“å¡ç»Ÿè®¡
            function updateCheckinStats() {
                // æ€»æ‰“å¡æ•°
                document.querySelector('#total-checkins').textContent = checkinData.length;

                // è¿ç»­å¤©æ•°
                const continuousDays = calculateContinuousDays();
                document.querySelector('#continuous-days').textContent = continuousDays;

                // æœ¬æœˆæ‰“å¡
                const now = new Date();
                const thisMonthCount = checkinData.filter(item => {
                    const itemDate = new Date(item.date);
                    return itemDate.getMonth() === now.getMonth() && itemDate.getFullYear() === now.getFullYear();
                }).length;
                document.querySelector('#this-month').textContent = thisMonthCount;

                // æ€»ç§¯åˆ†ï¼ˆåªè®¡ç®—å·²åŒæ­¥çš„è®°å½•ï¼‰
                const totalPoints = checkinData
                    .filter(item => item.synced && item.points_earned)
                    .reduce((sum, item) => sum + (item.points_earned || 0), 0);

                // æ›´æ–°æ€»ç§¯åˆ†æ˜¾ç¤ºï¼ˆå¦‚æœæœ‰ç§¯åˆ†å…ƒç´ çš„è¯ï¼‰
                const pointsElement = document.querySelector('#total-points');
                if (pointsElement) {
                    pointsElement.textContent = totalPoints;
                }

                // æ›´æ–°å³ä¸Šè§’æ‰“å¡badgeï¼ˆæ˜¾ç¤ºè¿ç»­æ‰“å¡å¤©æ•°ï¼‰
                updateCheckinBadge(continuousDays);
            }

            // æ›´æ–°å³ä¸Šè§’æ‰“å¡ç»Ÿè®¡badge
            function updateCheckinBadge(continuousDays) {
                const badge = document.querySelector('#checkin-badge');

                if (continuousDays > 0) {
                    badge.textContent = continuousDays;
                    badge.classList.remove('hidden');

                    // æ ¹æ®è¿ç»­å¤©æ•°æ”¹å˜é¢œè‰²
                    if (continuousDays >= 7) {
                        badge.classList.remove('bg-red-500', 'bg-orange-500');
                        badge.classList.add('bg-green-500');
                    } else if (continuousDays >= 3) {
                        badge.classList.remove('bg-red-500', 'bg-green-500');
                        badge.classList.add('bg-orange-500');
                    } else {
                        badge.classList.remove('bg-green-500', 'bg-orange-500');
                        badge.classList.add('bg-red-500');
                    }
                } else {
                    badge.classList.add('hidden');
                }
            }

            // è®¡ç®—è¿ç»­æ‰“å¡å¤©æ•°
            function calculateContinuousDays() {
                if (checkinData.length === 0) return 0;
                
                // æ’åºæ‰“å¡è®°å½•ï¼ˆä»æ–°åˆ°æ—§ï¼‰
                const sortedData = [...checkinData].sort((a, b) => b.timestamp - a.timestamp);
                
                let continuous = 0;
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                for (let i = 0; i < sortedData.length; i++) {
                    const checkDate = new Date(sortedData[i].date);
                    checkDate.setHours(0, 0, 0, 0);
                    
                    const diffDays = Math.floor((today - checkDate) / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === continuous) {
                        continuous++;
                    } else {
                        break;
                    }
                }
                
                return continuous;
            }


            // æ ¼å¼åŒ–æ—¥æœŸ YYYY-MM-DD
            function formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // æ ¼å¼åŒ–æ—¶é—´ HH:MM:SS
            function formatTime(date) {
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                return `${hours}:${minutes}:${seconds}`;
            }

            // æ ¼å¼åŒ–æ¶ˆæ¯æ—¶é—´æ˜¾ç¤ºï¼š3åˆ†é’Ÿå†…æ˜¾ç¤º"åˆšåˆš"ï¼Œè¶…è¿‡3åˆ†é’Ÿæ˜¾ç¤ºå…·ä½“æ—¶é—´
            function formatMessageTime(date) {
                // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
                if (!date || !(date instanceof Date) || isNaN(date.getTime())) {
                    console.warn('formatMessageTime: æ— æ•ˆçš„æ—¥æœŸå¯¹è±¡', date);
                    return 'æœªçŸ¥æ—¶é—´';
                }

                const now = new Date();
                const diffInMs = now - date;
                
                // å¦‚æœæ—¶é—´å·®ä¸ºè´Ÿæ•°ï¼ˆæœªæ¥æ—¶é—´ï¼‰ï¼Œç›´æ¥æ˜¾ç¤ºæ—¶é—´
                if (diffInMs < 0) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const currentYear = now.getFullYear();
                    if (year === currentYear) {
                        return `${month}-${day} ${hours}:${minutes}`;
                    } else {
                        return `${year}-${month}-${day} ${hours}:${minutes}`;
                    }
                }

                const diffInMinutes = Math.floor(diffInMs / (1000 * 60));
                const diffInHours = Math.floor(diffInMinutes / 60);
                const diffInDays = Math.floor(diffInHours / 24);

                if (diffInMinutes < 3) {
                    return 'åˆšåˆš';
                } else if (diffInMinutes < 60) {
                    return `${diffInMinutes}åˆ†é’Ÿå‰`;
                } else if (diffInHours < 24) {
                    return `${diffInHours}å°æ—¶å‰`;
                } else if (diffInDays === 1) {
                    return 'æ˜¨å¤©';
                } else if (diffInDays < 7) {
                    return `${diffInDays}å¤©å‰`;
                } else {
                    // å¯¹äºæ›´æ—©çš„æ¶ˆæ¯ï¼Œæ˜¾ç¤ºå…·ä½“æ—¥æœŸå’Œæ—¶é—´
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');

                    // å¦‚æœæ˜¯ä»Šå¹´ï¼Œå°±ä¸æ˜¾ç¤ºå¹´ä»½
                    const currentYear = now.getFullYear();
                    if (year === currentYear) {
                        return `${month}-${day} ${hours}:${minutes}`;
                    } else {
                        return `${year}-${month}-${day} ${hours}:${minutes}`;
                    }
                }
            }

            // è·å–æ‰“å¡ç±»å‹
            async function loadCheckinTypes() {
                try {
                    console.log('ğŸ” loadCheckinTypes:');
                    console.log('   ğŸ”‘ API_TOKEN =', API_TOKEN ? API_TOKEN.substring(0, 50) + '...' : 'ç©º');
                    console.log('   ğŸ‘¤ cachedUserId =', cachedUserId || 'ç©º');

                    if (!API_TOKEN) {
                        console.error('âŒ æœªæ‰¾åˆ°API Token');
                        return [];
                    }

                    const response = await fetch(`${AppConfig.getApiUrl('/api/checkin/types')}`, {
                        headers: {
                            "Authorization": `Bearer ${API_TOKEN}`
                        },
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log("æ‰“å¡ç±»å‹åŠ è½½å®Œæˆ:", data);
                        return data.data?.types || [];
                    }
                } catch (error) {
                    console.error("è·å–æ‰“å¡ç±»å‹å¤±è´¥:", error);
                }
                return [];
            }

            // è·å–æ‰“å¡è®°å½•ï¼ˆä»åç«¯ï¼‰
            async function loadCheckinRecords() {
                try {
                    console.log('ğŸ” loadCheckinRecords:');
                    console.log('   ğŸ”‘ API_TOKEN =', API_TOKEN ? API_TOKEN.substring(0, 50) + '...' : 'ç©º');
                    console.log('   ğŸ‘¤ cachedUserId =', cachedUserId || 'ç©º');

                    if (!API_TOKEN) {
                        console.error('âŒ æœªæ‰¾åˆ°API Token');
                        return [];
                    }

                    const response = await fetch(`${AppConfig.getApiUrl('/api/checkin/records')}`, {
                        headers: {
                            "Authorization": `Bearer ${API_TOKEN}`
                        },
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log("æ‰“å¡è®°å½•åŠ è½½å®Œæˆ:", data);
                        return data.data?.records || [];
                    }
                } catch (error) {
                    console.error("è·å–æ‰“å¡è®°å½•å¤±è´¥:", error);
                }
                return [];
            }

            // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ‰“å¡åŠŸèƒ½
            // å…ˆåŠ è½½æ‰“å¡ç±»å‹ï¼Œå†åˆå§‹åŒ–æ‰“å¡åŠŸèƒ½
            loadCheckinTypes().then(() => {
                console.log("æ‰“å¡åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ");
            }).catch(error => {
                console.error("æ‰“å¡åŠŸèƒ½åˆå§‹åŒ–å¤±è´¥:", error);
            });
        });
    </script>
</body>
</html>
