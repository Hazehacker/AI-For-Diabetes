<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºç³–å°åŠ©æ‰‹ - æ³¨å†Œ</title>
    <script src="libs/tailwindcss.js"></script>
    <script src="libs/fontawesome.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#969FFF',
                        secondary: '#5147FF', 
                        accent: '#3E3987',
                        success: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444'
                    },
                    backgroundImage: {
                        'gradient-primary': 'linear-gradient(135deg, #969FFF 0%, #5147FF 100%)',
                        'gradient-secondary': 'linear-gradient(135deg, #5147FF 0%, #3E3987 100%)',
                        'gradient-card': 'linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%)',
                        'gradient-hero': 'linear-gradient(135deg, #969FFF 0%, #5147FF 50%, #3E3987 100%)'
                    },
                    boxShadow: {
                        'card': '0 4px 20px rgba(150, 159, 255, 0.1)',
                        'button': '0 4px 15px rgba(150, 159, 255, 0.3)',
                        'nav': '0 -2px 20px rgba(150, 159, 255, 0.1)'
                    }
                }
            }
        }
    </script>
    <style>
        .safe-top {
            padding-top: env(safe-area-inset-top);
        }
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #969FFF 0%, #5147FF 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .form-input-focus:focus {
            outline: none;
            border-color: #969FFF;
            box-shadow: 0 0 0 2px rgba(150, 159, 255, 0.2);
        }
        
        .button-hover:active {
            transform: scale(0.98);
            transition: transform 0.1s ease;
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .password-strength {
            height: 4px;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .strength-weak { background: #EF4444; width: 33%; }
        .strength-medium { background: #F59E0B; width: 66%; }
        .strength-strong { background: #10B981; width: 100%; }
    </style>
    <script src="config.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div id="main-content" class="min-h-screen flex flex-col">
        <!-- é¡¶éƒ¨LogoåŒºåŸŸ -->
        <header id="logo-header" class="flex-1 flex flex-col justify-center items-center px-6 py-12">
            <!-- App Logo -->
            <div id="app-logo" class="text-center mb-8">
                <div class="w-24 h-24 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-card overflow-hidden bg-white">
                    <img src="/logo.png" 
                         alt="æ™ºç³–å°åŠ©æ‰‹ Logo" 
                         class="w-full h-full object-contain">
                </div>
                <h1 id="app-name" class="text-3xl font-bold gradient-text mb-2">æ™ºç³–å°åŠ©æ‰‹</h1>
                <p id="app-slogan" class="text-gray-600 text-sm">æ¬¢è¿åŠ å…¥æ™ºèƒ½ç³–å°¿ç—…ç®¡ç†</p>
            </div>

            <!-- æ³¨å†Œè¡¨å• -->
            <div id="register-form-container" class="w-full max-w-sm">
                <form id="register-form" class="space-y-5">
                    <!-- ç”¨æˆ·åè¾“å…¥æ¡† -->
                    <div id="username-field" class="space-y-2">
                        <label for="username" class="block text-sm font-medium text-gray-700">ç”¨æˆ·å</label>
                        <div class="relative">
                            <input type="text" 
                                   id="username" 
                                   name="username" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl form-input-focus bg-white text-gray-800 placeholder-gray-500" 
                                   placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
                                   required>
                            <div class="absolute right-3 top-1/2 transform -translate-y-1/2">
                                <i class="fas fa-user text-gray-400"></i>
                            </div>
                        </div>
                    </div>

                    <!-- æ˜µç§°è¾“å…¥æ¡† -->
                    <div id="nickname-field" class="space-y-2">
                        <label for="nickname" class="block text-sm font-medium text-gray-700">æ˜µç§°ï¼ˆå¯é€‰ï¼‰</label>
                        <div class="relative">
                            <input type="text" 
                                   id="nickname" 
                                   name="nickname" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl form-input-focus bg-white text-gray-800 placeholder-gray-500" 
                                   placeholder="è¯·è¾“å…¥æ˜µç§°">
                            <div class="absolute right-3 top-1/2 transform -translate-y-1/2">
                                <i class="fas fa-id-badge text-gray-400"></i>
                            </div>
                        </div>
                    </div>

                    <!-- æ‰‹æœºå·è¾“å…¥æ¡† -->
                    <div id="phone-field" class="space-y-2">
                        <label for="phone_number" class="block text-sm font-medium text-gray-700">æ‰‹æœºå·ï¼ˆå¯é€‰ï¼‰</label>
                        <div class="relative">
                            <input type="tel" 
                                   id="phone_number" 
                                   name="phone_number" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl form-input-focus bg-white text-gray-800 placeholder-gray-500" 
                                   placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
                                   pattern="[0-9]{11}">
                            <div class="absolute right-3 top-1/2 transform -translate-y-1/2">
                                <i class="fas fa-mobile-alt text-gray-400"></i>
                            </div>
                        </div>
                    </div>

                    <!-- é‚®ç®±è¾“å…¥æ¡† -->
                    <div id="email-field" class="space-y-2">
                        <label for="email" class="block text-sm font-medium text-gray-700">é‚®ç®±ï¼ˆå¯é€‰ï¼‰</label>
                        <div class="relative">
                            <input type="email" 
                                   id="email" 
                                   name="email" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl form-input-focus bg-white text-gray-800 placeholder-gray-500" 
                                   placeholder="è¯·è¾“å…¥é‚®ç®±">
                            <div class="absolute right-3 top-1/2 transform -translate-y-1/2">
                                <i class="fas fa-envelope text-gray-400"></i>
                            </div>
                        </div>
                    </div>

                    <!-- å¯†ç è¾“å…¥æ¡† -->
                    <div id="password-field" class="space-y-2">
                        <label for="password" class="block text-sm font-medium text-gray-700">å¯†ç </label>
                        <div class="relative">
                            <input type="password" 
                                   id="password" 
                                   name="password" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl form-input-focus bg-white text-gray-800 placeholder-gray-500 pr-12" 
                                   placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰"
                                   minlength="6"
                                   required>
                            <button type="button" 
                                    id="toggle-password" 
                                    class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <!-- å¯†ç å¼ºåº¦æŒ‡ç¤ºå™¨ -->
                        <div class="w-full bg-gray-200 rounded-full h-1 overflow-hidden">
                            <div id="password-strength-bar" class="password-strength"></div>
                        </div>
                        <p id="password-strength-text" class="text-xs text-gray-500"></p>
                    </div>

                    <!-- ç¡®è®¤å¯†ç è¾“å…¥æ¡† -->
                    <div id="confirm-password-field" class="space-y-2">
                        <label for="confirm_password" class="block text-sm font-medium text-gray-700">ç¡®è®¤å¯†ç </label>
                        <div class="relative">
                            <input type="password" 
                                   id="confirm_password" 
                                   name="confirm_password" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl form-input-focus bg-white text-gray-800 placeholder-gray-500 pr-12" 
                                   placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç "
                                   required>
                            <button type="button" 
                                    id="toggle-confirm-password" 
                                    class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <!-- æ³¨å†ŒæŒ‰é’® -->
                    <button type="submit" 
                            id="register-btn" 
                            class="w-full bg-gradient-primary text-white py-3 rounded-xl font-medium shadow-button button-hover flex items-center justify-center space-x-2">
                        <span>æ³¨å†Œ</span>
                        <i class="fas fa-user-plus"></i>
                    </button>

                    <!-- è¿”å›ç™»å½•é“¾æ¥ -->
                    <div class="text-center">
                        <a href="/login" class="text-sm text-primary hover:text-secondary transition-colors">
                            å·²æœ‰è´¦å·ï¼Ÿç«‹å³ç™»å½•
                        </a>
                    </div>
                </form>
            </div>
        </header>

        <!-- åº•éƒ¨å®‰å…¨åŒºåŸŸ -->
        <div id="bottom-safe-area" class="safe-bottom"></div>
    </div>

    <!-- åŠ è½½æç¤º -->
    <div id="loading-overlay" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 flex flex-col items-center space-y-3">
            <div class="w-8 h-8 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>
            <p class="text-gray-700">æ­£åœ¨æ³¨å†Œ...</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // APIé…ç½®
            const API_BASE_URL = AppConfig.API.BASE_URL;
            
            // å¯†ç æ˜¾ç¤º/éšè—åˆ‡æ¢
            document.querySelector('#toggle-password').addEventListener('click', function() {
                const passwordInput = document.querySelector('#password');
                const icon = this.querySelector('i');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    passwordInput.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });

            document.querySelector('#toggle-confirm-password').addEventListener('click', function() {
                const confirmPasswordInput = document.querySelector('#confirm_password');
                const icon = this.querySelector('i');
                
                if (confirmPasswordInput.type === 'password') {
                    confirmPasswordInput.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    confirmPasswordInput.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });

            // å¯†ç å¼ºåº¦æ£€æµ‹
            document.querySelector('#password').addEventListener('input', function() {
                const password = this.value;
                const strengthBar = document.querySelector('#password-strength-bar');
                const strengthText = document.querySelector('#password-strength-text');
                
                if (password.length === 0) {
                    strengthBar.className = 'password-strength';
                    strengthText.textContent = '';
                    return;
                }
                
                let strength = 0;
                if (password.length >= 6) strength++;
                if (password.length >= 10) strength++;
                if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
                if (/[0-9]/.test(password)) strength++;
                if (/[^a-zA-Z0-9]/.test(password)) strength++;
                
                strengthBar.className = 'password-strength';
                if (strength <= 2) {
                    strengthBar.classList.add('strength-weak');
                    strengthText.textContent = 'å¯†ç å¼ºåº¦ï¼šå¼±';
                    strengthText.className = 'text-xs text-danger';
                } else if (strength <= 3) {
                    strengthBar.classList.add('strength-medium');
                    strengthText.textContent = 'å¯†ç å¼ºåº¦ï¼šä¸­';
                    strengthText.className = 'text-xs text-warning';
                } else {
                    strengthBar.classList.add('strength-strong');
                    strengthText.textContent = 'å¯†ç å¼ºåº¦ï¼šå¼º';
                    strengthText.className = 'text-xs text-success';
                }
            });

            // æ³¨å†Œè¡¨å•æäº¤
            document.querySelector('#register-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const username = document.querySelector('#username').value.trim();
                const nickname = document.querySelector('#nickname').value.trim();
                const phone_number = document.querySelector('#phone_number').value.trim();
                const email = document.querySelector('#email').value.trim();
                const password = document.querySelector('#password').value.trim();
                const confirmPassword = document.querySelector('#confirm_password').value.trim();
                
                // éªŒè¯
                if (!username) {
                    alert('è¯·è¾“å…¥ç”¨æˆ·å');
                    return;
                }
                
                if (!password) {
                    alert('è¯·è¾“å…¥å¯†ç ');
                    return;
                }

                if (password.length < 6) {
                    alert('å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä½');
                    return;
                }
                
                if (password !== confirmPassword) {
                    alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                    return;
                }

                // éªŒè¯æ‰‹æœºå·æ ¼å¼ï¼ˆå¦‚æœå¡«å†™äº†ï¼‰
                if (phone_number && !/^1[3-9]\d{9}$/.test(phone_number)) {
                    alert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·æ ¼å¼');
                    return;
                }

                // éªŒè¯é‚®ç®±æ ¼å¼ï¼ˆå¦‚æœå¡«å†™äº†ï¼‰
                if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    alert('è¯·è¾“å…¥æ­£ç¡®çš„é‚®ç®±æ ¼å¼');
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                document.querySelector('#loading-overlay').classList.remove('hidden');
                document.querySelector('#register-btn').disabled = true;
                
                try {
                    console.log('ğŸ“¤ å‘é€æ³¨å†Œè¯·æ±‚...');
                    console.log('ğŸ‘¤ ç”¨æˆ·å:', username);
                    
                    // æ„å»ºè¯·æ±‚ä½“
                    const requestBody = {
                        username: username,
                        password: password
                    };

                    // æ·»åŠ å¯é€‰å­—æ®µ
                    if (nickname) requestBody.nickname = nickname;
                    if (phone_number) requestBody.phone_number = phone_number;
                    if (email) requestBody.email = email;
                    
                    // è°ƒç”¨åç«¯æ³¨å†ŒAPI
                    console.log('ğŸ” å‘é€è¯·æ±‚åˆ°:', AppConfig.getApiUrl('/api/register'));
                    const response = await fetch(`${AppConfig.getApiUrl('/api/register')}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify(requestBody)
                    });

                    console.log('ğŸ” å“åº”çŠ¶æ€:', response.status, response.statusText);

                    let data;
                    try {
                        const responseText = await response.text();
                        console.log('ğŸ” åŸå§‹å“åº”æ–‡æœ¬:', responseText);
                        data = JSON.parse(responseText);
                        console.log('ğŸ” è§£æåçš„æ•°æ®:', data);
                    } catch (parseError) {
                        console.error('âŒ JSONè§£æå¤±è´¥:', parseError);
                        throw new Error('å“åº”æ ¼å¼é”™è¯¯');
                    }

                    if (response.ok && data.success) {
                        console.log('âœ… æ³¨å†ŒæˆåŠŸ:', data);

                        // ä»å“åº”ä¸­è·å–æ•°æ®
                        const registerData = data.data || {};
                        const token = registerData.token;

                        if (token) {
                            // ä¿å­˜tokenåˆ°localStorage
                            AppConfig.setToken(token);
                            console.log('âœ… Tokenå·²ä¿å­˜åˆ°localStorage');
                        }

                        // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
                        if (registerData.user_id) {
                            localStorage.setItem(AppConfig.STORAGE_KEYS.USER_ID, registerData.user_id);
                            localStorage.setItem(AppConfig.STORAGE_KEYS.USERNAME, registerData.username || '');
                            localStorage.setItem('nickname', nickname || registerData.username || '');
                            console.log('âœ… ç”¨æˆ·ä¿¡æ¯å·²ä¿å­˜åˆ°localStorage');
                        }

                        // æ˜¾ç¤ºæˆåŠŸæç¤º
                        alert('æ³¨å†ŒæˆåŠŸï¼å³å°†è·³è½¬åˆ°èŠå¤©é¡µé¢...');

                        // çŸ­æš‚å»¶è¿Ÿåè·³è½¬
                        setTimeout(function() {
                            console.log('ğŸš€ è·³è½¬åˆ°å¯¹è¯é¡µé¢...');
                            window.location.href = AppConfig.getPath('/chat');
                        }, 1000);
                        
                    } else {
                        // æ³¨å†Œå¤±è´¥
                        console.error('âŒ æ³¨å†Œå¤±è´¥:', data.message);
                        alert(data.message || 'æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•');
                        
                        // éšè—åŠ è½½çŠ¶æ€
                        document.querySelector('#loading-overlay').classList.add('hidden');
                        document.querySelector('#register-btn').disabled = false;
                    }
                    
                } catch (error) {
                    console.error('âŒ æ³¨å†Œè¯·æ±‚å¤±è´¥:', error);
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ç½‘ç»œé”™è¯¯
                    if (error.message === 'Failed to fetch') {
                        alert('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ï¼š\n1. åç«¯æœåŠ¡æ˜¯å¦å·²å¯åŠ¨\n2. APIåœ°å€æ˜¯å¦æ­£ç¡®\n3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸');
                    } else {
                        alert('æ³¨å†Œå¤±è´¥ï¼š' + error.message);
                    }
                    
                    // éšè—åŠ è½½çŠ¶æ€
                    document.querySelector('#loading-overlay').classList.add('hidden');
                    document.querySelector('#register-btn').disabled = false;
                }
            });

            // è¾“å…¥æ¡†ç„¦ç‚¹æ•ˆæœ
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    this.parentElement.classList.add('ring-2', 'ring-primary/20');
                });
                
                input.addEventListener('blur', function() {
                    this.parentElement.classList.remove('ring-2', 'ring-primary/20');
                });
            });
        });
    </script>
</body>
</html>
