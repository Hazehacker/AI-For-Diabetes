# æ™ºç³–å°åŠ©æ‰‹ - åŸºäºç”¨æˆ·è®¤è¯çš„çŸ¥è¯†åº“API

## ğŸš€ å®‰å…¨å‡çº§è¯´æ˜

### ä¹‹å‰çš„å®ç°ï¼ˆä¸å®‰å…¨ï¼‰
- âŒ ä½¿ç”¨ç¡¬ç¼–ç çš„Dify API Key
- âŒ å‰ç«¯ç›´æ¥ä¼ é€’API Key
- âŒ æ‰€æœ‰ç”¨æˆ·ä½¿ç”¨ç›¸åŒæƒé™

### ç°åœ¨çš„å®ç°ï¼ˆå®‰å…¨ï¼‰
- âœ… åŸºäºç”¨æˆ·JWT tokenè®¤è¯
- âœ… æ¯ä¸ªç”¨æˆ·æœ‰ç‹¬ç«‹çš„Dify API Key
- âœ… ç®¡ç†å‘˜è‡ªåŠ¨åˆ†é…æƒé™
- âœ… æ•°æ®åº“çº§åˆ«çš„æƒé™æ§åˆ¶

## ğŸ”§ è®¾ç½®æ­¥éª¤

### 1. æ•°æ®åº“è¿ç§»
å·²æ‰§è¡Œæ•°æ®åº“è¿ç§»ï¼Œä¸ºç”¨æˆ·è¡¨æ·»åŠ äº†Difyç›¸å…³å­—æ®µï¼š
- `dify_api_key`: ç”¨æˆ·çš„Dify API Key
- `dify_dataset_id`: ç”¨æˆ·å¯è®¿é—®çš„æ•°æ®é›†ID
- `knowledge_permissions`: çŸ¥è¯†åº“æƒé™é…ç½®

ç®¡ç†å‘˜ç”¨æˆ·å·²è‡ªåŠ¨åˆ†é…é»˜è®¤çš„Dify API Keyã€‚

### 2. ç”¨æˆ·è®¤è¯æµç¨‹
1. ç”¨æˆ·é€šè¿‡å‰ç«¯ç™»å½•
2. ç³»ç»ŸéªŒè¯ç”¨æˆ·å/å¯†ç 
3. è¿”å›åŒ…å«`user_id`çš„JWT token
4. ç”¨æˆ·ä½¿ç”¨æ­¤tokenè°ƒç”¨çŸ¥è¯†åº“API
5. ç³»ç»Ÿæ ¹æ®`user_id`è·å–ç”¨æˆ·çš„Difyé…ç½®

## ğŸ“‹ APIä½¿ç”¨æŒ‡å—

### æ ¸å¿ƒåŠŸèƒ½
- âœ… **æ–‡ä»¶ä¸Šä¼ **: `POST /api/knowledge/upload`
- âœ… **æ•°æ®é›†æŸ¥è¯¢**: `GET /api/knowledge/datasets`
- âœ… **æ–‡ä»¶åˆ é™¤**: `DELETE /api/knowledge/files/{id}`
- âš ï¸ **å¯ç”¨/ç¦ç”¨**: `PATCH /api/knowledge/files/{id}/status` (æš‚æœªå®ç°)

### è·å–ç”¨æˆ·Token
```bash
# é€šè¿‡ç™»å½•APIè·å–token
POST /api/auth/login
{
  "username": "admin",
  "password": "your_password"
}
```

### ä½¿ç”¨Tokenè°ƒç”¨çŸ¥è¯†åº“API
```bash
# è®¾ç½®Authorizationå¤´
Authorization: Bearer [ç”¨æˆ·ç™»å½•token]

# ç¤ºä¾‹ï¼šè·å–æ•°æ®é›†åˆ—è¡¨
GET /api/knowledge/datasets?page=1&page_size=20
Authorization: Bearer [ç”¨æˆ·token]

# ç¤ºä¾‹ï¼šä¸Šä¼ æ–‡ä»¶
POST /api/knowledge/upload
Authorization: Bearer [ç”¨æˆ·token]
Content-Type: application/json

{
  "file_path": "/path/to/your/file.txt",
  "file_name": "optional_filename.txt",
  "dataset_id": "optional_dataset_id"
}

# ç¤ºä¾‹ï¼šåˆ é™¤æ–‡ä»¶
DELETE /api/knowledge/files/{file_id}?dataset_id={dataset_id}
Authorization: Bearer [ç”¨æˆ·token]
```

## ğŸ§ª æµ‹è¯•è„šæœ¬

è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š
```bash
# ä¿®æ”¹è„šæœ¬ä¸­çš„USER_TOKENå˜é‡
vim test_user_knowledge_api.sh

# è¿è¡Œæµ‹è¯•
./test_user_knowledge_api.sh
```

## ğŸ“Š Postman Collection

### å¯¼å…¥æ–¹æ³•
1. æ‰“å¼€Postman
2. ç‚¹å‡» "Import"
3. é€‰æ‹© `postman_collection.json` æ–‡ä»¶

### è®¾ç½®å˜é‡
åœ¨Postmanä¸­è®¾ç½®ä»¥ä¸‹å˜é‡ï¼š
- `user_token`: ç”¨æˆ·ç™»å½•åè·å–çš„JWT token
- `base_url`: `http://localhost:8900`
- `dataset_id`: `110b7e73-3050-49f4-b424-910951a016d9`

## ğŸ”’ å®‰å…¨ç‰¹æ€§

### è®¤è¯æœºåˆ¶
- JWT tokenéªŒè¯ç”¨æˆ·èº«ä»½
- è‡ªåŠ¨è¿‡æœŸå’Œåˆ·æ–°æœºåˆ¶
- æ— çŠ¶æ€çš„APIè®¾è®¡

### æƒé™æ§åˆ¶
- åŸºäºç”¨æˆ·çš„Dify API Keyåˆ†é…
- ç®¡ç†å‘˜è‡ªåŠ¨è·å¾—å®Œæ•´æƒé™
- æ”¯æŒç»†ç²’åº¦çš„æƒé™é…ç½®

### æ•°æ®éš”ç¦»
- æ¯ä¸ªç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„çŸ¥è¯†åº“
- æ•æ„Ÿä¿¡æ¯åœ¨æ•°æ®åº“ä¸­åŠ å¯†å­˜å‚¨
- APIè°ƒç”¨æ—¥å¿—è®°å½•å®¡è®¡

## ğŸ“ æ–‡ä»¶åˆ—è¡¨

- `main/services/knowledge_service.py` - çŸ¥è¯†åº“æœåŠ¡ï¼ˆåŸºäºç”¨æˆ·è®¤è¯ï¼‰
- `main/routes/knowledge.py` - çŸ¥è¯†åº“APIè·¯ç”±ï¼ˆ/api/knowledge/*ï¼‰
- `postman_collection.json` - Postmanæµ‹è¯•é›†åˆ
- `test_user_knowledge_api.sh` - è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
- `add_dify_api_key_to_users.sql` - æ•°æ®åº“è¿ç§»è„šæœ¬

## ğŸ¯ æ ¸å¿ƒæ”¹è¿›

1. **å®‰å…¨æ€§**: ä»ç¡¬ç¼–ç API Keyæ”¹ä¸ºåŸºäºç”¨æˆ·çš„åŠ¨æ€è®¤è¯
2. **æƒé™ç®¡ç†**: æ”¯æŒä¸åŒç”¨æˆ·çš„ä¸åŒçŸ¥è¯†åº“æƒé™
3. **å¯æ‰©å±•æ€§**: æ”¯æŒæœªæ¥æ·»åŠ æ›´å¤šç”¨æˆ·è§’è‰²å’Œæƒé™
4. **å®¡è®¡èƒ½åŠ›**: å®Œæ•´çš„APIè°ƒç”¨æ—¥å¿—è®°å½•

## ğŸš¨ æ³¨æ„äº‹é¡¹

- ç®¡ç†å‘˜ç”¨æˆ·å·²è‡ªåŠ¨é…ç½®Dify API Key
- æ™®é€šç”¨æˆ·éœ€è¦é€šè¿‡ç®¡ç†å‘˜åˆ†é…æƒé™
- Tokenæœ‰è¿‡æœŸæ—¶é—´ï¼Œéœ€è¦å®šæœŸåˆ·æ–°
- ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨HTTPSä¼ è¾“

## ğŸ’¡ ä½¿ç”¨å»ºè®®

1. å…ˆé€šè¿‡å‰ç«¯ç™»å½•è·å–ç”¨æˆ·token
2. åœ¨Postmanä¸­è®¾ç½®user_tokenå˜é‡
3. é€ä¸ªæµ‹è¯•çŸ¥è¯†åº“APIåŠŸèƒ½
4. éªŒè¯èŠå¤©æ¥å£çš„çŸ¥è¯†åº“é›†æˆæ•ˆæœ

---

**ç°åœ¨æ‚¨çš„çŸ¥è¯†åº“ç³»ç»Ÿå·²ç»å…·å¤‡äº†ä¼ä¸šçº§çš„ç”¨æˆ·è®¤è¯å’Œæƒé™ç®¡ç†èƒ½åŠ›ï¼** ğŸ›¡ï¸ğŸ”
