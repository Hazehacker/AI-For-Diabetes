<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êô∫Á≥ñÂ∞èÂä©Êâã - ÁôªÂΩï</title>
    <script src="libs/tailwindcss.js"></script>
    <script src="libs/fontawesome.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#969FFF',
                        secondary: '#5147FF', 
                        accent: '#3E3987',
                        success: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444'
                    },
                    backgroundImage: {
                        'gradient-primary': 'linear-gradient(135deg, #969FFF 0%, #5147FF 100%)',
                        'gradient-secondary': 'linear-gradient(135deg, #5147FF 0%, #3E3987 100%)',
                        'gradient-card': 'linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%)',
                        'gradient-hero': 'linear-gradient(135deg, #969FFF 0%, #5147FF 50%, #3E3987 100%)'
                    },
                    boxShadow: {
                        'card': '0 4px 20px rgba(150, 159, 255, 0.1)',
                        'button': '0 4px 15px rgba(150, 159, 255, 0.3)',
                        'nav': '0 -2px 20px rgba(150, 159, 255, 0.1)'
                    }
                }
            }
        }
    </script>
    <style>
        .safe-top {
            padding-top: env(safe-area-inset-top);
        }
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #969FFF 0%, #5147FF 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .form-input-focus:focus {
            outline: none;
            border-color: #969FFF;
            box-shadow: 0 0 0 2px rgba(150, 159, 255, 0.2);
        }
        
        .button-hover:active {
            transform: scale(0.98);
            transition: transform 0.1s ease;
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
    </style>
    <script src="config.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">


    <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü -->
    <div id="main-content" class="min-h-screen flex flex-col">
        <!-- È°∂ÈÉ®LogoÂå∫Âüü -->
        <header id="logo-header" class="flex-1 flex flex-col justify-center items-center px-6 py-12">
            <!-- App Logo -->
            <div id="app-logo" class="text-center mb-12">
                <div class="w-24 h-24 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-card overflow-hidden bg-white">
                    <!-- ‰ΩøÁî®ÂÆûÈôÖÁöÑlogoÂõæÁâá -->
                    <img src="/logo.png" 
                         alt="Êô∫Á≥ñÂ∞èÂä©Êâã Logo" 
                         class="w-full h-full object-contain">
                </div>
                <h1 id="app-name" class="text-3xl font-bold gradient-text mb-2">Êô∫Á≥ñÂ∞èÂä©Êâã</h1>
                <p id="app-slogan" class="text-gray-600 text-sm">ÊÇ®ÁöÑÊô∫ËÉΩÁ≥ñÂ∞øÁóÖÁÆ°ÁêÜ‰ºô‰º¥</p>
            </div>

            <!-- ÁôªÂΩïË°®Âçï -->
            <div id="login-form-container" class="w-full max-w-sm">
                <form id="login-form" class="space-y-6">
                    <!-- Ë¥¶Âè∑ËæìÂÖ•Ê°Ü -->
                    <div id="username-field" class="space-y-2">
                        <label for="username" class="block text-sm font-medium text-gray-700">ÊâãÊú∫Âè∑</label>
                        <div class="relative">
                            <input type="text" 
                                   id="username" 
                                   name="username" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl form-input-focus bg-white text-gray-800 placeholder-gray-500" 
                                   placeholder="ËØ∑ËæìÂÖ•ÊâãÊú∫Âè∑"
                                   required>
                            <div class="absolute right-3 top-1/2 transform -translate-y-1/2">
                                <i class="fas fa-user text-gray-400"></i>
                            </div>
                        </div>
                    </div>

                    <!-- ÂØÜÁ†ÅËæìÂÖ•Ê°Ü -->
                    <div id="password-field" class="space-y-2">
                        <label for="password" class="block text-sm font-medium text-gray-700">ÂØÜÁ†Å</label>
                        <div class="relative">
                            <input type="password" 
                                   id="password" 
                                   name="password" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl form-input-focus bg-white text-gray-800 placeholder-gray-500 pr-12" 
                                   placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å"
                                   required>
                            <button type="button" 
                                    id="toggle-password" 
                                    class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <!-- ÁôªÂΩïÊåâÈíÆ -->

                    <!-- ÁôªÂΩïÊåâÈíÆ -->
                    <button type="submit" 
                            id="login-btn" 
                            class="w-full bg-gradient-primary text-white py-3 rounded-xl font-medium shadow-button button-hover flex items-center justify-center space-x-2">
                        <span>ÁôªÂΩï</span>
                        <i class="fas fa-sign-in-alt"></i>
                    </button>
                </form>

            </div>
        </header>

        <!-- Â∫ïÈÉ®ÂÆâÂÖ®Âå∫Âüü -->
        <div id="bottom-safe-area" class="safe-bottom"></div>
    </div>

    <!-- Âä†ËΩΩÊèêÁ§∫ -->
    <div id="loading-overlay" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 flex flex-col items-center space-y-3">
            <div class="w-8 h-8 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>
            <p class="text-gray-700">Ê≠£Âú®ÁôªÂΩï...</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // APIÈÖçÁΩÆ
            const API_BASE_URL = AppConfig.API.BASE_URL;
            
            // ÂØÜÁ†ÅÊòæÁ§∫/ÈöêËóèÂàáÊç¢
            document.querySelector('#toggle-password').addEventListener('click', function() {
                const passwordInput = document.querySelector('#password');
                const icon = this.querySelector('i');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    passwordInput.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });

            // ÁôªÂΩïË°®ÂçïÊèê‰∫§
            document.querySelector('#login-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const username = document.querySelector('#username').value.trim();
                const password = document.querySelector('#password').value.trim();
                
                // ÁÆÄÂçïÈ™åËØÅ
                if (!username) {
                    alert('ËØ∑ËæìÂÖ•ÊâãÊú∫Âè∑ÊàñÁî®Êà∑Âêç');
                    return;
                }
                
                if (!password) {
                    alert('ËØ∑ËæìÂÖ•ÂØÜÁ†Å');
                    return;
                }
                
                // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                document.querySelector('#loading-overlay').classList.remove('hidden');
                document.querySelector('#login-btn').disabled = true;
                
                try {
                    console.log('üì§ ÂèëÈÄÅÁôªÂΩïËØ∑Ê±Ç...');
                    console.log('üë§ Áî®Êà∑Âêç:', username);
                    
                    // Ë∞ÉÁî®ÂêéÁ´ØÁôªÂΩïAPI
                    console.log('üîç ÂèëÈÄÅËØ∑Ê±ÇÂà∞:', AppConfig.getApiUrl('/api/login'));
                    const response = await fetch(`${AppConfig.getApiUrl('/api/login')}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            username: username,
                            password: password
                        })
                    });

                    console.log('üîç ÂìçÂ∫îÁä∂ÊÄÅ:', response.status, response.statusText);
                    console.log('üîç ÂìçÂ∫îÂ§¥:', Object.fromEntries(response.headers.entries()));

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('‚ùå ÂìçÂ∫îÈîôËØØ:', errorText);
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    let data;
                    try {
                        const responseText = await response.text();
                        console.log('üîç ÂéüÂßãÂìçÂ∫îÊñáÊú¨:', responseText);
                        data = JSON.parse(responseText);
                        console.log('üîç Ëß£ÊûêÂêéÁöÑÊï∞ÊçÆ:', data);
                    } catch (parseError) {
                        console.error('‚ùå JSONËß£ÊûêÂ§±Ë¥•:', parseError);
                        throw new Error('ÂìçÂ∫îÊ†ºÂºèÈîôËØØ');
                    }

                    console.log('üîç dataÂØπË±°:', data);
                    console.log('üîç data.dataÂØπË±°:', data.data);
                    console.log('üîç ÂìçÂ∫îÊï∞ÊçÆÁªìÊûÑ:', data);

                    if (response.ok) {
                        console.log('‚úÖ ÁôªÂΩïÊàêÂäü:', data);

                        // ‰ªéÊ≠£Á°ÆÁöÑË∑ØÂæÑËé∑ÂèñÊï∞ÊçÆ
                        const loginData = data.data || {};
                        const token = loginData.token;

                        console.log('üîç ‰øùÂ≠òÁöÑtokenÂÄº:', token);
                        console.log('üîç tokenÁ±ªÂûã:', typeof token);
                        console.log('üîç tokenÈïøÂ∫¶:', token ? token.length : 0);

                        if (token) {
                            // ‰øùÂ≠òtokenÂà∞localStorageÔºà‰ΩøÁî®Áªü‰∏ÄÊñπÊ≥ïÔºâ
                            AppConfig.setToken(token);
                            console.log('‚úÖ TokenÂ∑≤‰øùÂ≠òÂà∞localStorage');
                        } else {
                            console.error('‚ùå ÁôªÂΩïÂìçÂ∫î‰∏≠Ê≤°Êúâtoken');
                            showError('ÁôªÂΩïÂ§±Ë¥•ÔºöÊúçÂä°Âô®ËøîÂõûÊï∞ÊçÆÂºÇÂ∏∏');
                            return;
                        }

                        // ‰øùÂ≠òÁî®Êà∑‰ø°ÊÅØ
                        if (loginData.user_id) {
                            localStorage.setItem(AppConfig.STORAGE_KEYS.USER_ID, loginData.user_id);
                            localStorage.setItem(AppConfig.STORAGE_KEYS.USERNAME, loginData.username || '');
                            localStorage.setItem('nickname', loginData.nickname || loginData.username || '');
                            console.log('‚úÖ Áî®Êà∑‰ø°ÊÅØÂ∑≤‰øùÂ≠òÂà∞localStorage');
                            console.log('   user_id:', loginData.user_id);
                            console.log('   username:', loginData.username);
                            console.log('   nickname:', loginData.nickname);
                        } else {
                            console.warn('‚ö†Ô∏è ÁôªÂΩïÂìçÂ∫î‰∏≠Ê≤°ÊúâÁî®Êà∑‰ø°ÊÅØ');
                        }

                        console.log('üíæ TokenÂ∑≤‰øùÂ≠ò');

                        // Áü≠ÊöÇÂª∂ËøüÂêéË∑≥ËΩ¨ÔºåËÆ©Áî®Êà∑ÁúãÂà∞ÊàêÂäüÊèêÁ§∫
                        setTimeout(function() {
                            console.log('üöÄ Ë∑≥ËΩ¨Âà∞ÂØπËØùÈ°µÈù¢...');
                            console.log('üîç Ë∑≥ËΩ¨ÂâçÊúÄÂêéÊ£ÄÊü•token:', localStorage.getItem('api_token'));
                            console.log('üîç Ë∑≥ËΩ¨ÂâçÂº∫Âà∂Âà∑Êñ∞localStorage...');

                            // Âº∫Âà∂ÂÜçÊ¨°‰øùÂ≠òtokenÔºåÁ°Æ‰øùlocalStorageÊåÅ‰πÖÂåñ
                            localStorage.setItem('api_token', data.data.token);
                            localStorage.setItem('user_id', data.data.user_id);
                            localStorage.setItem('username', data.data.username);
                            localStorage.setItem('nickname', data.data.nickname);

                            console.log('üîç Ë∑≥ËΩ¨ÂâçÊúÄÁªàÊ£ÄÊü•:', localStorage.getItem('api_token'));

                            window.location.href = AppConfig.getPath('/chat');
                        }, 1000); // Â¢ûÂä†Âª∂ËøüÂà∞1Áßí
                        
                    } else {
                        // ÁôªÂΩïÂ§±Ë¥•
                        console.error('‚ùå ÁôªÂΩïÂ§±Ë¥•:', data.message);
                        alert(data.message || 'ÁôªÂΩïÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Áî®Êà∑ÂêçÂíåÂØÜÁ†Å');
                        
                        // ÈöêËóèÂä†ËΩΩÁä∂ÊÄÅ
                        document.querySelector('#loading-overlay').classList.add('hidden');
                        document.querySelector('#login-btn').disabled = false;
                    }
                    
                } catch (error) {
                    console.error('‚ùå ÁôªÂΩïËØ∑Ê±ÇÂ§±Ë¥•:', error);
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÊòØÁΩëÁªúÈîôËØØ
                    if (error.message === 'Failed to fetch') {
                        alert('Êó†Ê≥ïËøûÊé•Âà∞ÊúçÂä°Âô®ÔºåËØ∑Ê£ÄÊü•Ôºö\n1. ÂêéÁ´ØÊúçÂä°ÊòØÂê¶Â∑≤ÂêØÂä®\n2. APIÂú∞ÂùÄÊòØÂê¶Ê≠£Á°Æ\n3. ÁΩëÁªúËøûÊé•ÊòØÂê¶Ê≠£Â∏∏');
                    } else {
                        alert('ÁôªÂΩïÂ§±Ë¥•Ôºö' + error.message);
                    }
                    
                    // ÈöêËóèÂä†ËΩΩÁä∂ÊÄÅ
                    document.querySelector('#loading-overlay').classList.add('hidden');
                    document.querySelector('#login-btn').disabled = false;
                }
            });



            // ËæìÂÖ•Ê°ÜÁÑ¶ÁÇπÊïàÊûú
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    this.parentElement.classList.add('ring-2', 'ring-primary/20');
                });
                
                input.addEventListener('blur', function() {
                    this.parentElement.classList.remove('ring-2', 'ring-primary/20');
                });
            });
        });
    </script>
</body>
</html>