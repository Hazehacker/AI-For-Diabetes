# 科普知识板块 所需后端接口文档（互动板块 · 科普小课堂）

> 对齐现有风格：统一使用 `Authorization: Bearer <token>`，与积分、小游戏等模块共用积分体系与用户体系。

## 1. 认证与通用约定

- **认证方式**：
  - Header: `Authorization: Bearer <token>`
  - `user_id` 从 token 中解析（与现有 `@token_required` 装饰器一致）
- **Base URL**：`/api`
- **统一响应结构（建议）**：

```json
{
  "success": true,
  "code": 200,
  "message": "ok",
  "data": {}
}
```

- 时间字段建议统一为 `YYYY-MM-DD HH:mm:ss`。

## 2. 数据模型约定

- `article_id`：科普文章唯一 ID（int 或 string）；移动端统一使用字段名 `id`。
- `topic`：主题分类（建议枚举）：
  - `basics`：血糖基础
  - `diet`：饮食与碳水
  - `exercise`：运动与低血糖
  - `lifestyle`：生活小技巧
  - `mood`：情绪与心理
- `read_minutes`：预估阅读时长（整数，单位：分钟）。
- `reward_points`：完成阅读后可获得的积分（整数，可为 0）。
- `is_read` / `is_completed`：当前用户是否已完成该篇文章的阅读任务（布尔）。
- `key_points`：要点列表（字符串数组），用于移动端「本篇要点」区域展示。
- `content`：正文内容（当前前端按纯文本段落渲染；后端可存储 markdown，返回时可下发纯文本版本）。

## 3. 接口清单总览

1. 获取科普文章列表：`GET /api/knowledge/articles`
2. 获取科普文章详情：`GET /api/knowledge/articles/{article_id}`
3. 完成阅读并发放积分：`POST /api/knowledge/articles/{article_id}/complete`
4. 科普学习概览统计（可选）：`GET /api/knowledge/summary`

---

## 3.1 获取科普文章列表

- **HTTP**：`GET /api/knowledge/articles`
- **请求头**：
  - `Authorization: Bearer <token>`
- **Query 参数**：
  - `topic`（可选）：主题筛选；取值：
    - `basics|diet|exercise|lifestyle|mood`
    - 为空或缺省时，返回全部主题（可按权重排序）。
  - `age_group`（可选）：年龄分组；例如：
    - `child`：儿童（< 12 岁）
    - `teen`：青少年
    - `adult`：成人
  - `page`（可选）：页码，默认 `1`
  - `page_size`（可选）：分页大小，默认 `20`，建议单页不超过 `50`

- **Response 示例**（推荐结构，前端已兼容 `data.articles` / 顶层 `articles` / 直接返回数组三种形式，这里以推荐结构为准）：

```json
{
  "success": true,
  "code": 200,
  "data": {
    "total": 35,
    "page": 1,
    "page_size": 20,
    "articles": [
      {
        "article_id": 1,
        "title": "什么是低血糖？出现时该怎么办",
        "summary": "认识低血糖的常见表现，学会向家长和老师求助。",
        "topic": "basics",
        "topic_label": "血糖基础",
        "read_minutes": 3,
        "reward_points": 5,
        "is_read": false,
        "cover": "https://cdn.xxx.com/knowledge/hypo.png",
        "is_featured": true,
        "updated_at": "2026-02-05 09:00:00"
      },
      {
        "article_id": 2,
        "title": "一张图看懂「碳水化合物」",
        "summary": "主食、水果、零食里的碳水，有什么不一样？",
        "topic": "diet",
        "topic_label": "饮食与碳水",
        "read_minutes": 2,
        "reward_points": 5,
        "is_read": true,
        "cover": null,
        "is_featured": false,
        "updated_at": "2026-02-03 18:30:00"
      }
    ]
  }
}
```

- **字段说明**：
  - `article_id`：文章 ID；移动端会兼容 `id` 或 `article_id`。
  - `summary`：列表卡片上的 1–2 句简介。
  - `topic_label`：给前端直接展示的中文名称（如「饮食与碳水」）。
  - `read_minutes`：用于展示「2–3 分钟阅读」提示。
  - `reward_points`：本篇可获得的积分，用于列表上的激励文案。
  - `is_read`：当前用户是否已读，用于显示「已读」标签。
  - `cover`：封面图，可选。
  - `is_featured`：是否为「今日推荐」；若存在多个，前端可取第一个。

---

## 3.2 获取科普文章详情

- **HTTP**：`GET /api/knowledge/articles/{article_id}`
- **请求头**：
  - `Authorization: Bearer <token>`
- **Path 参数**：
  - `article_id`：文章 ID，与列表中的 `article_id` 对应。

- **Response 示例**（推荐结构，前端已兼容 `data.article` / 顶层对象两种形式，这里以推荐结构为准）：

```json
{
  "success": true,
  "code": 200,
  "data": {
    "article": {
      "article_id": 1,
      "title": "什么是低血糖？出现时该怎么办",
      "summary": "低血糖并不可怕，关键是尽早发现，并学会向大人求助与正确补糖。",
      "topic": "basics",
      "topic_label": "血糖基础",
      "read_minutes": 3,
      "reward_points": 5,
      "is_completed": false,
      "key_points": [
        "低血糖常见表现包括：手抖、出汗、肚子饿、脸色发白、头晕等。",
        "一旦怀疑低血糖，要立刻告诉家长或老师，不要一个人忍着。",
        "在大人指导下，可以喝含糖饮料或吃含糖食物，10-15 分钟后再复测血糖。"
      ],
      "content": "低血糖是指血液中的葡萄糖水平过低，身体和大脑暂时“缺少燃料”。\\n\\n很多孩子一开始只觉得有点累、想睡觉，或者突然心跳很快、出汗，这些都有可能是低血糖的信号。\\n\\n遇到这些情况时，最重要的不是责怪自己，而是尽快告诉身边的大人，让他们帮你一起判断和处理。",
      "created_at": "2026-01-20 10:00:00",
      "updated_at": "2026-02-01 08:00:00"
    }
  }
}
```

- **字段说明**：
  - `key_points`：本篇 2–4 条关键要点，前端在「本篇要点」区域展示。
  - `content`：正文内容，前端按 `\\n\\n` 等空行拆分为多段落。
  - `is_completed`：当前用户是否已完成阅读任务（已发放积分）。

---

## 3.3 完成阅读并发放积分

- **HTTP**：`POST /api/knowledge/articles/{article_id}/complete`
- **请求头**：
  - `Authorization: Bearer <token>`
- **Path 参数**：
  - `article_id`：文章 ID。
- **Body**（可扩展，当前移动端可传空对象）：

```json
{
  "read_duration": 180,       // 可选，本次阅读时长（秒）
  "from_scene": "interaction" // 可选，来源场景，如 interaction / notification 等
}
```

- **业务规则建议**：
  1. 通过 token 获取 `user_id`。
  2. 校验 `article_id` 是否存在且处于上架状态（未删除、未下线）。
  3. 若该用户已完成过该文章阅读并发过奖励，接口需幂等：
     - 可以返回 `is_duplicate: true`，并重复返回原奖励（推荐）。
  4. 写入阅读记录（如 `knowledge_reads` 表）：
     - 字段示例：`user_id, article_id, completed_at, reward_points, read_duration, from_scene` 等。
  5. 奖励积分：
     - 积分来源 `source = 'knowledge'`。
     - 插入积分流水记录（复用现有 `points` 模块）。
     - 更新积分余额。

- **Response 示例**：

```json
{
  "success": true,
  "code": 200,
  "message": "阅读完成，已发放积分",
  "data": {
    "reward_points": 5,
    "balance": 5685,
    "is_duplicate": false,
    "completed_at": "2026-02-05 10:12:00"
  }
}
```

- **错误码建议**（可放入全局错误码表，也可在本文件中补充说明）：

| 错误码 | 说明                     | 触发场景                                   |
|--------|--------------------------|--------------------------------------------|
| 40010  | 文章不存在或已下线       | `article_id` 不存在 / `is_active = 0`     |
| 40011  | 重复完成，无需重复提交   | 同一用户同一文章已完成且不允许重复记录   |
| 401    | 未授权                   | token 无效或过期                          |
| 500    | 系统错误或数据库写入失败 | 服务器内部异常                            |

> 建议：即使是重复完成，也可以返回 `success=true` 和之前的 `reward_points`，由 `is_duplicate=true` 来提示前端做相应文案。

---

## 3.4 科普学习概览（可选）

> 用于在互动板块顶部或个人中心中展示「已学习篇数 / 连续学习天数」，目前移动端预留了 `knowledgeApi.getSummary`，后端可按需实现。

- **HTTP**：`GET /api/knowledge/summary`
- **请求头**：
  - `Authorization: Bearer <token>`
- **Query 参数**（可选）：
  - `range`：统计范围，取值：
    - `week`：最近 7 天
    - `month`：最近 30 天
    - `all`：全部历史
  - 默认值：`all`

- **Response 示例**：

```json
{
  "success": true,
  "code": 200,
  "data": {
    "total_articles": 42,      // 当前可用科普总篇数
    "read_count": 18,          // 用户历史已完成阅读的篇数
    "week_read_count": 4,      // 最近 7 天阅读篇数
    "streak_days": 3,          // 连续学习天数（按最近 N 天是否有阅读记录计算）
    "today_read": true,        // 今日是否已完成至少一篇科普阅读
    "today_reward_points": 5   // 今日通过科普获得的积分总和
  }
}
```

- **连续学习天数计算示例（伪代码）**：

```python
def calculate_knowledge_streak(user_id):
    # 获取用户所有科普阅读完成记录，按日期倒序
    records = get_knowledge_reads(user_id, order_by="completed_at DESC")

    if not records:
        return 0

    today = date.today()
    last_date = records[0].completed_at.date()

    # 如果最后一次完成阅读距今超过 1 天，连续中断
    if (today - last_date).days > 1:
        return 0

    streak = 1
    for i in range(1, len(records)):
        prev = records[i - 1].completed_at.date()
        curr = records[i].completed_at.date()
        if (prev - curr).days == 1:
            streak += 1
        elif (prev - curr).days > 1:
            break

    return streak
```

---

## 4. 与积分体系的对接

1. **积分来源标记**
   - 在积分流水表中新增/复用 `source` 字段，建议取值：
     - `checkin`：每日签到
     - `game`：小游戏
     - `knowledge`：科普知识（本模块）
     - `redeem`：积分兑换（负数）
   - 科普阅读奖励的积分流水写入时，`source = 'knowledge'`。

2. **奖励策略**
   - 默认每篇奖励固定积分（如 3–10 分），也可以按篇目配置不同奖励。
   - 可在文章表中增加字段：
     - `base_points`：基础奖励
     - `first_only`：是否仅首次完成奖励积分（布尔）。
   - 若需要限制每日可通过科普获得的积分上限，可在服务端按用户维度统计：
     - 如字段：`daily_knowledge_points_limit`，超出后 `reward_points=0`，但仍记录完成阅读。

3. **与每日签到联动（可选）**
   - 若需要将科普阅读作为签到/任务的一部分，可在签到/任务模块中增加规则：
     - 「今日完成 1 篇科普文章」→ 额外奖励。
   - 该部分建议在对应模块文档中扩展，此处不展开。

---

## 5. 数据表设计建议（示意）

> 仅供参考，具体根据现有数据库结构调整。

### 5.1 `knowledge_articles`（科普文章表）

| 字段名         | 类型        | 说明                     |
|----------------|-------------|--------------------------|
| id             | int / uuid  | 主键                     |
| title          | varchar     | 标题                     |
| summary        | varchar     | 简短摘要                 |
| topic          | varchar     | 主题分类（basics 等）    |
| topic_label    | varchar     | 主题中文名               |
| read_minutes   | int         | 预估阅读时长（分钟）     |
| base_points    | int         | 基础积分奖励             |
| first_only     | tinyint     | 是否仅首读奖励（0/1）    |
| cover          | varchar     | 封面图地址               |
| content        | text        | 正文内容（文本或 markdown） |
| key_points     | text/json   | 要点（JSON 数组）        |
| is_active      | tinyint     | 是否上架（0/1）          |
| created_at     | datetime    | 创建时间                 |
| updated_at     | datetime    | 更新时间                 |

### 5.2 `knowledge_reads`（科普阅读记录表）

| 字段名       | 类型      | 说明                                   |
|--------------|-----------|----------------------------------------|
| id           | int       | 主键                                   |
| user_id      | int       | 用户 ID                                |
| article_id   | int       | 文章 ID                                |
| reward_points| int       | 本次阅读实际发放积分                   |
| read_duration| int       | 本次阅读时长（秒，可选）               |
| from_scene   | varchar   | 来源场景（interaction / notification） |
| completed_at | datetime  | 完成时间                               |
| created_at   | datetime  | 创建时间                               |

> 若需要幂等控制，可以在 (user_id, article_id) 上加唯一索引；重复插入时通过 `ON DUPLICATE KEY` 或业务逻辑控制返回 `is_duplicate=true`。

---

## 6. 对接清单（后端待开发/确认）

- [ ] `GET /api/knowledge/articles`：按主题、分页返回文章列表，带 `is_read`。
- [ ] `GET /api/knowledge/articles/{article_id}`：返回文章详情、要点和正文。
- [ ] `POST /api/knowledge/articles/{article_id}/complete`：记录阅读完成并发放积分（幂等）。
- [ ] `GET /api/knowledge/summary`（可选）：返回科普学习统计、连续天数等。
- [ ] 与积分模块打通：积分流水 `source = 'knowledge'`，更新积分余额。

