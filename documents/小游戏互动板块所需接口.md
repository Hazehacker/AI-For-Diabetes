# å°æ¸¸æˆäº’åŠ¨æ¿å— åç«¯æ¥å£éœ€æ±‚

ç»“åˆç§»åŠ¨ç«¯å®ç°ä¸ç°æœ‰ç§¯åˆ†ä½“ç³»ï¼Œæ–°å¢/æ‰©å±•æ¥å£å¦‚ä¸‹ï¼Œä¾¿äºå¯¹æ¥å°æ¸¸æˆåˆ—è¡¨ã€é…ç½®ä¸‹å‘ã€æˆç»©ä¸ŠæŠ¥ã€å¥–åŠ±å‘æ”¾å’Œæ¦œå•å±•ç¤ºã€‚

## 1. è®¤è¯ä¸é€šç”¨çº¦å®š
- Header: `Authorization: Bearer <token>`
- `user_id` ä» token è§£æï¼ˆæ²¿ç”¨ `@token_required`ï¼‰ã€‚
- Base URLï¼š`/api`
- å“åº”æ ¼å¼ï¼ˆå»ºè®®ç»Ÿä¸€ï¼‰ï¼š
```json
{
  "success": true,
  "code": 200,
  "message": "ok",
  "data": {}
}
```
- æ‰€æœ‰å†™æ¥å£éœ€å¹‚ç­‰æˆ–å…·å¤‡é˜²é‡æœºåˆ¶ï¼ˆè§ 3.3ï¼‰ï¼Œæ”¯æŒå®¢æˆ·ç«¯é‡è¯•ï¼ˆå¼±ç½‘/æ–­ç½‘ï¼‰ã€‚
- æ—¶é—´å­—æ®µï¼šå»ºè®®ç»Ÿä¸€ä¸º `YYYY-MM-DD HH:mm:ss`ï¼ˆä¸ç°æœ‰ç§¯åˆ†/ç­¾åˆ°æ¥å£é£æ ¼ä¸€è‡´ï¼‰ï¼Œæˆ–ç»Ÿä¸€ ISO8601ï¼ŒäºŒé€‰ä¸€å³å¯ã€‚

## 2. èµ„æºå®šä¹‰
- `game_id`ï¼šå­—ç¬¦ä¸²ï¼Œå¦‚ `runner`, `food_match`, `rhythm`, `quiz`.
- `session_id`ï¼šå®¢æˆ·ç«¯ç”Ÿæˆçš„å”¯ä¸€å±€æ ‡è¯†ï¼ˆUUIDï¼‰ï¼›ç”¨äºé˜²é‡ã€é‡è¯•ã€‚
- `score`ï¼šæ•´æ•°ï¼›`duration` ç§’ï¼›`accuracy` 0-1ã€‚
- `events`ï¼šå¯é€‰ï¼Œå±€å†…å…³é”®äº‹ä»¶æ—¥å¿—ï¼ˆå‹ç¼©/é‡‡æ ·åå†ä¸Šä¼ ï¼‰ï¼Œç”¨äºè°ƒå‚ã€é£æ§ä¸å›æ”¾å®šä½ã€‚

## 3. æ¥å£æ¸…å•

### 3.1 è·å–å°æ¸¸æˆåˆ—è¡¨
- **GET** `/api/games`
- Queryï¼š`age_group` å¯é€‰ï¼ˆ`child|teen`ï¼‰ï¼Œç”¨äºå‰ç«¯è¿‡æ»¤ã€‚
- Response `data.games` åˆ—è¡¨ç¤ºä¾‹ï¼š
```json
{
  "games": [
    {
      "game_id": "runner",
      "name": "ç³–å€¼å®ˆæŠ¤è·‘é…·",
      "cover": "https://.../runner.png",
      "duration_hint": "2-3åˆ†é’Ÿ",
      "tags": ["ååº”", "é¥®é£Ÿ"],
      "need_network": false,
      "version": "1.2.0",
      "min_app_version": "1.0.0",
      "enabled": true,
      "daily_limit": 10
    }
  ]
}
```
- è¯´æ˜ï¼š
  - `enabled=false` æ—¶å‰ç«¯éšè—æˆ–ç½®ç°å±•ç¤ºï¼ˆä¾¿äºç°åº¦/ä¸‹çº¿ï¼‰ã€‚
  - `daily_limit` ç”¨äºå‰ç«¯æç¤ºï¼ˆæœ€ç»ˆä»¥æœåŠ¡ç«¯æ ¡éªŒä¸ºå‡†ï¼‰ã€‚

### 3.2 è·å–æ¸¸æˆé…ç½®
- **GET** `/api/games/{game_id}/config`
- Queryï¼š`version`ï¼ˆå¯é€‰ï¼Œå‰ç«¯ä¼ æœ¬åœ°ç¼“å­˜ç‰ˆæœ¬ï¼Œä¾¿äºå¢é‡ä¸‹å‘ï¼‰
- Response ç¤ºä¾‹ï¼ˆå­—æ®µæŒ‰æ¸¸æˆå·®å¼‚é…ç½®ï¼‰ï¼š
```json
{
  "game_id": "runner",
  "version": "1.2.0",
  "assets_base": "https://.../runner/",
  "difficulty": { "speed": 1.1, "spawn_rate": 0.8 },
  "reward_rules": {
    "base_points": 1,
    "max_points": 30,
    "score_steps": [
      { "min_score": 0, "points": 1 },
      { "min_score": 600, "points": 5 },
      { "min_score": 1200, "points": 10 }
    ]
  },
  "limits": {
    "max_duration": 180,
    "min_duration": 10,
    "daily_limit": 10
  },
  "foods": [
    { "id": "apple", "type": "good", "emoji": "ğŸ", "score": 10, "delta": -2 },
    { "id": "cola", "type": "bad", "emoji": "ğŸ¥¤", "score": -5, "delta": 6 },
    { "id": "trap", "type": "trap", "emoji": "ğŸ•³ï¸", "score": 0, "delta": 0 }
  ],
  "hints": ["è¿åŠ¨åæ³¨æ„è¡¥å……ç¢³æ°´", "é€‰æ‹©ä½ç³–æ°´æœ"]
}
```
- å»ºè®®ï¼šä¸åŒæ¸¸æˆä½¿ç”¨ä¸åŒé…ç½®ä½“ï¼ˆé€šè¿‡ `game_id` åŒºåˆ†ï¼‰ï¼Œä½†ä¿æŒå…¬å…±å­—æ®µï¼š`game_id/version/assets_base/reward_rules/limits/hints`ã€‚

### 3.2.1 é£Ÿç‰©æ‹¼æ‹¼ä¹é…ç½®ï¼ˆç¤ºä¾‹ï¼‰
- **GET** `/api/games/food_match/config`
```json
{
  "game_id": "food_match",
  "version": "1.0.0",
  "limits": { "max_duration": 240, "min_duration": 10, "daily_limit": 10 },
  "reward_rules": { "max_points": 30 },
  "items": [
    { "id": "rice", "name": "ç±³é¥­", "emoji": "ğŸš", "carb": "high" },
    { "id": "egg", "name": "é¸¡è›‹", "emoji": "ğŸ¥š", "carb": "low" }
  ],
  "labels": [
    { "value": "low", "name": "ä½ç¢³æ°´" },
    { "value": "mid", "name": "ä¸­ç¢³æ°´" },
    { "value": "high", "name": "é«˜ç¢³æ°´" }
  ],
  "hints": ["å­¦ä¼šçœ‹â€œç¢³æ°´â€æ›´å®¹æ˜“åšå‡ºèªæ˜é€‰æ‹©"]
}
```

### 3.3 æˆç»©ä¸ŠæŠ¥ï¼ˆå«é˜²é‡ï¼‰
- **POST** `/api/games/{game_id}/result`
- Bodyï¼š
```json
{
  "session_id": "uuid",
  "score": 1230,
  "duration": 125,
  "accuracy": 0.86,
  "events": "base64-encoded or compressed log", 
  "client_ts": "2026-02-05T09:30:00Z",
  "client_info": {
    "platform": "h5|app|mp-weixin",
    "app_version": "1.0.0",
    "device": "iPhone15,2"
  }
}
```
- é€»è¾‘ï¼šåŒä¸€ `session_id` é‡å¤ä¸ŠæŠ¥åº”å¹‚ç­‰è¿”å›ï¼›æ ¡éªŒæœ€å°/æœ€å¤§ durationï¼Œè¶…é™æ‹’ç»ã€‚
- Responseï¼š
```json
{
  "success": true,
  "data": {
    "reward_points": 15,
    "new_badges": ["å¥åº·é¤ç›˜å¤§å¸ˆ"],
    "balance": 5680,
    "is_duplicate": false,
    "points_record_id": 12345
  },
  "message": "è®°å½•æˆåŠŸï¼Œå¥–åŠ±å·²å‘æ”¾"
}
```
- å»ºè®®é”™è¯¯ç /çŠ¶æ€ç ï¼ˆä¾¿äºç§»åŠ¨ç«¯åšæ–‡æ¡ˆï¼‰ï¼š
  - `400`ï¼šå‚æ•°éæ³•ï¼ˆduration/score è¶Šç•Œã€game_id ä¸å­˜åœ¨ï¼‰
  - `409`ï¼šé‡å¤ä¸ŠæŠ¥ï¼ˆåŒ session_id å·²å¤„ç†ï¼‰ï¼Œå¯è¿”å› `is_duplicate=true` ä¸”å¥–åŠ±ä¸º 0 æˆ–é‡å¤è¿”å›åŒå¥–åŠ±ï¼ˆæ¨èé‡å¤è¿”å›åŒå¥–åŠ±ï¼‰
  - `429`ï¼šè¶…è¿‡é¢‘ç‡/æ—¥ä¸Šé™ï¼ˆè¿”å› `remaining`ã€`reset_at`ï¼‰
  - `500`ï¼šæœåŠ¡ç«¯å¼‚å¸¸

### 3.3.1 æŸ¥è¯¢ä¼šè¯çŠ¶æ€ï¼ˆå¯é€‰ï¼‰
- è‹¥éœ€è¦å‰ç«¯åœ¨æ–­ç½‘é‡è¯•æ—¶ç¡®è®¤è¯¥å±€æ˜¯å¦å·²è¢«æœåŠ¡ç«¯æ¥æ”¶ï¼š
- **GET** `/api/games/{game_id}/result/status?session_id=uuid`
- Responseï¼š
```json
{ "data": { "exists": true, "reward_points": 15, "created_at": "2026-02-05 09:12:00" } }
```

### 3.4 é¢†å–å¥–åŠ±ï¼ˆå¯é€‰åˆ†æ­¥ï¼‰
- è‹¥éœ€ä¸ä¸ŠæŠ¥åˆ†ç¦»ï¼Œæä¾›ï¼š
- **POST** `/api/games/{game_id}/reward`
- Bodyï¼š`{ "session_id": "uuid" }`
- Responseï¼šåŒ 3.3 ä¸­å¥–åŠ±ç»“æ„ï¼›è‹¥å·²é¢†å–è¿”å›å¹‚ç­‰æç¤ºã€‚

### 3.5 ä¸ªäººå†å²è®°å½•
- **GET** `/api/games/{game_id}/history?page=1&page_size=20`
- Responseï¼š
```json
{
  "data": {
    "total": 35,
    "page": 1,
    "page_size": 20,
    "records": [
      {
        "session_id": "uuid",
        "score": 980,
        "duration": 118,
        "accuracy": 0.8,
        "created_at": "2026-02-05 09:12:00",
        "reward_points": 10,
        "reward_status": "granted"
      }
    ]
  }
}
```

### 3.6 æ’è¡Œæ¦œ
- **GET** `/api/games/{game_id}/leaderboard?scope=week&limit=50`
- `scope`: `day|week|month`.
- Responseï¼š
```json
{
  "data": {
    "scope": "week",
    "my_rank": 12,
    "list": [
      { "rank": 1, "nickname": "ç³–ç³–", "score": 1880, "avatar": "https://..." }
    ]
  }
}
```
- å»ºè®®ï¼šæ’è¡Œæ¦œå¯åšâ€œéšç§å‹å¥½â€å¤„ç†ï¼ˆæ˜µç§°è„±æ•ã€å¤´åƒå¯ç©ºï¼‰ã€‚

### 3.7 é¢˜åº“ä¸‹å‘ï¼ˆç”¨äºè½»é—®ç­”ï¼‰
- **GET** `/api/games/quiz/questions?count=10&difficulty=easy`
- è¿”å›é¢˜ç›®ã€é€‰é¡¹ã€æ­£ç¡®ç­”æ¡ˆä¸è§£æï¼›éœ€å¸¦ç‰ˆæœ¬å·æˆ–é¢˜ç›® idï¼Œä¾¿äºå‰ç«¯æœ¬åœ°åˆ¤é¢˜åä¸ŠæŠ¥ã€‚

### 3.8 å°æ¸¸æˆæ€»è§ˆï¼ˆä¾›äº’åŠ¨æ¿å—é¡¶éƒ¨ç»Ÿè®¡ä½¿ç”¨ï¼Œæ¨èï¼‰
- **GET** `/api/games/summary`
- Responseï¼š
```json
{
  "data": {
    "today_played": 3,
    "week_played": 9,
    "best_scores": {
      "runner": 1880,
      "food_match": 900
    },
    "today_reward_points": 15
  }
}
```

## 4. ç§¯åˆ†ä¸å¾½ç« å¯¹æ¥
- å¥–åŠ±ç­–ç•¥ç”±åç«¯é…ç½®ï¼šæŒ‰å¾—åˆ†åˆ†æ®µã€è¿èƒœã€é¦–æ¬¡å®Œæˆç­‰åŠ æˆã€‚
- ç§¯åˆ†æµæ°´å†™å…¥ `points` æ¨¡å—ï¼Œ`source` å»ºè®®æ–°å¢ `game`ã€‚
- å¾½ç« ï¼šæä¾› badge_idã€åç§°ã€å›¾æ ‡åœ°å€ï¼›é‡å¤è·å–ä¸é‡å¤å‘æ”¾ã€‚

## 5. åä½œå¼Šä¸é£æ§å»ºè®®
- æ ¡éªŒ `duration`ã€`score` ä¸Šé™ï¼Œå¼‚å¸¸ç›´æ¥æ‹’ç»æˆ–é™å¥–ã€‚
- `session_id` å¹‚ç­‰ï¼›åŒç”¨æˆ·çŸ­æ—¶é—´è¶…é¢‘ä¸ŠæŠ¥éœ€è¦é™æµã€‚
- å¯é€‰ä¸ŠæŠ¥ç®€å•è®¾å¤‡æŒ‡çº¹/ç½‘ç»œç±»å‹ï¼Œç”¨äºé£æ§æ¨¡å‹ã€‚

## 6. è¿ç»´ä¸é…ç½®
- ç®¡ç†ç«¯æ¥å£ï¼ˆå¯å¤ç”¨ç°æœ‰åå°ï¼‰ï¼šåˆ›å»º/ç¼–è¾‘æ¸¸æˆé…ç½®ã€é¢˜åº“ã€å¥–åŠ±æ–¹æ¡ˆï¼Œå‘å¸ƒç‰ˆæœ¬ï¼›é¢„è§ˆæ¸ é“å· A/Bã€‚
- ç‰ˆæœ¬ç°åº¦ï¼šé…ç½®å¸¦ `version` ä¸ `rollout_percent`ï¼›å‰ç«¯æŒ‰ç”¨æˆ· hash å‘½ä¸­ã€‚


