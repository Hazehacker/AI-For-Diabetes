# 部署指南

## 部署前准备

### 1. 环境检查
- Node.js >= 16.0.0
- npm >= 8.0.0
- 对应平台的开发工具

### 2. 配置检查
- API地址配置正确
- 应用信息配置完整
- 权限配置正确

## H5部署

### 构建
```bash
npm run build:h5
```

### 部署到服务器

#### 方式一：Nginx部署
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    root /var/www/h5;
    index index.html;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # API代理（可选）
    location /api {
        proxy_pass https://chat.cmkjai.com;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

#### 方式二：静态托管
上传 `dist/build/h5` 目录到：
- 阿里云OSS
- 腾讯云COS
- 七牛云
- Vercel
- Netlify

### 配置HTTPS
```bash
# 使用Let's Encrypt
certbot --nginx -d your-domain.com
```

## 微信小程序部署

### 1. 准备工作
- 注册微信小程序账号
- 获取AppID
- 配置服务器域名

### 2. 配置AppID
编辑 `src/manifest.json`:
```json
{
  "mp-weixin": {
    "appid": "your-appid"
  }
}
```

### 3. 配置服务器域名
在微信公众平台配置：
- request合法域名: `https://chat.cmkjai.com`
- uploadFile合法域名: `https://chat.cmkjai.com`
- downloadFile合法域名: `https://chat.cmkjai.com`

### 4. 构建
```bash
npm run build:mp-weixin
```

### 5. 上传代码
1. 使用微信开发者工具打开 `dist/build/mp-weixin`
2. 点击"上传"按钮
3. 填写版本号和项目备注
4. 上传成功

### 6. 提交审核
1. 登录微信公众平台
2. 进入"版本管理"
3. 提交审核
4. 等待审核通过
5. 发布上线

## 支付宝小程序部署

### 1. 准备工作
- 注册支付宝小程序账号
- 获取AppID

### 2. 配置AppID
编辑 `src/manifest.json`:
```json
{
  "mp-alipay": {
    "appid": "your-appid"
  }
}
```

### 3. 构建
```bash
npm run build:mp-alipay
```

### 4. 上传发布
使用支付宝开发者工具上传代码

## App部署

### Android打包

#### 方式一：云打包（推荐）
1. 使用HBuilderX打开项目
2. 发行 -> 原生App-云打包
3. 选择Android平台
4. 配置证书
5. 开始打包
6. 下载APK

#### 方式二：离线打包
1. 下载Android离线SDK
2. 配置项目
3. 使用Android Studio打包

### iOS打包

#### 方式一：云打包
1. 使用HBuilderX打开项目
2. 发行 -> 原生App-云打包
3. 选择iOS平台
4. 配置证书和描述文件
5. 开始打包
6. 下载IPA

#### 方式二：离线打包
1. 下载iOS离线SDK
2. 配置项目
3. 使用Xcode打包

### 应用商店上架

#### Android
- 华为应用市场
- 小米应用商店
- OPPO软件商店
- vivo应用商店
- 应用宝
- 360手机助手

#### iOS
- App Store

## 环境变量配置

### 开发环境
```javascript
// src/utils/request.js
const BASE_URL = 'http://localhost:8900/api'
```

### 生产环境
```javascript
// src/utils/request.js
const BASE_URL = 'https://chat.cmkjai.com/api'
```

### 使用环境变量
```javascript
// vite.config.js
export default defineConfig({
  define: {
    'process.env.API_BASE_URL': JSON.stringify(
      process.env.NODE_ENV === 'production'
        ? 'https://chat.cmkjai.com/api'
        : 'http://localhost:8900/api'
    )
  }
})
```

## 性能优化

### 1. 代码分割
```javascript
// 路由懒加载
const Chat = () => import('@/pages/chat/chat.vue')
```

### 2. 图片优化
- 使用webp格式
- 压缩图片
- 使用CDN

### 3. 请求优化
- 使用缓存
- 合并请求
- 使用防抖/节流

### 4. 包体积优化
```bash
# 分析包体积
npm run build:h5 -- --report

# 移除未使用的依赖
npm prune
```

## 监控和日志

### 1. 错误监控
```javascript
// 全局错误处理
uni.onError((error) => {
  console.error('Global Error:', error)
  // 上报到监控平台
})
```

### 2. 性能监控
```javascript
// 页面性能监控
uni.onAppShow(() => {
  const performance = uni.getPerformance()
  console.log('Performance:', performance)
})
```

### 3. 日志上报
```javascript
// 日志上报
const reportLog = (level, message, data) => {
  // 上报到日志平台
  console.log(`[${level}]`, message, data)
}
```

## 安全配置

### 1. HTTPS
- 使用HTTPS协议
- 配置SSL证书
- 强制HTTPS跳转

### 2. API安全
- 使用Token认证
- 请求签名
- 防重放攻击

### 3. 数据加密
- 敏感数据加密存储
- 传输数据加密
- 密码加密

## 备份和回滚

### 1. 代码备份
```bash
# Git标签
git tag -a v1.0.0 -m "Release v1.0.0"
git push origin v1.0.0
```

### 2. 数据库备份
```bash
# 定期备份数据库
mysqldump -u root -p database > backup.sql
```

### 3. 快速回滚
```bash
# 回滚到上一个版本
git checkout v1.0.0
npm run build:h5
```

## 持续集成/持续部署 (CI/CD)

### GitHub Actions示例
```yaml
name: Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Setup Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '16'
    
    - name: Install dependencies
      run: npm install
    
    - name: Build
      run: npm run build:h5
    
    - name: Deploy
      run: |
        # 部署到服务器
        scp -r dist/build/h5/* user@server:/var/www/h5/
```

## 常见问题

### Q: 构建失败？
A: 检查：
1. Node.js版本
2. 依赖是否完整安装
3. 配置文件是否正确

### Q: 小程序审核不通过？
A: 检查：
1. 服务器域名是否配置
2. 内容是否符合规范
3. 功能是否完整

### Q: App打包失败？
A: 检查：
1. 证书是否正确
2. 配置是否完整
3. 平台版本是否匹配

## 部署检查清单

- [ ] API地址配置正确
- [ ] AppID配置正确
- [ ] 服务器域名配置
- [ ] 证书配置正确
- [ ] 权限配置完整
- [ ] 测试环境验证通过
- [ ] 性能测试通过
- [ ] 安全检查通过
- [ ] 备份策略制定
- [ ] 监控配置完成

## 联系支持

如遇到部署问题，请联系技术支持团队。
