# 视频学习板块 后端接口需求

结合移动端实现与现有积分/科普体系，新增/扩展接口如下，便于对接「视频学习」列表、详情播放、进度上报、完成奖励和学习概览统计。

## 1. 认证与通用约定
- **Header**: `Authorization: Bearer <token>`
- `user_id` 从 token 解析（沿用现有 `@token_required` 机制）。
- Base URL：`/api`
- 响应格式建议与现有模块统一：
```json
{
  "success": true,
  "code": 200,
  "message": "ok",
  "data": {}
}
```
- 时间字段：建议统一为 `YYYY-MM-DD HH:mm:ss`。
- 所有写接口需幂等或具备防重/去重机制（支持弱网情况下的重试）。

## 2. 资源定义
- `video_id`：视频课程唯一标识，字符串或整数均可（与表结构一致）。
- `topic`：主题分类，例如：
  - `basics`：血糖基础
  - `diet`：饮食与碳水
  - `exercise`：运动与低血糖
  - `lifestyle`：生活小技巧
- `duration_minutes`：视频时长（单位：分钟，前端显示使用）。
- `progress_percent`：学习进度百分比整数 `0-100`。
- `reward_points`：完成该视频可获得的积分。

## 3. 接口清单

### 3.1 获取视频课程列表
- **GET** `/api/video/lessons`
- **Query（可选）**：
  - `topic`：主题过滤，如 `basics|diet|exercise|lifestyle`
  - `page`：页码，默认 `1`
  - `page_size`：每页数量，默认 `20`
- **Response**
```json
{
  "success": true,
  "code": 200,
  "data": {
    "total": 12,
    "page": 1,
    "page_size": 20,
    "videos": [
      {
        "video_id": 1,
        "title": "认识血糖：小朋友也能听懂的解释",
        "summary": "用动画讲讲什么是血糖，为什么要关注它。",
        "topic": "basics",
        "topic_label": "血糖基础",
        "duration_minutes": 3,
        "cover": "https://.../cover1.png",
        "reward_points": 5,
        "is_completed": false,
        "progress_percent": 0
      }
    ]
  }
}
```
- 说明：
  - `is_completed`：是否已完成观看（达到奖励条件）。
  - `progress_percent`：当前学习进度，用于前端展示小进度条。

### 3.2 获取视频课程详情
- **GET** `/api/video/lessons/{video_id}`
- **Path**：
  - `video_id`：必填，视频标识。
- **Response**
```json
{
  "success": true,
  "code": 200,
  "data": {
    "video": {
      "video_id": 1,
      "title": "认识血糖：小朋友也能听懂的解释",
      "description": "通过简单的动画，和孩子一起了解什么是血糖、为什么要检测血糖。",
      "topic": "basics",
      "topic_label": "血糖基础",
      "duration_minutes": 3,
      "reward_points": 5,
      "cover": "https://.../cover1.png",
      "play_url": "https://.../video1.m3u8",
      "key_points": [
        "血糖就像身体的“能量小火车”，要保持不高也不太低。",
        "定期测量血糖，可以帮助家长和医生了解最近的控制情况。"
      ],
      "is_completed": false,
      "progress_percent": 0
    }
  }
}
```
- 说明：
  - `play_url`：可为 MP4/M3U8 等播放地址，由前端直接绑定到 `<video>` 播放器。
  - `key_points`：要点列表，用于前端「本集要点」模块展示。

### 3.3 完成视频学习（上报完成并领取积分）
- **POST** `/api/video/lessons/{video_id}/complete`
- **Path**：
  - `video_id`：必填。
- **Body**（可选）：
```json
{
  "progress_percent": 100
}
```
- 逻辑建议：
  - 同一用户对同一 `video_id` 重复调用，应为**幂等**：
    - 若首次完成：写入学习记录 + 发放积分。
    - 若已完成：返回 `is_duplicate=true`，可重复返回同一奖励信息，避免前端状态错乱。
  - 可根据实际业务校验最小观看时长/进度百分比。
- **Response**
```json
{
  "success": true,
  "code": 200,
  "data": {
    "reward_points": 5,
    "is_duplicate": false,
    "balance": 5680,
    "completed_at": "2026-02-05 09:30:00"
  },
  "message": "学习完成，积分已发放"
}
```
- 建议错误码/状态码：
  - `400`：参数非法（video_id 不存在等）。
  - `409`：重复完成（可作为提示，仍视为成功态）。
  - `500`：服务端异常。

### 3.4 视频学习概览统计
- **GET** `/api/video/summary`
- 用于前端视频首页顶部「已看完 / 累计分钟 / 累计积分」展示。
- **Response**
```json
{
  "success": true,
  "code": 200,
  "data": {
    "total_completed": 3,
    "total_minutes": 12,
    "total_points": 15,
    "last_watched_at": "2026-02-05 09:30:00"
  }
}
```

### 3.5（可选）视频进度上报
- 如需更精细的学习轨迹（非必需，当前前端未强依赖，可预留接口）：
- **POST** `/api/video/lessons/{video_id}/progress`
- **Body**
```json
{
  "current_seconds": 120,
  "duration_seconds": 180,
  "progress_percent": 67,
  "client_ts": "2026-02-05T09:20:00Z"
}
```
- Response 建议简单返回：
```json
{
  "success": true,
  "code": 200,
  "data": {}
}
```
- 后端可按需做去抖/采样（例如每隔 N 秒/百分比更新一次）。

## 4. 与积分模块的对接
- 视频奖励积分应写入统一积分流水表，`source` 建议新增：`video_lesson`。
- 典型一条积分流水：
```json
{
  "record_id": 123,
  "user_id": 1,
  "points": 5,
  "source": "video_lesson",
  "description": "完成视频学习：认识血糖",
  "created_at": "2026-02-05 09:30:00"
}
```
- 如已有 `/api/points/balance`、`/api/points/records`，可直接透传积分变动结果，不需为视频单独再暴露新接口。

## 5. 数据表建议（非强制，仅供参考）
- `video_lessons`：视频基础信息表（title/description/topic/duration_minutes/cover/play_url/...）。
- `video_study_records`：用户学习记录表：
  - `id`
  - `user_id`
  - `video_id`
  - `progress_percent`
  - `is_completed`
  - `reward_points`
  - `created_at`
  - `updated_at`

## 6. 对接清单（后端待开发/确认）
- [ ] `GET /api/video/lessons` —— 视频列表
- [ ] `GET /api/video/lessons/{video_id}` —— 视频详情（含播放地址）
- [ ] `POST /api/video/lessons/{video_id}/complete` —— 完成学习并发放积分（幂等）
- [ ] `GET /api/video/summary` —— 视频学习概览
- [ ] （可选）`POST /api/video/lessons/{video_id}/progress` —— 中途进度上报



