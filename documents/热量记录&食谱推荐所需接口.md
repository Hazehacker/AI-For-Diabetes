## 后端接口文档设计：热量记录 & 食谱推荐

---

## 1. 获取某日热量统计 + 饮食记录

- **接口描述**：返回指定日期的饮食记录和统计汇总，用于顶部 summary 卡片和记录列表。
- **Method / URL**

  `GET /api/calories/daily`

- **请求参数（query）**

| 字段      | 类型   | 必填 | 说明                             |
|-----------|--------|------|----------------------------------|
| user_id   | string | 否   | 用户 ID，不传可从 token 中解析  |
| date      | string | 是   | 日期，格式 `YYYY-MM-DD`         |

- **响应示例（推荐结构）**

```json
{
  "code": 200,
  "message": "ok",
  "data": {
    "summary": {
      "total_calories": 1480,
      "target_min": 1400,
      "target_max": 1800,
      "carbs_grams": 180,
      "protein_grams": 60,
      "fat_grams": 50,
      "status_text": "今日热量略偏低，晚餐可以适当加一点主食"
    },
    "records": [
      {
        "id": 101,
        "user_id": "u_123",
        "date": "2026-02-04",
        "time": "07:30",
        "meal_type": "breakfast",        // breakfast / lunch / dinner / snack
        "food_name": "燕麦牛奶+鸡蛋",
        "calories": 380,
        "carbs_grams": 45,
        "protein_grams": 20,
        "fat_grams": 12,
        "scene": "home",                 // school / home / outing
        "glucose_before": 6.5,           // 可选：餐前血糖
        "glucose_after": 8.2,            // 可选：餐后血糖
        "insulin_dose": 3,               // 可选：本餐用胰岛素剂量
        "remark": "运动前早餐"
      }
    ]
  }
}
```



- **前端适配说明**

  - `caloriesStore.fetchDailyCalories` 支持两种返回形式：
    - 直接返回：`{ summary, records }`
    - 包一层：`{ code, data: { summary, records } }`
  - 字段名需与示例保持一致：`total_calories / target_min / target_max / carbs_grams / protein_grams / fat_grams / status_text` 等。

---

## 2. 新增一条饮食记录

- **接口描述**：记录一顿饭的基本信息（餐次、场景、估算热量等），用于统计与推荐。
- **Method / URL**

  `POST /api/calories/records`

- **请求体（JSON）**

```json
{
  "user_id": "u_123",          // 可选，后端也可以从 token 推导
  "date": "2026-02-04",
  "time": "12:10",             // 可选，不传可用服务器当前时间
  "meal_type": "lunch",        // breakfast / lunch / dinner / snack
  "food_name": "鸡腿饭",
  "calories": 650,
  "carbs_grams": 70,           // 可选
  "protein_grams": 30,         // 可选
  "fat_grams": 18,             // 可选
  "scene": "school",           // school / home / outing
  "glucose_before": 9.2,       // 可选：关联血糖
  "glucose_after": null,       // 可选：餐后测量后再补
  "insulin_dose": 4,           // 可选：本餐用药 / 胰岛素
  "remark": "食堂简餐"
}
```



- **响应示例**

```json
{
  "code": 200,
  "message": "created",
  "data": {
    "id": 205,
    "user_id": "u_123",
    "date": "2026-02-04",
    "time": "12:10",
    "meal_type": "lunch",
    "food_name": "鸡腿饭",
    "calories": 650,
    "carbs_grams": 70,
    "protein_grams": 30,
    "fat_grams": 18,
    "scene": "school",
    "glucose_before": 9.2,
    "glucose_after": null,
    "insulin_dose": 4,
    "remark": "食堂简餐"
  }
}
```



- **前端适配说明**

    - 前端调用：`caloriesApi.createRecord(data)`。

    - 若响应中 `data.id` 存在则直接使用；否则前端会本地补一个 `Date.now()` 的 `id`。

    - 不强制要求返回 `summary`，前端后续会再次请求 `/calories/daily`；如返回新的 `summary`，前端也可以做覆盖。


---

## 3. 获取推荐食谱列表

- **接口描述**：结合用户角色、血糖 / 胰岛素 / 打卡等数据，在不同场景下推荐合适食谱。
- **Method / URL**

  `GET /api/calories/recipes/recommend`

- **请求参数（query）**

| 字段            | 类型   | 必填 | 说明                                                                 |
|-----------------|--------|------|----------------------------------------------------------------------|
| user_id         | string | 否   | 用户 ID                                                              |
| date            | string | 否   | 日期，默认当天                                                       |
| scene           | string | 否   | 使用场景：`school` 在校 / `home` 居家 / `outing` 外出聚餐           |
| role            | string | 否   | 角色：`child_under_12` / `teen_above_12` / `guardian`               |
| glucose_level   | string | 否   | 当前血糖状态：`low` / `in_range` / `high`，可由仪表盘或血糖曲线计算 |
| last_insulin_at | string | 否   | 最近一次胰岛素注射时间（ISO 时间字符串）                            |

- **响应示例**

```json
{
  "code": 200,
  "message": "ok",
  "data": [
    {
      "id": "r_1001",
      "name": "低 GI 学校午餐盒",
      "meal_type": "lunch",
      "scene": "school",
      "total_calories": 520,
      "carbs_grams": 55,
      "protein_grams": 28,
      "fat_grams": 16,
      "description": "糙米饭 + 烤鸡胸肉 + 清蒸西兰花，适合血糖略高时的午餐选择。",
      "glucose_tip": "适合餐前血糖偏高或需要控制碳水时使用，建议餐前监测血糖。",
      "suggested_for_roles": ["teen_above_12", "guardian"]
    },
    {
      "id": "r_1002",
      "name": "家庭晚餐：番茄牛肉面（减糖版）",
      "meal_type": "dinner",
      "scene": "home",
      "total_calories": 610,
      "carbs_grams": 65,
      "protein_grams": 32,
      "fat_grams": 18,
      "description": "使用全麦面条和大量蔬菜，减少高 GI 食材。",
      "glucose_tip": "适合血糖在目标范围内的家庭晚餐，可根据医生建议调整主食量。",
      "suggested_for_roles": ["child_under_12", "teen_above_12", "guardian"]
    }
  ]
}
```

- **前端适配说明**

    - 前端调用：`caloriesApi.getRecipeRecommendations(params)`。

    - 前端兼容以下两种返回：
      - `data` 是数组；
      - 或 `data` 是对象：`{ items: [...] }`。

    - 关键字段：`id, name, meal_type, scene, total_calories, carbs_grams, description, glucose_tip`，有这些即可完整展示。


---

## 4. OCR图片识别食物

- **接口描述**：通过拍照识别餐盘中的食物，自动识别食物名称、分量、营养成分等。
- **Method / URL**

  `POST /api/calories/ocr/recognize`

- **请求体（FormData）**

| 字段      | 类型   | 必填 | 说明                                    |
|-----------|--------|------|-----------------------------------------|
| image     | file   | 是   | 图片文件（base64 或 multipart/form-data）|
| meal_type | string | 否   | 餐次类型：breakfast/lunch/dinner/snack   |

- **响应示例**

```json
{
  "code": 200,
  "message": "识别成功",
  "data": {
    "foods": [
      {
        "name": "米饭",
        "weight": 150,
        "calories": 195,
        "carbs": 45,
        "protein": 4,
        "fat": 0.5,
        "gi_level": "medium",
        "confidence": 0.92
      },
      {
        "name": "西红柿炒蛋",
        "weight": 120,
        "calories": 180,
        "carbs": 8,
        "protein": 12,
        "fat": 10,
        "gi_level": "low",
        "confidence": 0.88
      }
    ],
    "total_calories": 375,
    "total_carbs": 53,
    "total_protein": 16,
    "total_fat": 10.5,
    "risk_flag": false,
    "warnings": []
  }
}
```

- **前端适配说明**
  - 前端调用：`caloriesApi.recognizeFoodImage(data)`
  - 支持 base64 或文件上传
  - 识别结果中的 `foods` 数组，用户可手动选择/取消选择
  - 若识别到高GI食物，`warnings` 数组会包含提示信息

---

## 5. 条码扫描识别食物

- **接口描述**：通过扫描商品条码，从食物库中匹配食物信息。
- **Method / URL**

  `POST /api/calories/barcode/scan`

- **请求体（JSON）**

```json
{
  "barcode": "6901234567890"
}
```

- **响应示例**

```json
{
  "code": 200,
  "message": "识别成功",
  "data": {
    "name": "蒙牛纯牛奶 250ml",
    "calories": 150,
    "carbs": 12,
    "protein": 8,
    "fat": 5,
    "gi_level": "low",
    "weight": 250,
    "unit": "ml"
  }
}
```

- **前端适配说明**
  - 前端调用：`caloriesApi.scanBarcode(data)`
  - 若条码未找到，返回 `code: 404`

---

## 6. 搜索食物库

- **接口描述**：手动搜索食物库，支持模糊匹配。
- **Method / URL**

  `GET /api/calories/foods/search`

- **请求参数（query）**

| 字段    | 类型   | 必填 | 说明           |
|---------|--------|------|----------------|
| keyword | string | 是   | 搜索关键词     |
| limit   | int    | 否   | 返回数量，默认10|

- **响应示例**

```json
{
  "code": 200,
  "message": "ok",
  "data": [
    {
      "id": "f_1001",
      "name": "鸡腿饭",
      "calories_per_100g": 180,
      "carbs_per_100g": 25,
      "protein_per_100g": 12,
      "fat_per_100g": 5,
      "gi_level": "medium",
      "common_weight": 300
    },
    {
      "id": "f_1002",
      "name": "鸡腿",
      "calories_per_100g": 200,
      "carbs_per_100g": 0,
      "protein_per_100g": 20,
      "fat_per_100g": 12,
      "gi_level": "low",
      "common_weight": 150
    }
  ]
}
```

- **前端适配说明**
  - 前端调用：`caloriesApi.searchFoods(params)`
  - 返回结果按匹配度排序

---

## 7. 获取食谱详情

- **接口描述**：获取单个食谱的详细信息，包括食材清单、制作步骤、胰岛素注射建议等。
- **Method / URL**

  `GET /api/calories/recipes/{recipe_id}`

- **请求参数（query）**

| 字段     | 类型   | 必填 | 说明   |
|----------|--------|------|--------|
| user_id  | string | 否   | 用户ID |

- **响应示例**

```json
{
  "code": 200,
  "message": "ok",
  "data": {
    "id": "r_1001",
    "name": "低 GI 学校午餐盒",
    "meal_type": "lunch",
    "scene": "school",
    "total_calories": 520,
    "carbs_grams": 55,
    "protein_grams": 28,
    "fat_grams": 16,
    "description": "糙米饭 + 烤鸡胸肉 + 清蒸西兰花，适合血糖略高时的午餐选择。",
    "ingredients": [
      {
        "name": "糙米",
        "weight": 100,
        "unit": "g"
      },
      {
        "name": "鸡胸肉",
        "weight": 120,
        "unit": "g"
      },
      {
        "name": "西兰花",
        "weight": 150,
        "unit": "g"
      }
    ],
    "cooking_steps": [
      "1. 糙米提前浸泡2小时，煮熟",
      "2. 鸡胸肉用少量橄榄油烤制15分钟",
      "3. 西兰花清蒸5分钟即可"
    ],
    "insulin_tip": "建议餐前15分钟注射胰岛素，剂量约4-5单位",
    "glucose_tip": "适合餐前血糖偏高或需要控制碳水时使用，建议餐前监测血糖。",
    "gi_level": "low",
    "gl_level": "low",
    "is_favorite": false,
    "created_at": "2026-02-04T10:00:00Z"
  }
}
```

- **前端适配说明**
  - 前端调用：`caloriesApi.getRecipeDetail(id, params)`

---

## 8. 收藏/取消收藏食谱

- **接口描述**：用户收藏或取消收藏某个食谱。
- **Method / URL**

  `POST /api/calories/recipes/{recipe_id}/favorite`

- **请求体（JSON）**

```json
{
  "is_favorite": true
}
```

- **响应示例**

```json
{
  "code": 200,
  "message": "已收藏",
  "data": {
    "recipe_id": "r_1001",
    "is_favorite": true
  }
}
```

- **前端适配说明**
  - 前端调用：`caloriesApi.toggleRecipeFavorite(id, data)`

---

## 9. 发送食谱给家属

- **接口描述**：将食谱推荐发送给家属端，家属可确认加入本周家庭食谱。
- **Method / URL**

  `POST /api/calories/recipes/{recipe_id}/share`

- **请求体（JSON）**

```json
{
  "target_user_id": "u_family_123",  // 可选，不传则发送给所有关联家属
  "message": "这个食谱不错，加入本周菜单吧"  // 可选
}
```

- **响应示例**

```json
{
  "code": 200,
  "message": "已发送给家属",
  "data": {
    "recipe_id": "r_1001",
    "shared_to": ["u_family_123"],
    "notification_sent": true
  }
}
```

- **前端适配说明**
  - 前端调用：`caloriesApi.shareRecipeToFamily(id, data)`
  - 家属端会收到推送通知

---

## 10. 获取饮食-血糖关联分析数据

- **接口描述**：分析饮食记录与血糖波动的关联关系，提供归因分析。
- **Method / URL**

  `GET /api/calories/analysis/linkage`

- **请求参数（query）**

| 字段     | 类型   | 必填 | 说明                    |
|----------|--------|------|-------------------------|
| user_id  | string | 否   | 用户ID                  |
| date     | string | 否   | 日期，默认最近7天       |
| days     | int    | 否   | 分析天数，默认7         |

- **响应示例**

```json
{
  "code": 200,
  "message": "ok",
  "data": {
    "chart_data": {
      "dates": ["2026-02-01", "2026-02-02", "2026-02-03", "2026-02-04"],
      "carbs_intake": [180, 200, 165, 190],
      "glucose_values": [6.5, 7.2, 6.8, 8.1],
      "glucose_times": ["08:00", "12:00", "18:00", "20:00"]
    },
    "attributions": [
      {
        "id": "attr_001",
        "date": "2026-02-04",
        "time": "20:00",
        "glucose": 8.1,
        "reason": "晚餐摄入高油高脂食物（炸鸡排），导致延迟升糖",
        "related_foods": [
          {
            "name": "炸鸡排",
            "carbs": 25,
            "fat": 18,
            "meal_type": "dinner"
          }
        ],
        "suggestion": "建议减少高油高脂食物，选择清蒸或烤制方式"
      },
      {
        "id": "attr_002",
        "date": "2026-02-02",
        "time": "12:00",
        "glucose": 7.2,
        "reason": "午餐碳水摄入偏高（200g），餐后血糖上升较快",
        "related_foods": [
          {
            "name": "白米饭",
            "carbs": 120,
            "meal_type": "lunch"
          }
        ],
        "suggestion": "建议将部分白米饭替换为糙米或杂粮"
      }
    ],
    "summary": {
      "avg_carbs_per_meal": 183,
      "avg_glucose": 7.15,
      "correlation_coefficient": 0.68,
      "risk_level": "medium"
    }
  }
}
```

- **前端适配说明**
  - 前端调用：`caloriesApi.getLinkageAnalysis(params)`
  - `chart_data` 用于绘制双轴折线图（碳水摄入量 vs 血糖波动）
  - `attributions` 用于展示异常点归因分析

---

## 11. 完善现有接口字段

### 11.1 新增饮食记录接口增强

在 `POST /api/calories/records` 中，支持以下新增字段：

```json
{
  "source_type": "ocr",           // ocr / barcode / manual
  "food_items": [                 // 多食物项（OCR识别结果）
    {
      "name": "米饭",
      "weight": 150,
      "carbs": 45,
      "gi_level": "medium"
    }
  ],
  "portion": "一碗",              // 分量：半碗/大半碗/一碗
  "feeling": "seven",             // 进食感受：full/seven/half
  "tags": ["sugar_free", "low_gi"], // 特殊标签
  "risk_flag": false,             // 是否包含高风险食物
  "audit_status": 0               // 审核状态：0-无需审核/1-待家属确认/2-已确认
}
```

### 11.2 推荐食谱接口增强

在 `GET /api/calories/recipes/recommend` 响应中，增加以下字段：

```json
{
  "id": "r_1001",
  "name": "低 GI 学校午餐盒",
  "gi_level": "low",              // low / medium / high
  "gl_level": "low",              // 血糖负荷等级
  "ingredients": [...],           // 食材清单（简要）
  "insulin_tip": "建议餐前15分钟注射胰岛素，剂量约4-5单位",
  "is_favorite": false,           // 是否已收藏
  "suitable_for_roles": ["teen_above_12"]
}
```

---

## 12. 与血糖 / 胰岛素数据联动建议

- **记录饮食时**：后端可自动从最近一次血糖测量和用药记录中填充 `glucose_before`、`insulin_dose` 等字段。
- **返回 summary 时**：可增加 `risk_level`、`glucose_trend`、`daily_carbs_limit`（每日碳水上限）等字段，用于决定 `status_text` 与前端视觉（例如偏警示的文案或颜色）。
- **推荐食谱时**：根据最近一段时间的血糖曲线（如 `/glucose/curve/daily` 的统计结果），调节推荐食谱中的总碳水和 GI 水平。
- **OCR识别时**：若识别到高GI/高风险食物，自动触发风险预警机制。
- **关联分析**：结合血糖数据、胰岛素注射记录，分析饮食对血糖的影响，提供个性化建议。

这样前后端配合，"热量记录 + 食谱推荐"可以与现有血糖管理体系打通，实现数据联动分析。