## 后端接口文档设计：热量记录 & 食谱推荐

---

## 1. 获取某日热量统计 + 饮食记录

- **接口描述**：返回指定日期的饮食记录和统计汇总，用于顶部 summary 卡片和记录列表。
- **Method / URL**

  `GET /api/calories/daily`

- **请求参数（query）**

| 字段      | 类型   | 必填 | 说明                             |
|-----------|--------|------|----------------------------------|
| user_id   | string | 否   | 用户 ID，不传可从 token 中解析  |
| date      | string | 是   | 日期，格式 `YYYY-MM-DD`         |

- **响应示例（推荐结构）**

```json
{
  "code": 200,
  "message": "ok",
  "data": {
    "summary": {
      "total_calories": 1480,
      "target_min": 1400,
      "target_max": 1800,
      "carbs_grams": 180,
      "protein_grams": 60,
      "fat_grams": 50,
      "status_text": "今日热量略偏低，晚餐可以适当加一点主食"
    },
    "records": [
      {
        "id": 101,
        "user_id": "u_123",
        "date": "2026-02-04",
        "time": "07:30",
        "meal_type": "breakfast",        // breakfast / lunch / dinner / snack
        "food_name": "燕麦牛奶+鸡蛋",
        "calories": 380,
        "carbs_grams": 45,
        "protein_grams": 20,
        "fat_grams": 12,
        "scene": "home",                 // school / home / outing
        "glucose_before": 6.5,           // 可选：餐前血糖
        "glucose_after": 8.2,            // 可选：餐后血糖
        "insulin_dose": 3,               // 可选：本餐用胰岛素剂量
        "remark": "运动前早餐"
      }
    ]
  }
}
```



- **前端适配说明**

  - `caloriesStore.fetchDailyCalories` 支持两种返回形式：
    - 直接返回：`{ summary, records }`
    - 包一层：`{ code, data: { summary, records } }`
  - 字段名需与示例保持一致：`total_calories / target_min / target_max / carbs_grams / protein_grams / fat_grams / status_text` 等。

---

## 2. 新增一条饮食记录

- **接口描述**：记录一顿饭的基本信息（餐次、场景、估算热量等），用于统计与推荐。
- **Method / URL**

  `POST /api/calories/records`

- **请求体（JSON）**

```json
{
  "user_id": "u_123",          // 可选，后端也可以从 token 推导
  "date": "2026-02-04",
  "time": "12:10",             // 可选，不传可用服务器当前时间
  "meal_type": "lunch",        // breakfast / lunch / dinner / snack
  "food_name": "鸡腿饭",
  "calories": 650,
  "carbs_grams": 70,           // 可选
  "protein_grams": 30,         // 可选
  "fat_grams": 18,             // 可选
  "scene": "school",           // school / home / outing
  "glucose_before": 9.2,       // 可选：关联血糖
  "glucose_after": null,       // 可选：餐后测量后再补
  "insulin_dose": 4,           // 可选：本餐用药 / 胰岛素
  "remark": "食堂简餐"
}
```



- **响应示例**

```json
{
  "code": 200,
  "message": "created",
  "data": {
    "id": 205,
    "user_id": "u_123",
    "date": "2026-02-04",
    "time": "12:10",
    "meal_type": "lunch",
    "food_name": "鸡腿饭",
    "calories": 650,
    "carbs_grams": 70,
    "protein_grams": 30,
    "fat_grams": 18,
    "scene": "school",
    "glucose_before": 9.2,
    "glucose_after": null,
    "insulin_dose": 4,
    "remark": "食堂简餐"
  }
}
```



- **前端适配说明**

    - 前端调用：`caloriesApi.createRecord(data)`。

    - 若响应中 `data.id` 存在则直接使用；否则前端会本地补一个 `Date.now()` 的 `id`。

    - 不强制要求返回 `summary`，前端后续会再次请求 `/calories/daily`；如返回新的 `summary`，前端也可以做覆盖。


---

## 3. 获取推荐食谱列表

- **接口描述**：结合用户角色、血糖 / 胰岛素 / 打卡等数据，在不同场景下推荐合适食谱。
- **Method / URL**

  `GET /api/calories/recipes/recommend`

- **请求参数（query）**

| 字段            | 类型   | 必填 | 说明                                                                 |
|-----------------|--------|------|----------------------------------------------------------------------|
| user_id         | string | 否   | 用户 ID                                                              |
| date            | string | 否   | 日期，默认当天                                                       |
| scene           | string | 否   | 使用场景：`school` 在校 / `home` 居家 / `outing` 外出聚餐           |
| role            | string | 否   | 角色：`child_under_12` / `teen_above_12` / `guardian`               |
| glucose_level   | string | 否   | 当前血糖状态：`low` / `in_range` / `high`，可由仪表盘或血糖曲线计算 |
| last_insulin_at | string | 否   | 最近一次胰岛素注射时间（ISO 时间字符串）                            |

- **响应示例**

```json
{
  "code": 200,
  "message": "ok",
  "data": [
    {
      "id": "r_1001",
      "name": "低 GI 学校午餐盒",
      "meal_type": "lunch",
      "scene": "school",
      "total_calories": 520,
      "carbs_grams": 55,
      "protein_grams": 28,
      "fat_grams": 16,
      "description": "糙米饭 + 烤鸡胸肉 + 清蒸西兰花，适合血糖略高时的午餐选择。",
      "glucose_tip": "适合餐前血糖偏高或需要控制碳水时使用，建议餐前监测血糖。",
      "suggested_for_roles": ["teen_above_12", "guardian"]
    },
    {
      "id": "r_1002",
      "name": "家庭晚餐：番茄牛肉面（减糖版）",
      "meal_type": "dinner",
      "scene": "home",
      "total_calories": 610,
      "carbs_grams": 65,
      "protein_grams": 32,
      "fat_grams": 18,
      "description": "使用全麦面条和大量蔬菜，减少高 GI 食材。",
      "glucose_tip": "适合血糖在目标范围内的家庭晚餐，可根据医生建议调整主食量。",
      "suggested_for_roles": ["child_under_12", "teen_above_12", "guardian"]
    }
  ]
}
```

- **前端适配说明**

    - 前端调用：`caloriesApi.getRecipeRecommendations(params)`。

    - 前端兼容以下两种返回：
      - `data` 是数组；
      - 或 `data` 是对象：`{ items: [...] }`。

    - 关键字段：`id, name, meal_type, scene, total_calories, carbs_grams, description, glucose_tip`，有这些即可完整展示。


---

## 4. 与血糖 / 胰岛素数据联动建议

- **记录饮食时**：后端可自动从最近一次血糖测量和用药记录中填充 `glucose_before`、`insulin_dose` 等字段。
- **返回 summary 时**：可增加 `risk_level`、`glucose_trend` 等字段，用于决定 `status_text` 与前端视觉（例如偏警示的文案或颜色）。
- **推荐食谱时**：根据最近一段时间的血糖曲线（如 `/glucose/curve/daily` 的统计结果），调节推荐食谱中的总碳水和 GI 水平。

这样前后端配合，“热量记录 + 食谱推荐”可以与现有血糖管理体系打通。