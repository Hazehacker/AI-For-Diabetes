# 每日签到 + 积分兑换 后端接口需求

结合移动端实现（`/mobile/src/pages/profile/daily-checkin.vue`）与现有积分路由设计（`/backend/main/routes/points.py`），新增/扩展接口如下，便于对接移动端每日签到、积分商城兑换能力。

## 1. 认证
- Header: `Authorization: Bearer <token>`
- `user_id` 从 token 解析（与现有 `@token_required` 一致）。

## 2. 接口清单

### 2.1 获取签到+积分仪表盘
- **GET** `/api/points/checkin/dashboard`
- **Response**
```json
{
  "success": true,
  "code": 200,
  "data": {
    "points_balance": 0,          // 当前可用积分
    "today_signed": false,           // 今日是否已签到
    "today_points": 10,              // 今日签到奖励
    "total_days": 36,                // 累计签到天数
    "continuous_days": 5,            // 连续签到天数
    "vip_multiplier": 1.2,           // 会员积分倍率（非会员填 1）
    "monthly_checkins": [            // 当月日历
      { "date": "2026-02-01", "signed": true,  "points": 10 },
      { "date": "2026-02-02", "signed": false, "points": 0 }
    ]
  }
}
```

### 2.2 每日签到
- **POST** `/api/points/checkin`
- **Body**: 无
- **Response**
```json
{
  "success": true,
  "code": 200,
  "data": {
    "points_awarded": 10,
    "today_signed": true,
    "continuous_days": 6,
    "total_days": 37,
    "balance": 5690
  },
  "message": "签到成功"
}
```
- 规则：一天只能签到一次；若有连续签到加成，在这里计算并返回最终奖励。

### 2.3 积分余额
- **GET** `/api/points/balance`
- 复用已有实现，返回 `balance`。

### 2.4 积分记录（可直接复用已有路由）
- **GET** `/api/points/records?page=1&page_size=20&source=checkin`
- `source` 可选：`checkin | redeem | transfer_in | transfer_out | manual`。
- **Response**（示例补充字段）
```json
{
  "success": true,
  "code": 200,
  "data": {
    "total": 35,
    "page": 1,
    "page_size": 20,
    "balance": 5680,
    "records": [
      {
        "record_id": 123,
        "points": +10,
        "source": "checkin",
        "description": "每日签到",
        "created_at": "2026-02-05 09:12:00"
      }
    ]
  }
}
```

### 2.5 积分商城商品列表
- **GET** `/api/points/rewards`
- **Query（可选）**: `page`, `page_size`, `tag`（如 hot/vip/limited）。
- **Response**
```json
{
  "success": true,
  "code": 200,
  "data": {
    "total": 20,
    "rewards": [
      {
        "id": "vip-1m",
        "name": "食卡卡会员·1个月",
        "desc": "包含AI健康分析，价值167元",
        "points": 1180,
        "tag": "限时特惠",
        "cover": "https://.../vip.png",
        "stock": 999,           // 可选
        "limit_per_user": 1     // 可选，-1 表示不限
      }
    ]
  }
}
```

### 2.6 积分兑换
- **POST** `/api/points/redeem`
- **Body**
```json
{
  "reward_id": "vip-1m"
}
```
- **Response**
```json
{
  "success": true,
  "code": 200,
  "data": {
    "order_id": "redeem_20260205_001",
    "new_balance": 4500
  },
  "message": "兑换成功"
}
```
- 校验：库存、用户限购、积分余额。

## 3. 业务要点
1. **每日签到去重**：同日不可重复，返回已签到状态。
2. **连续签到/补签**：若需要补签/断签规则，可在 `dashboard` 增加字段 `allow_repair`, `repair_cost_points` 等。
3. **积分变更记录**：所有签到/兑换需写 `point_records`，字段 `source` 建议：`checkin`、`redeem`、`transfer_in`、`transfer_out`、`manual`。
4. **会员倍率**：若有会员等级，可在签到时乘以 `vip_multiplier`，并把最终增加的积分返回。
5. **商城图片**：前端已预置占位图，后端可下发 CDN 地址。

### 3.1 月历数据生成规则
`monthly_checkins` 字段必须返回**当月所有日期**（1号到月末），包括未签到的日期：
- 已签到日期：`signed: true, points: 实际积分`
- 未签到日期：`signed: false, points: 0`
- 未来日期：`signed: false, points: 0`

示例（2026年2月，假设今天是2月5日）：
```json
{
  "monthly_checkins": [
    { "date": "2026-02-01", "signed": true,  "points": 10 },
    { "date": "2026-02-02", "signed": false, "points": 0 },
    { "date": "2026-02-03", "signed": true,  "points": 10 },
    { "date": "2026-02-04", "signed": true,  "points": 10 },
    { "date": "2026-02-05", "signed": false, "points": 0 },
    // ... 一直到 2026-02-28
  ]
}
```

### 3.2 连续签到计算逻辑
**连续签到天数**的判断规则：
1. 从今天（或昨天，如果今天未签到）开始往前倒推
2. 每相邻两天的日期差必须为 1 天
3. 遇到断签（日期差 > 1）则停止计数
4. 如果最近签到日期距今超过 1 天，连续天数归零

**伪代码示例**：
```python
def calculate_continuous_days(user_id):
    # 获取用户所有签到记录，按日期倒序
    records = get_checkin_records(user_id, order_by='date DESC')
    
    if not records:
        return 0
    
    today = date.today()
    last_checkin = records[0].date
    
    # 如果最后签到不是今天或昨天，连续中断
    if (today - last_checkin).days > 1:
        return 0
    
    continuous = 1
    for i in range(1, len(records)):
        if (records[i-1].date - records[i].date).days == 1:
            continuous += 1
        else:
            break
    
    return continuous
```

### 3.3 兑换资格校验规则
执行 `POST /api/points/redeem` 时，按以下顺序校验：

1. **商品存在性校验**
   - 检查 `reward_id` 是否存在于 `point_rewards` 表
   - 检查商品 `is_active = 1`（未下架）
   - 失败返回：`40005 - 商品不存在或已下架`

2. **库存校验**
   - 如果 `stock != -1`（非无限库存），检查 `stock > 0`
   - 失败返回：`40003 - 商品库存不足`

3. **限购校验**
   - 如果 `limit_per_user != -1`（有限购），查询用户已兑换次数
   - 检查 `已兑换次数 < limit_per_user`
   - 失败返回：`40004 - 超过限购次数，每人限兑 {limit_per_user} 次`

4. **积分余额校验**
   - 查询用户当前积分余额
   - 检查 `balance >= reward.points`
   - 失败返回：`40002 - 积分余额不足，当前 {balance}，需要 {points}`

5. **执行兑换**（使用数据库事务）
   - 扣除积分：插入 `point_records`（`points = -reward.points, source = 'redeem'`）
   - 减少库存：`UPDATE point_rewards SET stock = stock - 1 WHERE id = ? AND stock > 0`
   - 记录兑换：插入 `redeem_records`
   - 生成订单号：`redeem_{YYYYMMDD}_{随机6位}`

## 4. 对接清单（后端待开发/确认）
- [ ] `GET /api/points/checkin/dashboard`
- [ ] `POST /api/points/checkin`
- [ ] `GET /api/points/rewards`
- [ ] `POST /api/points/redeem`
- [ ] 扩展 `GET /api/points/records`：返回 `balance`、`total`、分页。
- [ ] `GET /api/points/balance`：现有实现可直接复用。

## 5. 错误码定义


```json
{
  "success": false,
  "code": 错误码,
  "data": {},
  "message": "错误描述"
}
```

### 5.1 签到相关错误码

| 错误码 | 说明 | 触发场景 |
|--------|------|----------|
| 40001 | 今日已签到 | 用户在同一天重复调用签到接口 |
| 40006 | 签到失败，请稍后重试 | 数据库写入失败或其他系统错误 |

### 5.2 兑换相关错误码

| 错误码 | 说明 | 触发场景 |
|--------|------|----------|
| 40002 | 积分余额不足 | 用户积分 < 商品所需积分 |
| 40003 | 商品库存不足 | 商品 stock = 0（且非无限库存） |
| 40004 | 超过限购次数 | 用户已兑换次数 >= limit_per_user |
| 40005 | 商品不存在或已下架 | reward_id 不存在或 is_active = 0 |
| 40007 | 兑换失败，请稍后重试 | 事务执行失败或系统错误 |

### 5.3 通用错误码

| 错误码 | 说明 | 触发场景 |
|--------|------|----------|
| 401 | 未授权 | token 无效或过期 |
| 400 | 参数错误 | 缺少必填参数或参数格式错误 |
| 500 | 服务器内部错误 | 未预期的系统异常 |

### 5.4 错误响应示例

**今日已签到**：
```json
{
  "success": false,
  "code": 40001,
  "data": {
    "today_signed": true,
    "last_checkin_time": "2026-02-05 08:30:00"
  },
  "message": "今日已签到，明天再来吧"
}
```

**积分不足**：
```json
{
  "success": false,
  "code": 40002,
  "data": {
    "current_balance": 500,
    "required_points": 1180
  },
  "message": "积分余额不足，当前 500，需要 1180"
}
```

**超过限购**：
```json
{
  "success": false,
  "code": 40004,
  "data": {
    "redeemed_count": 1,
    "limit_per_user": 1
  },
  "message": "超过限购次数，每人限兑 1 次"
}
```

