# 个性化健康计划工坊 - 功能实现说明

## 📋 功能概述

**功能编号**：3.1  
**功能名称**：个性化健康计划工坊  
**优先级**：P0 - 核心功能

已完成基于 AI 的个性化健康计划生成系统，支持计划创建、任务执行、提醒管理和角色权限控制。

## 🎯 已实现功能

### 1. 核心组件

#### 状态管理 (`store/healthPlan.js`)
- **计划管理**
  - 计划的增删改查
  - 计划状态管理（待审核/进行中/已结束）
  - 计划生成向导流程控制
  
- **任务管理**
  - 今日任务列表
  - 任务完成状态追踪
  - 任务难度反馈记录
  
- **AI 生成逻辑**
  - 模拟 AI 计划生成
  - 基于目标的任务推荐
  - 冲突检测机制
  
- **角色权限**
  - 儿童模式：游戏化视图
  - 青少年模式：完整功能
  - 家属模式：审核和管理权限

#### 计划工坊主页 (`pages/health-plan/index.vue`)
- **儿童游戏化视图**（<12岁）
  - 等级徽章系统
  - 进度条可视化
  - 勋章收集展示
  - 简化的任务卡片
  - 表情反馈
  
- **正常视图**（≥12岁 & 家属）
  - 快速统计卡片
  - 今日任务时间轴
  - 我的计划列表
  - 待审核计划（仅家属）
  
- **任务执行**
  - 完成打卡
  - 撒花特效
  - 数据关联（如血糖值）
  - 难度反馈

#### 计划创建向导 (`pages/health-plan/create.vue`)
- **步骤1：数据原料选择**
  - 血糖趋势数据（近7天）
  - 医嘱/病历记录
  - 基础档案信息
  - 目标选择（血糖优化/用药管理等）
  
- **步骤2：AI 生成预览**
  - AI 思考动画
  - 计划草稿展示
  - 任务列表编辑
  - 提醒级别设置
  - 自定义任务添加
  
- **步骤3：微调与发布**
  - 计划总结
  - 冲突检测
  - 安全提示
  - 一键发布

### 2. 计划类型

支持四种计划类型：
1. **用药计划**：胰岛素注射提醒
2. **复查计划**：定期检查提醒
3. **饮食计划**：低GI饮食建议
4. **运动计划**：血糖优化运动

### 3. 提醒机制

三级提醒系统：
- **Level 1（普通）**：静默推送
- **Level 2（重要）**：标准通知音
- **Level 3（紧急）**：强制提醒，覆盖静音

### 4. 角色权限矩阵

| 功能 | 儿童(<12岁) | 青少年(≥12岁) | 家属 |
|------|------------|--------------|------|
| 查看计划 | ✅ 游戏化 | ✅ 完整 | ✅ 完整 |
| 创建计划 | ❌ | ✅ | ✅ |
| 任务打卡 | ✅ | ✅ | ✅ |
| 难度反馈 | ❌ | ✅ | ✅ |
| 审核计划 | ❌ | ❌ | ✅ |
| 终止计划 | ❌ | ❌ | ✅ |

## 🚀 使用方法

### 1. 访问健康计划工坊

```javascript
uni.navigateTo({
  url: '/pages/health-plan/index'
})
```

### 2. 创建新计划

**步骤流程：**
1. 点击"新建"或浮动按钮
2. 选择数据原料（血糖趋势、医嘱等）
3. 选择目标（血糖优化、用药管理等）
4. 等待 AI 生成计划草稿
5. 微调任务内容和提醒级别
6. 确认并发布

**代码示例：**
```javascript
import { useHealthPlanStore } from '@/store/healthPlan'
const healthPlanStore = useHealthPlanStore()

// 开始创建流程
healthPlanStore.startWizard()

// 生成 AI 计划
await healthPlanStore.generateAIDraft('血糖优化')

// 发布计划
await healthPlanStore.publishPlan()
```

### 3. 完成任务

**用户操作：**
- 点击"完成"按钮
- 如需输入数据（如血糖值），填写后确认
- 查看撒花特效和勋章奖励

**代码示例：**
```javascript
// 完成任务
healthPlanStore.completeTask(taskId, {
  glucose_value: 5.8 // 可选的关联数据
})

// 标记任务太难
healthPlanStore.feedbackTaskDifficulty(taskId, 2)
```

### 4. 审核计划（仅家属）

```javascript
// 批准计划
healthPlanStore.reviewPlan(planId, true)

// 拒绝计划
healthPlanStore.reviewPlan(planId, false)

// 终止计划
healthPlanStore.terminatePlan(planId)
```

## 📊 数据模型

### 计划数据结构

```javascript
{
  id: 1675234567890,
  plan_type: 4,                    // 1:用药 2:复查 3:饮食 4:运动
  target_goal: '午后血糖改善试验',
  task_items: [
    {
      id: 1,
      time: '15:00',
      content: '监测血糖',
      reminder_text: '该测血糖啦！',
      reminder_level: 2,           // 1:普通 2:重要 3:紧急
      difficulty: 1,               // 0:太易 1:适中 2:太难
      editable: true
    }
  ],
  duration_days: 7,
  review_status: 1,                // 0:待审核 1:进行中 2:已结束
  created_at: Date,
  start_date: Date,
  end_date: Date,
  created_by: 'teen_above_12'
}
```

### 任务数据结构

```javascript
{
  id: 'plan_task_id',
  plan_id: 1675234567890,
  task_id: 1,
  content: '监测血糖',
  scheduled_time: Date,
  reminder_text: '该测血糖啦！',
  reminder_level: 2,
  completed: false,
  completed_at: null,
  difficulty_feedback: null,
  related_data: {
    glucose_value: 5.8
  }
}
```

## 🎨 界面特性

### 儿童模式特色

1. **游戏化元素**
   - 等级系统（Lv.1, Lv.2...）
   - 进度条动画
   - 勋章收集
   - 表情反馈

2. **简化交互**
   - 大图标任务卡片
   - 一键完成
   - 隐藏复杂数据
   - 童趣化文案

3. **激励机制**
   - 完成3个任务：🌟 小试牛刀
   - 完成5个任务：⭐ 坚持不懈
   - 完成10个任务：🏆 健康达人

### 青少年/家属模式特色

1. **时间轴视图**
   - 按时间排序
   - 待完成任务高亮
   - 已完成任务置灰
   - 提醒级别标识

2. **统计面板**
   - 进行中计划数
   - 今日完成率
   - 待审核数量（家属）

3. **计划管理**
   - 计划卡片列表
   - 进度可视化
   - 快速操作入口

## 🤖 AI 生成逻辑

### 输入（Input）

1. **长期数据**
   - 近期 TIR（目标范围内时间）
   - 血糖变异系数
   - OCR 解析的医嘱
   - 用药档案

2. **即时数据**
   - 饮食记录
   - 运动频率
   - 异常事件标记

3. **用户意向**
   - 明确的干预目标
   - 期望改善的问题

### 处理（Process）

1. **AI 推理**
   - 角色模拟：内分泌管理教练
   - 任务匹配：从标准库选择
   - 动态调节：基于历史反馈

2. **安全过滤**
   - 剂量拦截：禁止具体用药建议
   - 边界保护：自动插入安全提示
   - 童化过滤：儿童模式文案转换

### 输出（Output）

1. **结构化计划**
   - JSON 格式任务列表
   - 时间窗口定义
   - 提醒触发器配置

2. **反馈闭环**
   - 执行轨迹记录
   - 效能评估报告
   - AI 学习优化

## 🔔 提醒策略

### 时间触发

基于任务预设时间点推送通知

### 地理围栏（预留）

```javascript
// 位置触发示例
if (task.content.includes('散步') && userLocation === 'home') {
  setTimeout(() => {
    sendReminder(task)
  }, 30 * 60 * 1000) // 回家后30分钟
}
```

### 分级提醒

```javascript
const reminderSettings = {
  level1: { sound: false, vibrate: false },        // 静默
  level2: { sound: true, vibrate: true },          // 标准
  level3: { sound: true, vibrate: true, override: true } // 强制
}
```

## 🛡️ 安全约束

### 内容红线

- ❌ 禁止：具体剂量建议（如"打4单位"）
- ✅ 允许：行为建议（如"记录数据并咨询医生"）

### 分级可见性

- 复杂医疗调整草稿：仅家属可见
- 最终任务提醒：双端共享

### 童化过滤

儿童模式文案转换示例：
- "摄入碳水" → "吃点好吃的补充能量"
- "监测血糖" → "测一测"
- "胰岛素注射" → "打针针"

### 紧急阻断

```javascript
// 低血糖时自动挂起运动任务
if (currentGlucose < 3.9) {
  suspendExerciseTasks()
}
```

## 📝 计划生成示例

### 场景 A：血糖优化

**触发条件：** 下午血糖持续偏高

**AI 推荐：**
```javascript
{
  title: '午后血糖改善试验',
  type: 'exercise',
  tasks: [
    { time: '15:00', content: '监测血糖' },
    { time: '15:30', content: '快走20分钟' },
    { time: '16:00', content: '补充水分' },
    { time: '17:00', content: '再次监测血糖' }
  ]
}
```

### 场景 B：用药管理

**触发条件：** OCR 解析到新处方

**AI 推荐：**
```javascript
{
  title: '每日用药核对计划',
  type: 'medication',
  tasks: [
    { time: '07:00', content: '早餐前胰岛素', level: 3 },
    { time: '12:00', content: '午餐前胰岛素', level: 3 },
    { time: '18:00', content: '晚餐前胰岛素', level: 3 },
    { time: '22:00', content: '睡前基础胰岛素', level: 3 }
  ]
}
```

### 场景 C：难度反馈调整

**用户反馈：** "快走"任务标记为"太难了"

**AI 调整：**
```javascript
// 原任务
{ content: '快走20分钟' }

// 调整后
{ content: '慢走15分钟' }
```

## 🔌 后端接口对接

当前使用模拟数据，实际项目中需要对接以下接口：

### 1. AI 计划生成

```javascript
POST /api/ai/generate-plan
Body: {
  selectedData: {
    glucoseTrend: true,
    medicalRecords: [...],
    baseProfile: true
  },
  userGoal: '血糖优化'
}
Response: {
  plan_type: 4,
  target_goal: '...',
  task_items: [...]
}
```

### 2. 计划发布

```javascript
POST /api/health-plans
Body: { ...planData }
Response: { id, status }
```

### 3. 任务完成

```javascript
PUT /api/health-plans/tasks/:taskId/complete
Body: { related_data: { glucose_value: 5.8 } }
```

### 4. 难度反馈

```javascript
POST /api/health-plans/tasks/:taskId/feedback
Body: { difficulty: 2 }
```

## 🐛 调试说明

### 查看当前状态

```javascript
import { useHealthPlanStore } from '@/store/healthPlan'
const store = useHealthPlanStore()

console.log('用户角色:', store.userRole)
console.log('计划列表:', store.plans)
console.log('今日任务:', store.todayTasks)
console.log('完成率:', store.todayCompletionRate)
```

### 生成测试数据

```javascript
// 生成模拟计划和任务
store.generateMockData()
```

### 测试不同角色

```javascript
// 切换到儿童模式
store.setUserRole('child_under_12')

// 切换到青少年模式
store.setUserRole('teen_above_12')

// 切换到家属模式
store.setUserRole('guardian')
```

## 📞 技术栈

- **框架**：Vue 3 + Composition API
- **状态管理**：Pinia
- **UI组件**：uni-app 原生组件
- **动画**：CSS3 Animations
- **AI集成**：预留接口（待对接）

## 🎯 待扩展功能

1. **真实 AI 对接**
   - 接入 GPT/Claude 等大模型
   - 基于真实数据生成计划
   
2. **地理围栏提醒**
   - GPS 位置触发
   - 智能延迟推送
   
3. **计划模板库**
   - 预设常用计划
   - 一键应用
   
4. **数据分析报告**
   - 计划效能评估
   - TIR 改善趋势
   - 依从性统计
   
5. **多患者管理**（家属）
   - 切换不同孩子
   - 批量计划管理

---

**版本**：v1.0.0  
**最后更新**：2026-02-04  
**状态**：✅ 核心功能已完成
