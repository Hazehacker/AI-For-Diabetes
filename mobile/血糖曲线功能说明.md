# 血糖曲线功能 - 实现说明

## 📋 功能概述

**功能编号**：监测-1.3  
**功能名称**：血糖曲线  
**优先级**：P0 - 核心功能

已完成血糖数据可视化功能，支持日/周/月三种时间维度的血糖趋势展示，帮助患者直观理解血糖变化规律。

## 🎯 已实现功能

### 1. 核心组件

#### 状态管理 (`store/glucoseCurve.js`)
- **数据管理**
  - 血糖记录的增删改查
  - 历史数据存储和过滤
  - 数据聚合（日/周/月）
  
- **统计计算**
  - 平均血糖值
  - 最高/最低血糖值
  - TIR（目标范围内时间占比）
  - 超出范围次数统计
  
- **角色权限**
  - 儿童模式：简化显示
  - 青少年模式：完整功能
  - 家属模式：查看和代录权限

#### 血糖曲线图表组件 (`components/GlucoseCurveChart.vue`)
- **多视图切换**
  - 日曲线：显示当天血糖变化
  - 周曲线：显示近7天趋势（数据聚合）
  - 月曲线：显示近30天趋势（数据聚合）
  
- **可视化元素**
  - 平滑曲线绘制
  - 参考范围背景高亮（3.9-6.1 mmol/L）
  - 数据点颜色编码（红色=低血糖，绿色=正常，橙色=高血糖）
  - 网格和坐标轴
  - 时间轴标签
  
- **交互功能**
  - 触摸查看数据点详情
  - 悬浮提示框显示时间和数值
  - 视图切换动画
  
- **统计信息栏**（非儿童模式）
  - 平均值
  - 最高值（橙色标识）
  - 最低值（红色标识）
  - TIR 百分比
  
- **儿童模式简化**
  - 隐藏具体数值
  - 显示情绪表情（😊/😐/😟）
  - 简化文字提示

#### 数据录入组件 (`components/AddGlucoseRecord.vue`)
- **表单字段**
  - 血糖值输入（数字键盘）
  - 测量时间选择
  - 备注信息（可选）
  
- **快捷标签**
  - 餐前/餐后
  - 运动前/运动后
  - 睡前/夜间
  
- **实时反馈**
  - 输入验证（范围检查）
  - 状态提示（低血糖/正常/高血糖）
  - 颜色编码警示
  
- **权限控制**
  - 仅≥12岁患者和家属可添加
  - 儿童模式不显示添加按钮

### 2. 集成到仪表盘

- 血糖曲线模块位于仪表盘下方
- 浮动添加按钮（右下角）
- 自动同步用户角色
- 模拟数据自动生成

## 🚀 使用方法

### 1. 查看血糖曲线

```javascript
// 曲线图会自动显示在仪表盘页面
// 访问路径：/pages/dashboard/dashboard
```

### 2. 切换视图

用户可以点击"日/周/月"标签切换不同时间范围的曲线：
- **日曲线**：显示当天每个时间点的血糖值
- **周曲线**：显示近7天的每日平均血糖
- **月曲线**：显示近30天的每日平均血糖

### 3. 添加血糖记录

```javascript
// 方式1：通过UI添加
// 点击右下角浮动按钮 → 填写表单 → 保存

// 方式2：代码添加
import { useGlucoseCurveStore } from '@/store/glucoseCurve'
const glucoseCurveStore = useGlucoseCurveStore()

glucoseCurveStore.addGlucoseRecord({
  glucose_value: 5.8,
  measure_time: new Date(),
  note: '餐后2小时',
  source: 'manual' // 或 'device'
})
```

### 4. 查看统计数据

```javascript
import { useGlucoseCurveStore } from '@/store/glucoseCurve'
const glucoseCurveStore = useGlucoseCurveStore()

console.log('统计数据:', glucoseCurveStore.statistics)
// {
//   avgGlucose: 5.8,
//   maxGlucose: 8.2,
//   minGlucose: 4.1,
//   outOfRangeCount: 3,
//   totalCount: 20,
//   timeInRange: 85.0
// }
```

### 5. 切换用户角色

```javascript
// 角色会自动从仪表盘同步
// 也可以手动设置
glucoseCurveStore.setUserRole('child_under_12') // 或 'teen_above_12', 'guardian'
```

## 📊 角色权限说明

### 儿童模式（<12岁）
**可见内容：**
- ✅ 简化的曲线图（无具体数值）
- ✅ 情绪表情反馈
- ✅ 简单文字提示
- ❌ 不显示统计数据
- ❌ 不能添加记录

**设计理念：**
降低数字焦虑，通过图形和表情让儿童理解趋势

### 青少年模式（≥12岁）
**可见内容：**
- ✅ 完整曲线图和数值
- ✅ 详细统计信息
- ✅ 参考范围说明
- ✅ 手动添加记录
- ✅ 触摸查看详情

**设计理念：**
培养自我管理能力，提供完整数据支持

### 家属模式
**可见内容：**
- ✅ 全部数据访问
- ✅ 代为记录权限
- ✅ 历史数据查看
- ❌ 不可修改历史记录（仅查看）

**设计理念：**
知情与支持，避免过度监控

## 🎨 数据可视化规则

### 颜色编码
- **绿色 (#10B981)**：正常范围（3.9-6.1 mmol/L）
- **红色 (#EF4444)**：低血糖（<3.9 mmol/L）
- **橙色 (#F59E0B)**：高血糖（>6.1 mmol/L）

### 参考范围
- **目标区间**：3.9-6.1 mmol/L（绿色背景高亮）
- **警戒线**：图表中以虚线或颜色区分显示

### 数据聚合
- **日曲线**：显示原始数据点
- **周/月曲线**：按日期分组，计算每日平均值

## 📱 交互说明

### 触摸交互
1. **触摸数据点**：显示悬浮提示框
2. **提示框内容**：
   - 测量时间
   - 血糖值
3. **松开手指**：提示框消失

### 视图切换
- 点击"日/周/月"标签
- 平滑过渡动画
- 自动重新计算统计数据

### 添加记录
1. 点击右下角浮动按钮
2. 填写血糖值（必填）
3. 选择测量时间（默认当前时间）
4. 添加备注（可选）
5. 点击快捷标签快速填充备注
6. 保存后自动刷新曲线

## 🔧 数据模型

### 血糖记录数据结构

```javascript
{
  id: 1675234567890,              // 唯一标识
  glucose_value: 5.8,             // 血糖值 (mmol/L)
  measure_time: Date,             // 测量时间
  period_type: 'day',             // 视图类型
  is_out_of_range: false,         // 是否超出范围
  source: 'manual',               // 来源：manual/device
  note: '餐后2小时'                // 备注
}
```

### 统计数据结构

```javascript
{
  avgGlucose: 5.8,               // 平均血糖
  maxGlucose: 8.2,               // 最高血糖
  minGlucose: 4.1,               // 最低血糖
  outOfRangeCount: 3,            // 超出范围次数
  totalCount: 20,                // 总记录数
  timeInRange: 85.0              // TIR百分比
}
```

## 🔌 后端接口对接

当前使用模拟数据，实际项目中需要对接以下接口：

### 1. 获取血糖记录

```javascript
// GET /api/glucose/records
// Query: start_date, end_date, user_id

async loadGlucoseData(startDate, endDate) {
  const response = await fetch(
    `/api/glucose/records?start=${startDate}&end=${endDate}`
  )
  const data = await response.json()
  this.glucoseRecords = data.records
}
```

### 2. 添加血糖记录

```javascript
// POST /api/glucose/records
// Body: { glucose_value, measure_time, note, source }

async addGlucoseRecord(record) {
  const response = await fetch('/api/glucose/records', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(record)
  })
  return await response.json()
}
```

### 3. 删除血糖记录

```javascript
// DELETE /api/glucose/records/:id

async deleteGlucoseRecord(recordId) {
  await fetch(`/api/glucose/records/${recordId}`, {
    method: 'DELETE'
  })
}
```

## 🐛 调试说明

### 查看当前数据

```javascript
import { useGlucoseCurveStore } from '@/store/glucoseCurve'
const store = useGlucoseCurveStore()

console.log('当前视图:', store.viewType)
console.log('血糖记录:', store.glucoseRecords)
console.log('统计数据:', store.statistics)
console.log('当前视图数据:', store.currentViewData)
```

### 生成测试数据

```javascript
// 生成7天的模拟数据
store.generateMockData(7)

// 生成30天的模拟数据
store.generateMockData(30)
```

### 测试不同场景

```javascript
// 测试低血糖
store.addGlucoseRecord({
  glucose_value: 3.5,
  measure_time: new Date(),
  note: '低血糖测试'
})

// 测试高血糖
store.addGlucoseRecord({
  glucose_value: 9.5,
  measure_time: new Date(),
  note: '高血糖测试'
})

// 测试正常值
store.addGlucoseRecord({
  glucose_value: 5.5,
  measure_time: new Date(),
  note: '正常测试'
})
```

## 📝 待扩展功能

以下功能已预留接口，可根据需求实现：

1. **设备数据同步**
   - CGM 设备自动上传
   - 蓝牙血糖仪连接
   
2. **数据导出**
   - PDF 报告生成
   - Excel 表格导出
   - 图片分享
   
3. **高级统计**
  - 血糖波动性（CV）
  - 估算糖化血红蛋白（GMI）
  - 时段分析（餐前/餐后）
   
4. **智能提醒**
   - 定时测量提醒
   - 异常值警报
   - 趋势预警
   
5. **数据对比**
   - 不同时期对比
   - 目标达成率
   - 改善趋势分析

## 🔒 隐私与安全

- ✅ 数据仅对患者本人及授权家属可见
- ✅ 不向第三方开放原始数据
- ✅ 异常提示仅作管理提醒，不提供医疗建议
- ✅ 本地存储加密（待实现）
- ✅ 传输加密（HTTPS）

## 📞 技术栈

- **框架**：Vue 3 + Composition API
- **状态管理**：Pinia
- **图表绘制**：Canvas 原生 API
- **UI组件**：uni-app 原生组件
- **数据验证**：前端表单验证

---

**版本**：v1.0.0  
**最后更新**：2026-02-04  
**状态**：✅ 已完成核心功能
